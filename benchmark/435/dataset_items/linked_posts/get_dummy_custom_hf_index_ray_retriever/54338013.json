{
    "items": [
        {
            "tags": [
                "python",
                "parallel-processing",
                "distributed-system",
                "ray"
            ],
            "comments": [
                {
                    "owner": {
                        "account_id": 7956814,
                        "reputation": 560,
                        "user_id": 6005805,
                        "user_type": "registered",
                        "display_name": "spaniard"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1548292980,
                    "post_id": 54338013,
                    "comment_id": 95493061,
                    "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder#comment95493061_54338013",
                    "body": "I consider this <code>os.path.dirname(os.path.dirname(__file__))</code> better than this <code>os.path.join(os.path.dirname(__file__), &#39;..&#39;)</code>"
                },
                {
                    "owner": {
                        "account_id": 9903728,
                        "reputation": 2229,
                        "user_id": 7850499,
                        "user_type": "registered",
                        "accept_rate": 73,
                        "display_name": "Maybe"
                    },
                    "reply_to_user": {
                        "account_id": 7956814,
                        "reputation": 560,
                        "user_id": 6005805,
                        "user_type": "registered",
                        "display_name": "spaniard"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1548296668,
                    "post_id": 54338013,
                    "comment_id": 95493788,
                    "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder#comment95493788_54338013",
                    "body": "@spaniard Thanks:-) I guess you suggested <code>sys.path.append(os.path.dirname(os.path.dirname(os.path.absp&zwnj;&#8203;ath(__file__))))</code>. But this does not work either..."
                },
                {
                    "owner": {
                        "account_id": 7956814,
                        "reputation": 560,
                        "user_id": 6005805,
                        "user_type": "registered",
                        "display_name": "spaniard"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1548296908,
                    "post_id": 54338013,
                    "comment_id": 95493838,
                    "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder#comment95493838_54338013",
                    "body": "Have you tried to remove the line <code>if __name__ == &#39;__main__&#39; and __package__ is None:</code>? and simply always add to your path the parent directory?"
                },
                {
                    "owner": {
                        "account_id": 9903728,
                        "reputation": 2229,
                        "user_id": 7850499,
                        "user_type": "registered",
                        "accept_rate": 73,
                        "display_name": "Maybe"
                    },
                    "reply_to_user": {
                        "account_id": 7956814,
                        "reputation": 560,
                        "user_id": 6005805,
                        "user_type": "registered",
                        "display_name": "spaniard"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1548297303,
                    "post_id": 54338013,
                    "comment_id": 95493921,
                    "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder#comment95493921_54338013",
                    "body": "@spaniard Yes, the same story goes on"
                },
                {
                    "owner": {
                        "account_id": 9903728,
                        "reputation": 2229,
                        "user_id": 7850499,
                        "user_type": "registered",
                        "accept_rate": 73,
                        "display_name": "Maybe"
                    },
                    "reply_to_user": {
                        "account_id": 12441344,
                        "reputation": 21066,
                        "user_id": 9059420,
                        "user_type": "registered",
                        "accept_rate": 100,
                        "display_name": "Darkonaut"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1548297447,
                    "post_id": 54338013,
                    "comment_id": 95493952,
                    "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder#comment95493952_54338013",
                    "body": "@Darkonaut I did what you suggested, still not working. I remembered that python3 has no longer require <code>__init__.py</code>, doesn&#39;t it?"
                },
                {
                    "owner": {
                        "account_id": 12441344,
                        "reputation": 21066,
                        "user_id": 9059420,
                        "user_type": "registered",
                        "accept_rate": 100,
                        "display_name": "Darkonaut"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1548297839,
                    "post_id": 54338013,
                    "comment_id": 95494043,
                    "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder#comment95494043_54338013",
                    "body": "Yes since Python 3.3 it shouldn&#39;t be needed anymore, but my guess was that ray might need it somehow since it&#39;s a framework."
                },
                {
                    "owner": {
                        "account_id": 9903728,
                        "reputation": 2229,
                        "user_id": 7850499,
                        "user_type": "registered",
                        "accept_rate": 73,
                        "display_name": "Maybe"
                    },
                    "reply_to_user": {
                        "account_id": 12441344,
                        "reputation": 21066,
                        "user_id": 9059420,
                        "user_type": "registered",
                        "accept_rate": 100,
                        "display_name": "Darkonaut"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1548298001,
                    "post_id": 54338013,
                    "comment_id": 95494077,
                    "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder#comment95494077_54338013",
                    "body": "@Darkonaut Thanks. I&#39;ve added <code>__init__.py</code> to all directory, even the root directory which contains these three folders. It still does not work."
                },
                {
                    "owner": {
                        "account_id": 12441344,
                        "reputation": 21066,
                        "user_id": 9059420,
                        "user_type": "registered",
                        "accept_rate": 100,
                        "display_name": "Darkonaut"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1548298172,
                    "post_id": 54338013,
                    "comment_id": 95494117,
                    "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder#comment95494117_54338013",
                    "body": "Could be a naming conflict. You have <code>utils.py</code> and <code>worker.py</code> and I see ray has these files too. Rename your files with a prefix to avoid the clash."
                },
                {
                    "owner": {
                        "account_id": 9903728,
                        "reputation": 2229,
                        "user_id": 7850499,
                        "user_type": "registered",
                        "accept_rate": 73,
                        "display_name": "Maybe"
                    },
                    "reply_to_user": {
                        "account_id": 12441344,
                        "reputation": 21066,
                        "user_id": 9059420,
                        "user_type": "registered",
                        "accept_rate": 100,
                        "display_name": "Darkonaut"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1548298734,
                    "post_id": 54338013,
                    "comment_id": 95494239,
                    "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder#comment95494239_54338013",
                    "body": "@Darkonaut I did what you suggested, and prefix all relative file/class with <code>my</code>,,, still not working..."
                },
                {
                    "owner": {
                        "account_id": 9903728,
                        "reputation": 2229,
                        "user_id": 7850499,
                        "user_type": "registered",
                        "accept_rate": 73,
                        "display_name": "Maybe"
                    },
                    "reply_to_user": {
                        "account_id": 12441344,
                        "reputation": 21066,
                        "user_id": 9059420,
                        "user_type": "registered",
                        "accept_rate": 100,
                        "display_name": "Darkonaut"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1548300148,
                    "post_id": 54338013,
                    "comment_id": 95494525,
                    "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder#comment95494525_54338013",
                    "body": "@Darkonaut Yep, I&#39;ve changed all relative names... The error happens at the <code>print</code> statement. IMHO, if the error is caused by name conflict, it should not happen so late."
                },
                {
                    "owner": {
                        "account_id": 12441344,
                        "reputation": 21066,
                        "user_id": 9059420,
                        "user_type": "registered",
                        "accept_rate": 100,
                        "display_name": "Darkonaut"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1548300479,
                    "post_id": 54338013,
                    "comment_id": 95494580,
                    "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder#comment95494580_54338013",
                    "body": "I cannot speak for ray but at least in standard libs <code>multiprocessing.Pool</code> it&#39;s necessary that imports for used functions are made for every distributed task <i>again</i>. I&#39;m not familiar with ray&#39;s internals but that line <code>ImportError: No module named &#39;utils&#39;</code>  makes me wonder. It looks like it&#39;s trying to import utils from <code>utils.py</code> instead of from the directory."
                },
                {
                    "owner": {
                        "account_id": 9903728,
                        "reputation": 2229,
                        "user_id": 7850499,
                        "user_type": "registered",
                        "accept_rate": 73,
                        "display_name": "Maybe"
                    },
                    "reply_to_user": {
                        "account_id": 12441344,
                        "reputation": 21066,
                        "user_id": 9059420,
                        "user_type": "registered",
                        "accept_rate": 100,
                        "display_name": "Darkonaut"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1548306548,
                    "post_id": 54338013,
                    "comment_id": 95495788,
                    "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder#comment95495788_54338013",
                    "body": "@Darkonaut I&#39;ve updated the code, file names, and the error messages. It can be seen now that the <code>ImportError</code> refers to the folder name <code>my_utility</code> instead of the <code>my_utils.py</code> file. To my best knowledge, I think ray calls <code>from my_utility import my_utils</code> in every new actor process, and that causes this problem."
                }
            ],
            "answers": [
                {
                    "owner": {
                        "account_id": 10674500,
                        "reputation": 3306,
                        "user_id": 7858504,
                        "user_type": "registered",
                        "display_name": "Robert Nishihara"
                    },
                    "comment_count": 0,
                    "is_accepted": true,
                    "score": 10,
                    "last_activity_date": 1548309276,
                    "creation_date": 1548309276,
                    "answer_id": 54340167,
                    "question_id": 54338013,
                    "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder/54340167#54340167",
                    "body": "<p>You are correct about what the issue is.</p>\n\n<p>In your example, you modify <code>sys.path</code> in <code>main.py</code> in order to be able to import <code>my_agent.my_worker</code> and <code>my_utility.my_utils</code>.</p>\n\n<p>However, this path change is not propagated to the worker processes, so if you were to run a remote function like</p>\n\n<pre><code>@ray.remote\ndef f():\n    # Print the PYTHONPATH on the worker process.\n    import sys\n    print(sys.path)\n\nf.remote()\n</code></pre>\n\n<p>You would see that <code>sys.path</code> on the worker does not include the parent directory that you added.</p>\n\n<p>The reason that modifying <code>sys.path</code> on the worker (e.g., in the <code>MyWorker</code> constructor) doesn't work is that the <code>MyWorker</code> class definition is pickled and shipped to the workers. Then the worker unpickles it, and the process of unpickling the class definition requires <code>my_utils</code> to be imported, and this fails because the actor constructor hasn't had a chance to run yet.</p>\n\n<p>There are a couple possible solutions here.</p>\n\n<ol>\n<li><p>Run the script with something like</p>\n\n<pre><code>PYTHONPATH=$(dirname $(pwd)):$PYTHONPATH python main.py\n</code></pre>\n\n<p>(from within <code>working_dir/</code>). That should solve the issue because in this case the worker processes are forked from the scheduler process (which is forked from the main Python interpreter when you call <code>ray.init()</code> and so the environment variable will be inherited by the workers (this doesn't happen for <code>sys.path</code> presumably because it is not an environment variable).</p></li>\n<li><p>It looks like adding the line</p>\n\n<pre><code>parent_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))\nos.environ[\"PYTHONPATH\"] = parent_dir + \":\" + os.environ.get(\"PYTHONPATH\", \"\")\n</code></pre>\n\n<p>in <code>main.py</code> (before the <code>ray.init()</code> call) also works for the same reason as above.</p></li>\n<li><p>Consider adding a <code>setup.py</code> and installing your project as a Python package so that it's automatically on the relevant path.</p></li>\n</ol>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 204365,
                                "reputation": 51,
                                "user_id": 452530,
                                "user_type": "registered",
                                "display_name": "han14466"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1645446562,
                            "post_id": 70717760,
                            "comment_id": 125865970,
                            "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder/70717760#comment125865970_70717760",
                            "body": "if you have multi dependencies, use &quot;py_modules&quot;: [&quot;path/project_name/module&quot;]"
                        }
                    ],
                    "owner": {
                        "account_id": 19989848,
                        "reputation": 185,
                        "user_id": 14651138,
                        "user_type": "registered",
                        "display_name": "Archit Kulkarni"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 3,
                    "last_activity_date": 1642204524,
                    "creation_date": 1642204524,
                    "answer_id": 70717760,
                    "question_id": 54338013,
                    "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder/70717760#70717760",
                    "body": "<p>The new &quot;Runtime Environments&quot; feature, which didn't exist at the time of this post, should help with this issue: <a href=\"https://docs.ray.io/en/latest/handling-dependencies.html#runtime-environments\" rel=\"nofollow noreferrer\">https://docs.ray.io/en/latest/handling-dependencies.html#runtime-environments</a>. (See the <code>working_dir</code> and <code>py_modules</code> entries.)</p>\n"
                }
            ],
            "owner": {
                "account_id": 9903728,
                "reputation": 2229,
                "user_id": 7850499,
                "user_type": "registered",
                "accept_rate": 73,
                "display_name": "Maybe"
            },
            "comment_count": 12,
            "is_answered": true,
            "accepted_answer_id": 54340167,
            "answer_count": 2,
            "score": 6,
            "last_activity_date": 1642204524,
            "creation_date": 1548292306,
            "last_edit_date": 1548305921,
            "question_id": 54338013,
            "link": "https://stackoverflow.com/questions/54338013/parallel-import-a-python-file-from-sibling-folder",
            "title": "Parallel: Import a python file from sibling folder",
            "body": "<p>I have a directory tree</p>\n\n<pre><code>working_dir\\\n    main.py\nmy_agent\\\n    my_worker.py\nmy_utility\\\n    my_utils.py\n</code></pre>\n\n<p>Code in each file is as follows</p>\n\n<pre><code>\"\"\" main.py \"\"\"\n\nimport os, sys\nsys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))\n\nfrom my_agent.my_worker import MyWorker\nimport ray\n\nray.init()\nworkers = [MyWorker.remote(i) for i in range(10)]\nids = [worker.get_id.remote() for worker in workers]\n# print(*ids, sep='\\n')\nprint(*ray.get(ids), sep='\\n')\n</code></pre>\n\n<pre><code>\"\"\" worker.py \"\"\"\nfrom my_utility import my_utils\nimport ray\n\n@ray.remote\nclass MyWorker():\n    def __init__(self, id):\n        self.id = id\n\n    def get_id(self):\n        return my_utils.f(self.id)\n</code></pre>\n\n<pre><code>\"\"\" my_utils.py \"\"\"\ndef f(id):\n    return '{}: Everything is fine...'.format(id)\n</code></pre>\n\n<p>Here's a part of the error message I received</p>\n\n<blockquote>\n  <p>Traceback (most recent call last):</p>\n  \n  <p>File \"/Users/aptx4869/anaconda3/envs/p35/lib/python3.5/site-packages/ray/function_manager.py\", line 616, in fetch_and_register_actor\n      unpickled_class = pickle.loads(pickled_class)</p>\n  \n  <p>File \"/Users/aptx4869/anaconda3/envs/p35/lib/python3.5/site-packages/ray/cloudpickle/cloudpickle.py\", line 894, in subimport\n      <strong>import</strong>(name)</p>\n  \n  <p>ImportError: No module named 'my_utility'</p>\n  \n  <p>Traceback (most recent call last):</p>\n  \n  <p>File \"main.py\", line 12, in \n      print(*ray.get(ids), sep='\\n')</p>\n  \n  <p>File \"/Users/aptx4869/anaconda3/envs/p35/lib/python3.5/site-packages/ray/worker.py\", line 2377, in get\n      raise value\n  ray.worker.RayTaskError: ray_worker (pid=30025, host=AiMacbook)</p>\n  \n  <p>Exception: The actor with name MyWorker failed to be imported, and so cannot execute this method</p>\n</blockquote>\n\n<p><strong>If I remove all statements related to <code>ray</code>, the above code works fine.</strong> Therefore, I boldly guess the reason is that <code>ray</code> runs each actor in a new process and <code>sys.path.append</code> only works in the main process. So I add the following code to <code>worker.py</code></p>\n\n<pre><code>import os, sys\nsys.path.append(os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))\n</code></pre>\n\n<p>But it still does not work: the same error message shows up. Now I run out of ideas, what should I do?</p>\n"
        }
    ],
    "has_more": false,
    "quota_max": 10000,
    "quota_remaining": 9290
}
{
    "items": [
        {
            "tags": [
                "python",
                "image",
                "opencv",
                "image-processing",
                "computer-vision"
            ],
            "comments": [
                {
                    "owner": {
                        "user_type": "does_not_exist",
                        "display_name": "user1196549"
                    },
                    "edited": false,
                    "score": 2,
                    "creation_date": 1563133296,
                    "post_id": 57030125,
                    "comment_id": 100590091,
                    "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv#comment100590091_57030125",
                    "body": "Re-read the documentation of convertScaleAbs. You should keep beta=0."
                },
                {
                    "owner": {
                        "account_id": 12741167,
                        "reputation": 4108,
                        "user_id": 9251158,
                        "user_type": "registered",
                        "display_name": "emonigma"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1563180341,
                    "post_id": 57030125,
                    "comment_id": 100600571,
                    "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv#comment100600571_57030125",
                    "body": "At <code>beta = 0</code>, the image becomes darker, so I tried with <code>alpha = minimum_brightness &#47; brightness</code>, which gives a nice result and the target brightness except for the saturation arithmetics. Do you want to write an answer and I will edit it to add the result?"
                },
                {
                    "owner": {
                        "account_id": 12741167,
                        "reputation": 4108,
                        "user_id": 9251158,
                        "user_type": "registered",
                        "display_name": "emonigma"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1563180777,
                    "post_id": 57030125,
                    "comment_id": 100600748,
                    "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv#comment100600748_57030125",
                    "body": "I added details in the question; feel free to move those to your answer."
                },
                {
                    "owner": {
                        "account_id": 13125518,
                        "reputation": 1093,
                        "user_id": 9481613,
                        "user_type": "registered",
                        "display_name": "mLstudent33"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1571354680,
                    "post_id": 57030125,
                    "comment_id": 103223253,
                    "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv#comment103223253_57030125",
                    "body": "@YvesDaoust Does this work for color images?"
                },
                {
                    "owner": {
                        "user_type": "does_not_exist",
                        "display_name": "user1196549"
                    },
                    "reply_to_user": {
                        "account_id": 13125518,
                        "reputation": 1093,
                        "user_id": 9481613,
                        "user_type": "registered",
                        "display_name": "mLstudent33"
                    },
                    "edited": false,
                    "score": 1,
                    "creation_date": 1571389724,
                    "post_id": 57030125,
                    "comment_id": 103233170,
                    "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv#comment103233170_57030125",
                    "body": "@mLstudent33: yes it does."
                },
                {
                    "owner": {
                        "account_id": 13125518,
                        "reputation": 1093,
                        "user_id": 9481613,
                        "user_type": "registered",
                        "display_name": "mLstudent33"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1571414976,
                    "post_id": 57030125,
                    "comment_id": 103246469,
                    "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv#comment103246469_57030125",
                    "body": "alpha = minimum_brightness / brightness or brightness/minimum brightness???  They seem reversed in the code."
                },
                {
                    "owner": {
                        "account_id": 12741167,
                        "reputation": 4108,
                        "user_id": 9251158,
                        "user_type": "registered",
                        "display_name": "emonigma"
                    },
                    "reply_to_user": {
                        "account_id": 13125518,
                        "reputation": 1093,
                        "user_id": 9481613,
                        "user_type": "registered",
                        "display_name": "mLstudent33"
                    },
                    "edited": false,
                    "score": 1,
                    "creation_date": 1571864547,
                    "post_id": 57030125,
                    "comment_id": 103385703,
                    "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv#comment103385703_57030125",
                    "body": "@mLstudent33 I confirm that the code <code>alpha = minimum_brightness &#47; brightness</code> works as I expected. The transformation is <code>y = alpha * x + beta</code>, and <code>x</code> is on average at <code>brightness</code>, so <code>alpha</code> as above and <code>beta = 0</code> will give <code>y</code> on average at <code>minimum_brightness</code>."
                }
            ],
            "answers": [
                {
                    "owner": {
                        "account_id": 7102004,
                        "reputation": 154,
                        "user_id": 5433154,
                        "user_type": "registered",
                        "display_name": "Kanat"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": -2,
                    "last_activity_date": 1563166161,
                    "creation_date": 1563166161,
                    "answer_id": 57033395,
                    "question_id": 57030125,
                    "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv/57033395#57033395",
                    "body": "<p>What if you try like this:</p>\n\n<pre><code>bright_img = cv2.convertScaleAbs(img, alpha = 1, beta = 255 * (minimum_brightness - brightness))\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 12741167,
                                "reputation": 4108,
                                "user_id": 9251158,
                                "user_type": "registered",
                                "display_name": "emonigma"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1563258123,
                            "post_id": 57046925,
                            "comment_id": 100628818,
                            "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv/57046925#comment100628818_57046925",
                            "body": "This is an informative answer. Is there an easy formula to calculate the percentile for clipping from the target brightness that is not trial and error?"
                        },
                        {
                            "owner": {
                                "account_id": 15472581,
                                "reputation": 45230,
                                "user_id": 11162165,
                                "user_type": "registered",
                                "display_name": "nathancy"
                            },
                            "reply_to_user": {
                                "account_id": 12741167,
                                "reputation": 4108,
                                "user_id": 9251158,
                                "user_type": "registered",
                                "display_name": "emonigma"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1563313498,
                            "post_id": 57046925,
                            "comment_id": 100656712,
                            "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv/57046925#comment100656712_57046925",
                            "body": "This is a rough estimate. <code>Clipping percentile = target brightness &#47; 2</code>. So if you want a 50% brightness, you can set the percentile to 25. You may have to do additional testing to get a exact formula"
                        },
                        {
                            "owner": {
                                "account_id": 12741167,
                                "reputation": 4108,
                                "user_id": 9251158,
                                "user_type": "registered",
                                "display_name": "emonigma"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1563361683,
                            "post_id": 57046925,
                            "comment_id": 100672223,
                            "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv/57046925#comment100672223_57046925",
                            "body": "I just tested this with trial and error, increasing the percentile by 0.1 to get the right brightness, and it works. It&#39;s also much faster than I expected."
                        },
                        {
                            "owner": {
                                "account_id": 15472581,
                                "reputation": 45230,
                                "user_id": 11162165,
                                "user_type": "registered",
                                "display_name": "nathancy"
                            },
                            "reply_to_user": {
                                "account_id": 12741167,
                                "reputation": 4108,
                                "user_id": 9251158,
                                "user_type": "registered",
                                "display_name": "emonigma"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1563392736,
                            "post_id": 57046925,
                            "comment_id": 100689193,
                            "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv/57046925#comment100689193_57046925",
                            "body": "What do you mean by increasing it by 0.1? So for instance, 1 to 1.1? Approximately how much did that increase the target brightness percentage by? Feel free to edit that into the solution, I&#39;m interested in knowing if there was a nice formula!"
                        },
                        {
                            "owner": {
                                "account_id": 12741167,
                                "reputation": 4108,
                                "user_id": 9251158,
                                "user_type": "registered",
                                "display_name": "emonigma"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1563436342,
                            "post_id": 57046925,
                            "comment_id": 100701265,
                            "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv/57046925#comment100701265_57046925",
                            "body": "I did <code>clip_hist_percent = 0.1</code>, run a version of your code, and then increase <code>clip_hist_percent += 0.1</code> until I got the target brightness. I don&#39;t think that such a formula would exist for any histogram to deliver a target brightness, though, but this code is fast enough that I don&#39;t need it either."
                        },
                        {
                            "owner": {
                                "account_id": 15472581,
                                "reputation": 45230,
                                "user_id": 11162165,
                                "user_type": "registered",
                                "display_name": "nathancy"
                            },
                            "reply_to_user": {
                                "account_id": 12741167,
                                "reputation": 4108,
                                "user_id": 9251158,
                                "user_type": "registered",
                                "display_name": "emonigma"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1563478775,
                            "post_id": 57046925,
                            "comment_id": 100724146,
                            "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv/57046925#comment100724146_57046925",
                            "body": "Interesting so guess and check was the solution then?"
                        },
                        {
                            "owner": {
                                "account_id": 12741167,
                                "reputation": 4108,
                                "user_id": 9251158,
                                "user_type": "registered",
                                "display_name": "emonigma"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1563542299,
                            "post_id": 57046925,
                            "comment_id": 100745409,
                            "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv/57046925#comment100745409_57046925",
                            "body": "I think so, not only with the histogram but also with the clipping and saturation arithmetics. And it&#39;s so fast that I don&#39;t see the point in calculating a convoluted formula that is a hotbed for hidden bugs."
                        },
                        {
                            "owner": {
                                "account_id": 15472581,
                                "reputation": 45230,
                                "user_id": 11162165,
                                "user_type": "registered",
                                "display_name": "nathancy"
                            },
                            "reply_to_user": {
                                "account_id": 12741167,
                                "reputation": 4108,
                                "user_id": 9251158,
                                "user_type": "registered",
                                "display_name": "emonigma"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1579553435,
                            "post_id": 57046925,
                            "comment_id": 105797779,
                            "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv/57046925#comment105797779_57046925",
                            "body": "@miguelmorin, I&#39;ve manually added the update. It seems it was auto rejected by the community."
                        }
                    ],
                    "owner": {
                        "account_id": 15472581,
                        "reputation": 45230,
                        "user_id": 11162165,
                        "user_type": "registered",
                        "display_name": "nathancy"
                    },
                    "comment_count": 8,
                    "is_accepted": true,
                    "score": 17,
                    "last_activity_date": 1579552484,
                    "last_edit_date": 1579552484,
                    "creation_date": 1563223292,
                    "answer_id": 57046925,
                    "question_id": 57030125,
                    "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv/57046925#57046925",
                    "body": "<p>You can try automatically adjusting the brightness using contrast optimization with histogram clipping. You can increase the target brightness by increasing the histogram clip percent (<code>clip_hist_percent</code>). Here's the result at 25% clipping</p>\n\n<p><a href=\"https://i.stack.imgur.com/2c73H.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/2c73H.png\" alt=\"enter image description here\"></a>\n<a href=\"https://i.stack.imgur.com/2hg6F.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/2hg6F.png\" alt=\"enter image description here\"></a></p>\n\n<p>Alpha and beta are automatically calculated</p>\n\n<blockquote>\n  <p>alpha 3.072289156626506</p>\n  \n  <p>beta -144.3975903614458</p>\n</blockquote>\n\n<p><img src=\"https://i.stack.imgur.com/xpUOE.png\" width=\"400\"></p>\n\n<p>Here's a visualization of the clipping. Blue (original), Orange (after auto adjustment).</p>\n\n<p>Results with clipping at 35%</p>\n\n<p><a href=\"https://i.stack.imgur.com/wtOjt.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/wtOjt.png\" alt=\"enter image description here\"></a>\n<a href=\"https://i.stack.imgur.com/ZK1VD.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/ZK1VD.png\" alt=\"enter image description here\"></a></p>\n\n<p><img src=\"https://i.stack.imgur.com/O7ELA.png\" width=\"400\"></p>\n\n<blockquote>\n  <p>alpha 3.8059701492537314</p>\n  \n  <p>beta -201.71641791044777</p>\n</blockquote>\n\n<p>Other methods could be using <a href=\"https://docs.opencv.org/3.1.0/d5/daf/tutorial_py_histogram_equalization.html\" rel=\"noreferrer\">Histogram Equalization or CLAHE</a>. </p>\n\n<pre><code>import cv2\nimport numpy as np\n# from matplotlib import pyplot as plt\n\n# Automatic brightness and contrast optimization with optional histogram clipping\ndef automatic_brightness_and_contrast(image, clip_hist_percent=25):\n    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)\n\n    # Calculate grayscale histogram\n    hist = cv2.calcHist([gray],[0],None,[256],[0,256])\n    hist_size = len(hist)\n\n    # Calculate cumulative distribution from the histogram\n    accumulator = []\n    accumulator.append(float(hist[0]))\n    for index in range(1, hist_size):\n        accumulator.append(accumulator[index -1] + float(hist[index]))\n\n    # Locate points to clip\n    maximum = accumulator[-1]\n    clip_hist_percent *= (maximum/100.0)\n    clip_hist_percent /= 2.0\n\n    # Locate left cut\n    minimum_gray = 0\n    while accumulator[minimum_gray] &lt; clip_hist_percent:\n        minimum_gray += 1\n\n    # Locate right cut\n    maximum_gray = hist_size -1\n    while accumulator[maximum_gray] &gt;= (maximum - clip_hist_percent):\n        maximum_gray -= 1\n\n    # Calculate alpha and beta values\n    alpha = 255 / (maximum_gray - minimum_gray)\n    beta = -minimum_gray * alpha\n\n    '''\n    # Calculate new histogram with desired range and show histogram \n    new_hist = cv2.calcHist([gray],[0],None,[256],[minimum_gray,maximum_gray])\n    plt.plot(hist)\n    plt.plot(new_hist)\n    plt.xlim([0,256])\n    plt.show()\n    '''\n\n    auto_result = cv2.convertScaleAbs(image, alpha=alpha, beta=beta)\n    return (auto_result, alpha, beta)\n\nimage = cv2.imread('1.png')\nauto_result, alpha, beta = automatic_brightness_and_contrast(image)\nprint('alpha', alpha)\nprint('beta', beta)\ncv2.imshow('auto_result', auto_result)\ncv2.imwrite('auto_result.png', auto_result)\ncv2.imshow('image', image)\ncv2.waitKey()\n</code></pre>\n\n<p>An alternative version is to add bias and gain to an image using saturation arithmetics instead of using OpenCV's <code>cv2.convertScaleAbs</code>. The built-in method does not take an absolute value, which would lead to nonsensical results (e.g., a pixel at 44 with alpha = 3 and beta = -210 becomes 78 with OpenCV, when in fact it should become 0).</p>\n\n<pre><code>import cv2\nimport numpy as np\n# from matplotlib import pyplot as plt\n\ndef convertScale(img, alpha, beta):\n    \"\"\"Add bias and gain to an image with saturation arithmetics. Unlike\n    cv2.convertScaleAbs, it does not take an absolute value, which would lead to\n    nonsensical results (e.g., a pixel at 44 with alpha = 3 and beta = -210\n    becomes 78 with OpenCV, when in fact it should become 0).\n    \"\"\"\n\n    new_img = img * alpha + beta\n    new_img[new_img &lt; 0] = 0\n    new_img[new_img &gt; 255] = 255\n    return new_img.astype(np.uint8)\n\n# Automatic brightness and contrast optimization with optional histogram clipping\ndef automatic_brightness_and_contrast(image, clip_hist_percent=25):\n    gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)\n\n    # Calculate grayscale histogram\n    hist = cv2.calcHist([gray],[0],None,[256],[0,256])\n    hist_size = len(hist)\n\n    # Calculate cumulative distribution from the histogram\n    accumulator = []\n    accumulator.append(float(hist[0]))\n    for index in range(1, hist_size):\n        accumulator.append(accumulator[index -1] + float(hist[index]))\n\n    # Locate points to clip\n    maximum = accumulator[-1]\n    clip_hist_percent *= (maximum/100.0)\n    clip_hist_percent /= 2.0\n\n    # Locate left cut\n    minimum_gray = 0\n    while accumulator[minimum_gray] &lt; clip_hist_percent:\n        minimum_gray += 1\n\n    # Locate right cut\n    maximum_gray = hist_size -1\n    while accumulator[maximum_gray] &gt;= (maximum - clip_hist_percent):\n        maximum_gray -= 1\n\n    # Calculate alpha and beta values\n    alpha = 255 / (maximum_gray - minimum_gray)\n    beta = -minimum_gray * alpha\n\n    '''\n    # Calculate new histogram with desired range and show histogram \n    new_hist = cv2.calcHist([gray],[0],None,[256],[minimum_gray,maximum_gray])\n    plt.plot(hist)\n    plt.plot(new_hist)\n    plt.xlim([0,256])\n    plt.show()\n    '''\n\n    auto_result = convertScale(image, alpha=alpha, beta=beta)\n    return (auto_result, alpha, beta)\n\nimage = cv2.imread('1.jpg')\nauto_result, alpha, beta = automatic_brightness_and_contrast(image)\nprint('alpha', alpha)\nprint('beta', beta)\ncv2.imshow('auto_result', auto_result)\ncv2.imwrite('auto_result.png', auto_result)\ncv2.imshow('image', image)\ncv2.waitKey()\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 9938133,
                                "reputation": 50612,
                                "user_id": 7355741,
                                "user_type": "registered",
                                "display_name": "fmw42"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1563401720,
                            "post_id": 57049263,
                            "comment_id": 100692411,
                            "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv/57049263#comment100692411_57049263",
                            "body": "<code>@nathancy</code>. Thanks for the correction. However, I was unaware of any policy on inline links. Can you point me to where that is discussed along with any other similar policy on style. I did not find anything in the Help Center about that. Thanks"
                        }
                    ],
                    "owner": {
                        "account_id": 9938133,
                        "reputation": 50612,
                        "user_id": 7355741,
                        "user_type": "registered",
                        "display_name": "fmw42"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 4,
                    "last_activity_date": 1563401082,
                    "last_edit_date": 1563401082,
                    "creation_date": 1563243675,
                    "answer_id": 57049263,
                    "question_id": 57030125,
                    "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv/57049263#57049263",
                    "body": "<p>You need to modify the contrast as well as the brightness. </p>\n\n<p>I do not use OpenCV, but here is a solution from a (Unix) bash script that I built for Imagemagick. <em>Note that mean controls brightness and std controls contrast.</em></p>\n\n<p>The script was originally intended to adjust one image to match the colors/brightness/contrast of another image. The matching uses the mean and standard deviations from each image according to the equation: (I2-Mean2)/Std2 = (I1-Mean1)/Std1. This equation represents an normalized intensity such that it has zero mean and approximately the same range of values due to the division by the standard deviations. We solve this equation to form a linear transformation between I1 and I2 according to I2 = A x I1 + B, where A=(Std2/Std1) is the slope or gain and B=(Mean2 - A x Mean1) is the intercept of bias. If no second image is provide and a (set of) mean(s) and standard deviation(s) are provided, then first file will be matched to the provided means and standard deviations. <em>Slope or Gain correlates to contrast and Intercept or Bias correlates to brightness.</em></p>\n\n<p>Input:</p>\n\n<p><a href=\"https://i.stack.imgur.com/1kp9T.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/1kp9T.png\" alt=\"enter image description here\"></a></p>\n\n<pre><code>matchimage -c rgb -m 0.6 -s 0.25 bunny.png result1.png\n</code></pre>\n\n<p><br>\n<a href=\"https://i.stack.imgur.com/Q5XXC.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/Q5XXC.png\" alt=\"enter image description here\"></a></p>\n\n<p>Or slightly more contrast:</p>\n\n<pre><code>matchimage -c rgb -m 0.6 -s 0.35 bunny.png result2.png\n</code></pre>\n\n<p><br>\n<a href=\"https://i.stack.imgur.com/9wFrM.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/9wFrM.png\" alt=\"enter image description here\"></a></p>\n\n<p>Arguments are normalize to 0 to 1 range. So mean=0.6 is equivalent to 60%. I think 66% might be too bright, but you can change the values as desired.</p>\n\n<p>In this case, since your image was mostly grayscale, I use colorspace RGB for processing. Processing can be done in several other colorspaces.</p>\n\n<p>There is a similar Python script <a href=\"https://www.pyimagesearch.com/2014/06/30/super-fast-color-transfer-images/\" rel=\"nofollow noreferrer\">here</a>, which just matches one image to another, but doing so in LAB colorspace. However, it should be easy enough to change it to match one image to a set of mean and std arguments. </p>\n\n<p>(My scripts are available <a href=\"http://www.fmwconcepts.com/imagemagick/index.php\" rel=\"nofollow noreferrer\">here</a>)</p>\n"
                },
                {
                    "owner": {
                        "account_id": 12741167,
                        "reputation": 4108,
                        "user_id": 9251158,
                        "user_type": "registered",
                        "display_name": "emonigma"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1579553160,
                    "last_edit_date": 1579553160,
                    "creation_date": 1579457775,
                    "answer_id": 59813007,
                    "question_id": 57030125,
                    "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv/59813007#59813007",
                    "body": "<p>One solution is to adjust the gamma of the image. In the code below, I first saturate the image to a certain percentile at the top and bottom of the range, then adjust the gamma correction until reaching the required brightness.</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>import cv2\nimport numpy as np\n\ndef saturate(img, percentile):\n    \"\"\"Changes the scale of the image so that half of percentile at the low range\n    becomes 0, half of percentile at the top range becomes 255.\n    \"\"\"\n\n    if 2 != len(img.shape):\n        raise ValueError(\"Expected an image with only one channel\")\n\n    # copy values\n    channel = img[:, :].copy()\n    flat = channel.ravel()\n\n    # copy values and sort them\n    sorted_values = np.sort(flat)\n\n    # find points to clip\n    max_index = len(sorted_values) - 1\n    half_percent = percentile / 200\n    low_value = sorted_values[math.floor(max_index * half_percent)]\n    high_value = sorted_values[math.ceil(max_index * (1 - half_percent))]\n\n    # saturate\n    channel[channel &lt; low_value] = low_value\n    channel[channel &gt; high_value] = high_value\n\n    # scale the channel\n    channel_norm = channel.copy()\n    cv2.normalize(channel, channel_norm, 0, 255, cv2.NORM_MINMAX)\n\n    return channel_norm\n\ndef adjust_gamma(img, gamma):\n    \"\"\"Build a lookup table mapping the pixel values [0, 255] to\n    their adjusted gamma values.\n    \"\"\"\n\n    # code from\n    # https://www.pyimagesearch.com/2015/10/05/opencv-gamma-correction/\n\n    invGamma = 1.0 / gamma\n    table = np.array([((i / 255.0) ** invGamma) * 255 for i in np.arange(0, 256)]).astype(\"uint8\")\n\n    # apply gamma correction using the lookup table\n    return cv2.LUT(img, table)\n\n\ndef adjust_brightness_with_gamma(gray_img, minimum_brightness, gamma_step = GAMMA_STEP):\n\n    \"\"\"Adjusts the brightness of an image by saturating the bottom and top\n    percentiles, and changing the gamma until reaching the required brightness.\n    \"\"\"\n    if 3 &lt;= len(gray_img.shape):\n        raise ValueError(\"Expected a grayscale image, color channels found\")\n\n    cols, rows = gray_img.shape\n    changed = False\n    old_brightness = np.sum(gray_img) / (255 * cols * rows)\n    new_img = gray_img\n    gamma = 1\n\n    while True:\n        brightness = np.sum(new_img) / (255 * cols * rows)\n        if brightness &gt;= minimum_brightness:\n            break\n\n        gamma += gamma_step\n        new_img = adjust_gamma(gray_img, gamma = gamma)\n        changed = True\n\n    if changed:\n        print(\"Old brightness: %3.3f, new brightness: %3.3f \" %(old_brightness, brightness))\n    else:\n        print(\"Maintaining brightness at %3.3f\" % old_brightness)\n\n    return new_img\n\ndef main(filepath):\n\n    img = cv2.imread(filepath)\n    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)\n    saturated = saturate(gray, 1)\n    bright = adjust_brightness_with_gamma(saturated, minimum_brightness = 0.66)\n</code></pre>\n\n<p>The result is here and inferior to the accepted answer:</p>\n\n<p><a href=\"https://i.stack.imgur.com/kuOG6.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/kuOG6.png\" alt=\"Image brightened with gamma\"></a></p>\n\n<p>Depending on the image, I use either the alpha-beta adjustment in the accepted answer, or I include gamma to avoid clipping too many highlights. The size of each step, percentile for clipping and gamma for correction, determines the weight of each adjustment.</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>PERCENTILE_STEP = 1\nGAMMA_STEP = 0.01\n\ndef adjust_brightness_alpha_beta_gamma(gray_img, minimum_brightness, percentile_step = PERCENTILE_STEP, gamma_step = GAMMA_STEP):\n    \"\"\"Adjusts brightness with histogram clipping by trial and error.\n    \"\"\"\n\n    if 3 &lt;= len(gray_img.shape):\n        raise ValueError(\"Expected a grayscale image, color channels found\")\n\n    new_img = gray_img\n    percentile = percentile_step\n    gamma = 1\n    brightness_changed = False\n\n    while True:\n        cols, rows = new_img.shape\n        brightness = np.sum(new_img) / (255 * cols * rows)\n\n        if not brightness_changed:\n            old_brightness = brightness\n\n        if brightness &gt;= minimum_brightness:\n            break\n\n        # adjust alpha and beta\n        percentile += percentile_step\n        alpha, beta = percentile_to_bias_and_gain(new_img, percentile)\n        new_img = convertScale(gray_img, alpha = alpha, beta = beta)\n        brightness_changed = True\n\n        # adjust gamma\n        gamma += gamma_step\n        new_img = adjust_gamma(new_img, gamma = gamma)\n\n    if brightness_changed:\n        print(\"Old brightness: %3.3f, new brightness: %3.3f \" %(old_brightness, brightness))\n    else:\n        print(\"Maintaining brightness at %3.3f\" % old_brightness)\n\n    return new_img\n</code></pre>\n"
                }
            ],
            "owner": {
                "account_id": 12741167,
                "reputation": 4108,
                "user_id": 9251158,
                "user_type": "registered",
                "display_name": "emonigma"
            },
            "comment_count": 7,
            "is_answered": true,
            "accepted_answer_id": 57046925,
            "answer_count": 4,
            "score": 17,
            "last_activity_date": 1632098276,
            "creation_date": 1563129321,
            "last_edit_date": 1632098276,
            "question_id": 57030125,
            "link": "https://stackoverflow.com/questions/57030125/automatically-adjusting-brightness-of-image-with-opencv",
            "title": "Automatically adjusting brightness of image with OpenCV",
            "body": "<p>I want to adjust the brightness of an image to a certain value in OpenCV. For example, consider this image:</p>\n\n<p><a href=\"https://i.stack.imgur.com/Z9oyu.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/Z9oyu.png\" alt=\"original image\"></a></p>\n\n<p>I calculate the brightness with:</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>import cv2\nimg = cv2.imread(filepath)\ncols, rows = img.shape\nbrightness = numpy.sum(img) / (255 * cols * rows)\n</code></pre>\n\n<p>and I get an average brightness of 35%. To bring it to 66%, for example, I do:</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>minimum_brightness = 0.66\nalpha = brightness / minimum_brightness\nbright_img = cv2.convertScaleAbs(img, alpha = alpha, beta = 255 * (1 - alpha))\n</code></pre>\n\n<p>and I get an image that seems to have a 50% transparency veil:</p>\n\n<p><a href=\"https://i.stack.imgur.com/ivDlH.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/ivDlH.png\" alt=\"Image with bias and contrast\"></a></p>\n\n<p>I can avoid this effect by using bias only:</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>bright_img = cv2.convertScaleAbs(img, alpha = 1, beta = 128)\n</code></pre>\n\n<p>and the image also seems to have a veil:</p>\n\n<p><a href=\"https://i.stack.imgur.com/pJnUg.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/pJnUg.png\" alt=\"Image adjusted with bias only\"></a></p>\n\n<p>If I do it by hand, for example in Photoshop with a brightness adjustment at 150, the result seems alright:</p>\n\n<p><a href=\"https://i.stack.imgur.com/9URKv.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/9URKv.png\" alt=\"Image adjusted with Photoshop\"></a></p>\n\n<p>But, this is not automatic and does not give the target brightness.</p>\n\n<p>I could do it with either a gamma correction and/or histogram equalization for maybe a more natural result, but I don't see an easy way to get the target brightness other than trial-and-error.</p>\n\n<p>Has anyone succeeded in adjusting brightness automatically to a target?</p>\n\n<h2>Update</h2>\n\n<p>Kanat suggested:</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>bright_img = cv2.convertScaleAbs(img, alpha = 1, beta = 255 * (minimum_brightness - brightness))\n</code></pre>\n\n<p>and the result is better but still has a veil:</p>\n\n<p><a href=\"https://i.stack.imgur.com/Ah6Th.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/Ah6Th.png\" alt=\"Image with adjustment suggested by Kanat\"></a></p>\n\n<p>Yves Daoust suggested keeping <code>beta = 0</code>, so I adjusted <code>alpha = minimum_brightness / brightness</code> to get the target brightness:</p>\n\n<pre class=\"lang-py prettyprint-override\"><code>ratio = brightness / minimum_brightness\nif ratio &gt;= 1:\n    print(\"Image already bright enough\")\n    return img\n\n# Otherwise, adjust brightness to get the target brightness\nreturn cv2.convertScaleAbs(img, alpha = 1 / ratio, beta = 0)\n</code></pre>\n\n<p>and the result is good:</p>\n\n<p><a href=\"https://i.stack.imgur.com/LeIP4.png\" rel=\"noreferrer\"><img src=\"https://i.stack.imgur.com/LeIP4.png\" alt=\"Image with adjustment suggested by Yves Daoust\"></a></p>\n"
        }
    ],
    "has_more": false,
    "quota_max": 10000,
    "quota_remaining": 5331
}
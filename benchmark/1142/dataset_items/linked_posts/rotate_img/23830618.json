{
    "items": [
        {
            "tags": [
                "python",
                "arrays",
                "matlab",
                "opencv",
                "numpy"
            ],
            "answers": [
                {
                    "owner": {
                        "account_id": 931887,
                        "reputation": 12619,
                        "user_id": 961627,
                        "user_type": "registered",
                        "accept_rate": 61,
                        "display_name": "user961627"
                    },
                    "comment_count": 0,
                    "is_accepted": true,
                    "score": 7,
                    "last_activity_date": 1661166764,
                    "last_edit_date": 1661166764,
                    "creation_date": 1400852270,
                    "answer_id": 23830760,
                    "question_id": 23830618,
                    "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/23830760#23830760",
                    "body": "<p>The solution was to convert <code>found</code> first to a numpy array, and then to recovert it into a list:</p>\n<pre><code>found = np.array(found)\nboxes = cv2.groupRectangles(found.tolist(), 1, 2)\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 1149239,
                                "reputation": 791,
                                "user_id": 1131301,
                                "user_type": "registered",
                                "accept_rate": 75,
                                "display_name": "nair.ashvin"
                            },
                            "edited": false,
                            "score": 7,
                            "creation_date": 1439434102,
                            "post_id": 31316516,
                            "comment_id": 51863188,
                            "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/31316516#comment51863188_31316516",
                            "body": "simply copying the array worked for me for a similar error as well."
                        },
                        {
                            "owner": {
                                "account_id": 169853,
                                "reputation": 9398,
                                "user_id": 396183,
                                "user_type": "registered",
                                "accept_rate": 84,
                                "display_name": "Pwnna"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1443925482,
                            "post_id": 31316516,
                            "comment_id": 53684915,
                            "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/31316516#comment53684915_31316516",
                            "body": "Can confirm this as well, there seems to be no visible difference, tho."
                        },
                        {
                            "owner": {
                                "account_id": 3737173,
                                "reputation": 3028,
                                "user_id": 3107858,
                                "user_type": "registered",
                                "accept_rate": 68,
                                "display_name": "DanGoodrick"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1469037595,
                            "post_id": 31316516,
                            "comment_id": 64377055,
                            "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/31316516#comment64377055_31316516",
                            "body": "This solution worked for a similar error produced by the cv2.ellipse() function"
                        },
                        {
                            "owner": {
                                "account_id": 4843925,
                                "reputation": 7620,
                                "user_id": 3908170,
                                "user_type": "registered",
                                "accept_rate": 100,
                                "display_name": "DarkCygnus"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1511817766,
                            "post_id": 31316516,
                            "comment_id": 81996416,
                            "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/31316516#comment81996416_31316516",
                            "body": "Same with cv2.line ... although it seems that the issue was solved by changing it to a np array rather than &quot;just&quot; making a copy of it (that is, it should be a np array copy of your list)"
                        },
                        {
                            "owner": {
                                "account_id": 284667,
                                "reputation": 6292,
                                "user_id": 582917,
                                "user_type": "registered",
                                "accept_rate": 81,
                                "display_name": "CMCDragonkai"
                            },
                            "edited": false,
                            "score": 3,
                            "creation_date": 1521509714,
                            "post_id": 31316516,
                            "comment_id": 85751200,
                            "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/31316516#comment85751200_31316516",
                            "body": "I had the same problem, and I noticed if I just use <code>astype(np.uint8)</code> it also just works. But then I read that <code>astype</code> automatically copies the array."
                        },
                        {
                            "owner": {
                                "account_id": 400391,
                                "reputation": 5187,
                                "user_id": 766330,
                                "user_type": "registered",
                                "accept_rate": 68,
                                "display_name": "plhn"
                            },
                            "edited": false,
                            "score": 6,
                            "creation_date": 1544408274,
                            "post_id": 31316516,
                            "comment_id": 94252570,
                            "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/31316516#comment94252570_31316516",
                            "body": "Deniz Beker\u2019s solution(<code>ascontiguousarray</code>) explains why."
                        },
                        {
                            "owner": {
                                "account_id": 10430020,
                                "reputation": 456,
                                "user_id": 7715212,
                                "user_type": "registered",
                                "accept_rate": 78,
                                "display_name": "Gabriel123"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1589290360,
                            "post_id": 31316516,
                            "comment_id": 109229769,
                            "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/31316516#comment109229769_31316516",
                            "body": "thanks! I had identical problem with <code>cv2.HoughLinesP</code> AND <code>cv2.line</code> methods, and a conversion to int through <code>.astype(np.uint8)</code> solved both issues and saved my hair!"
                        }
                    ],
                    "owner": {
                        "account_id": 5966475,
                        "reputation": 991,
                        "user_id": 4690152,
                        "user_type": "registered",
                        "display_name": "Etienne Perot"
                    },
                    "comment_count": 7,
                    "is_accepted": false,
                    "score": 86,
                    "last_activity_date": 1436442391,
                    "creation_date": 1436442391,
                    "answer_id": 31316516,
                    "question_id": 23830618,
                    "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/31316516#31316516",
                    "body": "<p>My own solution was simply to ask a copy of original array...(god &amp; gary bradski knows why...)</p>\n\n<pre><code>im = dbimg[i]\nbb = boxes[i]  \nm = im.transpose((1, 2, 0)).astype(np.uint8).copy() \npt1 = (bb[0],bb[1])\npt2 = (bb[0]+bb[2],bb[1]+bb[3])  \ncv2.rectangle(m,pt1,pt2,(0,255,0),2)  \n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 315228,
                        "reputation": 5771,
                        "user_id": 630863,
                        "user_type": "registered",
                        "accept_rate": 95,
                        "display_name": "MattLBeck"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 5,
                    "last_activity_date": 1517921014,
                    "last_edit_date": 1517921014,
                    "creation_date": 1517920640,
                    "answer_id": 48643260,
                    "question_id": 23830618,
                    "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/48643260#48643260",
                    "body": "<p>Opencv appears to have issues drawing to numpy arrays that have the data type <code>np.int64</code>, which is the default data type returned by methods such as <code>np.array</code> and <code>np.full</code>:</p>\n\n<pre><code>&gt;&gt;&gt; canvas = np.full((256, 256, 3), 255)\n&gt;&gt;&gt; canvas\narray([[255, 255, 255],\n       [255, 255, 255],\n       [255, 255, 255]])\n&gt;&gt;&gt; canvas.dtype\ndtype('int64')\n&gt;&gt;&gt; cv2.rectangle(canvas, (0, 0), (2, 2), (0, 0, 0))\nTraceback (most recent call last):\n  File \"&lt;stdin&gt;\", line 1, in &lt;module&gt;\nTypeError: Layout of the output array img is incompatible with cv::Mat (step[ndims-1] != elemsize or step[1] != elemsize*nchannels)\n</code></pre>\n\n<p>The solution is to convert the array to <code>np.int32</code> first:</p>\n\n<pre><code>&gt;&gt;&gt; cv2.rectangle(canvas.astype(np.int32), (0, 0), (2, 2), (0, 0, 0))\narray([[  0,   0,   0],\n       [  0, 255,   0],\n       [  0,   0,   0]], dtype=int32)\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 6199834,
                                "reputation": 667,
                                "user_id": 6641872,
                                "user_type": "registered",
                                "display_name": "Nic"
                            },
                            "edited": false,
                            "score": 3,
                            "creation_date": 1528958710,
                            "post_id": 50128836,
                            "comment_id": 88705027,
                            "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/50128836#comment88705027_50128836",
                            "body": "Works. Can anyone explain why this is necessary for the cv2.rectangle() function?"
                        },
                        {
                            "owner": {
                                "account_id": 1355131,
                                "reputation": 2699,
                                "user_id": 1293689,
                                "user_type": "registered",
                                "accept_rate": 89,
                                "display_name": "TimZaman"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1534292174,
                            "post_id": 50128836,
                            "comment_id": 90655657,
                            "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/50128836#comment90655657_50128836",
                            "body": "it&#39;s <code>ascontiguousarray</code> -&gt; <a href=\"https://docs.scipy.org/doc/numpy/reference/generated/numpy.ascontiguousarray.html\" rel=\"nofollow noreferrer\">docs.scipy.org/doc/numpy/reference/generated/&hellip;</a>"
                        },
                        {
                            "owner": {
                                "account_id": 4600819,
                                "reputation": 4950,
                                "user_id": 3731622,
                                "user_type": "registered",
                                "accept_rate": 36,
                                "display_name": "user3731622"
                            },
                            "reply_to_user": {
                                "account_id": 6199834,
                                "reputation": 667,
                                "user_id": 6641872,
                                "user_type": "registered",
                                "display_name": "Nic"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1540849135,
                            "post_id": 50128836,
                            "comment_id": 93007984,
                            "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/50128836#comment93007984_50128836",
                            "body": "@Nic worked for me too.  I&#39;d like to hear why this is necessary too."
                        },
                        {
                            "owner": {
                                "account_id": 10631529,
                                "reputation": 2004,
                                "user_id": 7829525,
                                "user_type": "registered",
                                "accept_rate": 20,
                                "display_name": "Eric Cousineau"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1602621747,
                            "post_id": 50128836,
                            "comment_id": 113777803,
                            "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/50128836#comment113777803_50128836",
                            "body": "The error message more-or-less describes it, but yeah, it uses some specialized terms. If you want to dig more, here&#39;s the cv2 code: <a href=\"https://github.com/opencv/opencv/blob/3.4.0/modules/python/src2/cv2.cpp#L327-L336\" rel=\"nofollow noreferrer\">github.com/opencv/opencv/blob/3.4.0/modules/python/src2/&hellip;</a> Basically, <code>cv::Mat</code> can only express a certain type of stride (or &quot;step&quot;), and you need a writeable view, so you can&#39;t copy (as that defeats the purpose of an output arg entirely), hence the fail-fast. For more details: <a href=\"https://docs.opencv.org/3.4.0/d3/d63/classcv_1_1Mat.html#details\" rel=\"nofollow noreferrer\">docs.opencv.org/3.4.0/d3/d63/classcv_1_1Mat.html#details</a>"
                        },
                        {
                            "owner": {
                                "account_id": 12417764,
                                "reputation": 358,
                                "user_id": 9793651,
                                "user_type": "registered",
                                "display_name": "Can H. Tartanoglu"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1639918818,
                            "post_id": 50128836,
                            "comment_id": 124465964,
                            "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/50128836#comment124465964_50128836",
                            "body": "Like some other people in this comment area, I also got here because of issues with <code>cv2.rectange()</code>. My problem was with the color type, my color was <code>np.ndarray</code>, converting it to <code>tuple</code> solved my problem."
                        }
                    ],
                    "owner": {
                        "account_id": 3338139,
                        "reputation": 2074,
                        "user_id": 2805070,
                        "user_type": "registered",
                        "accept_rate": 80,
                        "display_name": "Deniz Beker"
                    },
                    "comment_count": 5,
                    "is_accepted": false,
                    "score": 61,
                    "last_activity_date": 1534405790,
                    "last_edit_date": 1534405790,
                    "creation_date": 1525244550,
                    "answer_id": 50128836,
                    "question_id": 23830618,
                    "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/50128836#50128836",
                    "body": "<p>Another reason may be that the array is not contiguous. Making it contiguous would also solve the issue</p>\n\n<p><code>image = np.ascontiguousarray(image, dtype=np.uint8)</code></p>\n"
                },
                {
                    "owner": {
                        "account_id": 10430020,
                        "reputation": 456,
                        "user_id": 7715212,
                        "user_type": "registered",
                        "accept_rate": 78,
                        "display_name": "Gabriel123"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1589291225,
                    "creation_date": 1589291225,
                    "answer_id": 61753403,
                    "question_id": 23830618,
                    "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/61753403#61753403",
                    "body": "<p>Just for the sake of completeness, it seems that many of us have used the solution of Etienne Perot above, minus <code>.copy()</code>. Converting the array type to int is enough. For example, when using the Hough transform:</p>\n\n<pre><code>    # Define the Hough transform parameters\n    rho,theta,threshold,min,max = 1, np.pi/180, 30, 40, 60  \n\n    image = ima.astype(np.uint8) # assuming that ima is an image.\n\n    # Run Hough on edge detected image\n    lines = cv2.HoughLinesP(sob, rho, theta, threshold, np.array([]), min, max)\n\n    # Iterate over the output \"lines\" and draw lines on the blank \n    line_image = np.array([[0 for col in range(x)] for row in range(y)]).astype(np.uint8)\n\n    for line in lines: # lines are series of (x,y) coordinates\n        for x1,y1,x2,y2 in line:\n            cv2.line(line_image, (x1,y1), (x2,y2), (255,0,0), 10)\n</code></pre>\n\n<p>Only then could the data be plotted out using <code>plt.imshow()</code></p>\n"
                },
                {
                    "owner": {
                        "account_id": 8625030,
                        "reputation": 381,
                        "user_id": 6458495,
                        "user_type": "registered",
                        "display_name": "lahmania"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 1,
                    "last_activity_date": 1657000856,
                    "creation_date": 1657000856,
                    "answer_id": 72864619,
                    "question_id": 23830618,
                    "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/72864619#72864619",
                    "body": "<p>Had the same problem when running</p>\n<blockquote>\n<p>image = cv2.putText(image, 'text', org, font, fontScale, color, thickness, cv2.LINE_AA)</p>\n</blockquote>\n<p>This worked for me</p>\n<blockquote>\n<p>image = cv2.putText(image.astype(np.uint8).copy(), 'text', org, font, fontScale, color, thickness, cv2.LINE_AA)</p>\n</blockquote>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 9897892,
                                "reputation": 58642,
                                "user_id": 7328782,
                                "user_type": "registered",
                                "accept_rate": 86,
                                "display_name": "Cris Luengo"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1675692399,
                            "post_id": 75359958,
                            "comment_id": 132977753,
                            "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/75359958#comment132977753_75359958",
                            "body": "\u201cFor some reason, OpenCV requires its input to be in C order\u201d it\u2019s a design decision. It makes all their code simpler. Having to deal with arbitrary memory layout requires a bit more work. OpenCV requires each image row to be contiguous in memory, it does allow a gap between rows."
                        }
                    ],
                    "owner": {
                        "account_id": 3540896,
                        "reputation": 158,
                        "user_id": 2958041,
                        "user_type": "registered",
                        "display_name": "vvolhejn"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 8,
                    "last_activity_date": 1675860580,
                    "last_edit_date": 1675860580,
                    "creation_date": 1675678567,
                    "answer_id": 75359958,
                    "question_id": 23830618,
                    "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat/75359958#75359958",
                    "body": "<p>There are a lot of proposed solutions here, but the root cause is the memory layout of the array. For some reason (edit: see comment below), OpenCV requires its input to be in C order (row-major) and not F order (column-major), see <a href=\"https://stackoverflow.com/questions/27266338/what-does-the-order-parameter-in-numpy-array-do-aka-what-is-contiguous-order\">here</a> for details.</p>\n<p>All of the proposed solutions here implicitly change the array to C order:</p>\n<ul>\n<li>using <code>array.copy()</code> does it because there is a default parameter of <code>order='C'</code></li>\n<li>converting to a list and back to NumPy, since C order is the default</li>\n<li><code>array.astype()</code> <em>might</em> do this (seems to depend on the original layout and dtype)</li>\n<li><code>np.ascontiguousarray()</code> converts to C order.</li>\n</ul>\n<p>Here's a little example that reproduces the issue, with <code>cv2.line</code> in this case.</p>\n<pre class=\"lang-py prettyprint-override\"><code>import cv2\nimport numpy as np\n\nimg = np.zeros((200, 200, 3), dtype=np.uint8)\n\n# Breaks\nimg = np.require(img, requirements=[&quot;F_CONTIGUOUS&quot;])\n\n# img = np.require(img, requirements=[&quot;C_CONTIGUOUS&quot;])  # Fixes it\n# img = img.copy()  # Also fixes it\n\ncv2.line(img, (10, 10), (100, 100), (255,0,0), 5)\n</code></pre>\n"
                }
            ],
            "owner": {
                "account_id": 931887,
                "reputation": 12619,
                "user_id": 961627,
                "user_type": "registered",
                "accept_rate": 61,
                "display_name": "user961627"
            },
            "comment_count": 0,
            "is_answered": true,
            "accepted_answer_id": 23830760,
            "answer_count": 7,
            "score": 25,
            "last_activity_date": 1675860580,
            "creation_date": 1400851894,
            "question_id": 23830618,
            "link": "https://stackoverflow.com/questions/23830618/python-opencv-typeerror-layout-of-the-output-array-incompatible-with-cvmat",
            "title": "python opencv TypeError: Layout of the output array incompatible with cv::Mat",
            "body": "<p>I'm using the selective search here: <a href=\"http://koen.me/research/selectivesearch/\" rel=\"noreferrer\">http://koen.me/research/selectivesearch/</a>\nThis gives possible regions of interest where an object might be. I want to do some processing and retain only some of the regions, and then remove duplicate bounding boxes to have a final neat collection of bounding boxes. To discard unwanted/duplicated bounding boxes regions, I'm using the <code>grouprectangles</code> function of opencv for pruning.</p>\n\n<p>Once I get the interesting regions from Matlab from the \"selective search algorithm\" in the link above, I save the results in a <code>.mat</code> file and then retrieve them in a python program, like this:</p>\n\n<pre><code> import scipy.io as sio\n inboxes = sio.loadmat('C:\\\\PATH_TO_MATFILE.mat')\n candidates = np.array(inboxes['boxes'])\n # candidates is 4 x N array with each row describing a bounding box like this: \n # [rowBegin colBegin rowEnd colEnd]\n # Now I will process the candidates and retain only those regions that are interesting\n found = [] # This is the list in which I will retain what's interesting\n for win in candidates: \n     # doing some processing here, and if some condition is met, then retain it:\n     found.append(win)\n\n# Now I want to store only the interesting regions, stored in 'found', \n# and prune unnecessary bounding boxes\n\nboxes = cv2.groupRectangles(found, 1, 2) # But I get an error here\n</code></pre>\n\n<p>The error is:</p>\n\n<pre><code>    boxes = cv2.groupRectangles(found, 1, 2)\nTypeError: Layout of the output array rectList is incompatible with cv::Mat (step[ndims-1] != elemsize or step[1] != elemsize*nchannels)\n</code></pre>\n\n<p>What's wrong?\nI did something very similar in another piece of code which gave no errors. This was the error-free code:</p>\n\n<pre><code>inboxes = sio.loadmat('C:\\\\PATH_TO_MY_FILE\\\\boxes.mat')\nboxes = np.array(inboxes['boxes'])\npruned_boxes = cv2.groupRectangles(boxes.tolist(), 100, 300)\n</code></pre>\n\n<p>The only difference I can see is that <code>boxes</code> was a numpy array which I then converted to a list. But in my problematic code, <code>found</code> is already a list.</p>\n"
        }
    ],
    "has_more": false,
    "quota_max": 10000,
    "quota_remaining": 7858
}
{
    "items": [
        {
            "tags": [
                "python",
                "python-imaging-library",
                "perspective"
            ],
            "comments": [
                {
                    "owner": {
                        "account_id": 2053832,
                        "reputation": 19061,
                        "user_id": 1832154,
                        "user_type": "registered",
                        "display_name": "mmgp"
                    },
                    "edited": false,
                    "score": 2,
                    "creation_date": 1357431047,
                    "post_id": 14177744,
                    "comment_id": 19647836,
                    "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil#comment19647836_14177744",
                    "body": "Are you aware of the equations involved in perspective transform ? See <a href=\"http://xenia.media.mit.edu/~cwren/interpolator/\" rel=\"nofollow noreferrer\">xenia.media.mit.edu/~cwren/interpolator</a>"
                }
            ],
            "answers": [
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 158604,
                                "reputation": 7517,
                                "user_id": 377366,
                                "user_type": "registered",
                                "accept_rate": 94,
                                "display_name": "KobeJohn"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1386145226,
                            "post_id": 14178717,
                            "comment_id": 30411617,
                            "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil/14178717#comment30411617_14178717",
                            "body": "Your answer is very helpful and clear. Thank you. Are you aware of any pure-python implementation of <code>def find_coeffs(pa, pb)</code>? I&#39;m hoping to avoid adding a numpy dependency for a non-central part of my system. I guess I can work it out myself but I&#39;m hoping it is out there somewhere already."
                        },
                        {
                            "owner": {
                                "account_id": 3461545,
                                "reputation": 2921,
                                "user_id": 2898490,
                                "user_type": "registered",
                                "accept_rate": 69,
                                "display_name": "Karim Bahgat"
                            },
                            "reply_to_user": {
                                "account_id": 158604,
                                "reputation": 7517,
                                "user_id": 377366,
                                "user_type": "registered",
                                "accept_rate": 94,
                                "display_name": "KobeJohn"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1411506432,
                            "post_id": 14178717,
                            "comment_id": 40726606,
                            "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil/14178717#comment40726606_14178717",
                            "body": "It might be too late for your particular project @kobejohn, but I just posted a new answer that has a pure-Python solution for generating the coefficients."
                        },
                        {
                            "owner": {
                                "account_id": 4043418,
                                "reputation": 1438,
                                "user_id": 3325465,
                                "user_type": "registered",
                                "accept_rate": 73,
                                "display_name": "bcdan"
                            },
                            "edited": false,
                            "score": 2,
                            "creation_date": 1438634586,
                            "post_id": 14178717,
                            "comment_id": 51520596,
                            "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil/14178717#comment51520596_14178717",
                            "body": "@mmgp The link you provided in your answer is now broken, giving 403."
                        },
                        {
                            "owner": {
                                "account_id": 311987,
                                "reputation": 8913,
                                "user_id": 625840,
                                "user_type": "registered",
                                "accept_rate": 92,
                                "display_name": "Hartley Brody"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1448219225,
                            "post_id": 14178717,
                            "comment_id": 55482209,
                            "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil/14178717#comment55482209_14178717",
                            "body": "How do you remove the black that appears in the space that&#39;s opened up around the image? I can&#39;t tell if I should try to crop the new image, or if there&#39;s a simple way to turn the black parts transparent. I&#39;d like to paste the transformed image on top of another image, and I can&#39;t have the extra black around the sides."
                        },
                        {
                            "owner": {
                                "account_id": 311987,
                                "reputation": 8913,
                                "user_id": 625840,
                                "user_type": "registered",
                                "accept_rate": 92,
                                "display_name": "Hartley Brody"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1448222349,
                            "post_id": 14178717,
                            "comment_id": 55483379,
                            "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil/14178717#comment55483379_14178717",
                            "body": "Answered my own question about pasting a transformed image onto another image without the &#39;transparent&#39; images showing up as black. Check out this question: <a href=\"http://stackoverflow.com/questions/5324647/how-to-merge-a-transparent-png-image-with-another-image-using-pil\" title=\"how to merge a transparent png image with another image using pil\">stackoverflow.com/questions/5324647/&hellip;</a>  Relevant bit was <code>background.paste(foreground, (0, 0), foreground)</code>, needing to pass the pasted image as both first <i>and third</i> param, to set it as a mask"
                        },
                        {
                            "owner": {
                                "account_id": 1116824,
                                "reputation": 504,
                                "user_id": 1105984,
                                "user_type": "registered",
                                "accept_rate": 50,
                                "display_name": "Yuriy Chernyshov"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1505528891,
                            "post_id": 14178717,
                            "comment_id": 79463246,
                            "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil/14178717#comment79463246_14178717",
                            "body": "What is &quot;coeffs&quot; looks like for the second from the last image?"
                        },
                        {
                            "owner": {
                                "account_id": 4526333,
                                "reputation": 1103,
                                "user_id": 3678023,
                                "user_type": "registered",
                                "accept_rate": 86,
                                "display_name": "Aaron Esau"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1545366140,
                            "post_id": 14178717,
                            "comment_id": 94605286,
                            "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil/14178717#comment94605286_14178717",
                            "body": "How do I tell what those magic numbers are and what I should replace them with for my case (<code>256</code>)? Do you think you could post the <code>find_coeffs</code> function usage with variable names like <code>original_left_corner_y</code> and <code>new_left_corner_y</code>, etc? Thanks!"
                        },
                        {
                            "owner": {
                                "account_id": 16203418,
                                "reputation": 71,
                                "user_id": 11699274,
                                "user_type": "registered",
                                "display_name": "PanZWarzywniaka"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1691062101,
                            "post_id": 14178717,
                            "comment_id": 135442233,
                            "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil/14178717#comment135442233_14178717",
                            "body": "The link is dead no unfortunatelly."
                        }
                    ],
                    "owner": {
                        "account_id": 2053832,
                        "reputation": 19061,
                        "user_id": 1832154,
                        "user_type": "registered",
                        "display_name": "mmgp"
                    },
                    "comment_count": 8,
                    "is_accepted": true,
                    "score": 102,
                    "last_activity_date": 1533473459,
                    "last_edit_date": 1533473459,
                    "creation_date": 1357439735,
                    "answer_id": 14178717,
                    "question_id": 14177744,
                    "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil/14178717#14178717",
                    "body": "<p>To apply a perspective transformation you first have to know four points in a plane A that will be mapped to four points in a plane B. With those points, you can derive the homographic transform. By doing this, you obtain your 8 coefficients and the transformation can take place.</p>\n\n<p>The site <a href=\"http://xenia.media.mit.edu/~cwren/interpolator/\" rel=\"noreferrer\">http://xenia.media.mit.edu/~cwren/interpolator/</a> (mirror: <a href=\"https://web.archive.org/web/20150222120106/xenia.media.mit.edu/~cwren/interpolator/\" rel=\"noreferrer\">WebArchive</a>), as well as many other texts, describes how those coefficients can be determined. To make things easy, here is a direct implementation according from the mentioned link:</p>\n\n<pre><code>import numpy\n\ndef find_coeffs(pa, pb):\n    matrix = []\n    for p1, p2 in zip(pa, pb):\n        matrix.append([p1[0], p1[1], 1, 0, 0, 0, -p2[0]*p1[0], -p2[0]*p1[1]])\n        matrix.append([0, 0, 0, p1[0], p1[1], 1, -p2[1]*p1[0], -p2[1]*p1[1]])\n\n    A = numpy.matrix(matrix, dtype=numpy.float)\n    B = numpy.array(pb).reshape(8)\n\n    res = numpy.dot(numpy.linalg.inv(A.T * A) * A.T, B)\n    return numpy.array(res).reshape(8)\n</code></pre>\n\n<p>where <code>pb</code> is the four vertices in the current plane, and <code>pa</code> contains four vertices in the resulting plane.</p>\n\n<p>So, suppose we transform an image as in:</p>\n\n<pre><code>import sys\nfrom PIL import Image\n\nimg = Image.open(sys.argv[1])\nwidth, height = img.size\nm = -0.5\nxshift = abs(m) * width\nnew_width = width + int(round(xshift))\nimg = img.transform((new_width, height), Image.AFFINE,\n        (1, m, -xshift if m &gt; 0 else 0, 0, 1, 0), Image.BICUBIC)\nimg.save(sys.argv[2])\n</code></pre>\n\n<p>Here is a sample input and output with the code above:</p>\n\n<p><img src=\"https://i.stack.imgur.com/dHGcB.png\" alt=\"enter image description here\"> <img src=\"https://i.stack.imgur.com/EOwht.png\" alt=\"enter image description here\"></p>\n\n<p>We can continue on the last code and perform a perspective transformation to revert the shear:</p>\n\n<pre><code>coeffs = find_coeffs(\n        [(0, 0), (256, 0), (256, 256), (0, 256)],\n        [(0, 0), (256, 0), (new_width, height), (xshift, height)])\n\nimg.transform((width, height), Image.PERSPECTIVE, coeffs,\n        Image.BICUBIC).save(sys.argv[3])\n</code></pre>\n\n<p>Resulting in:</p>\n\n<p><img src=\"https://i.stack.imgur.com/wY6iQ.png\" alt=\"enter image description here\"></p>\n\n<p>You can also have some fun with the destination points:</p>\n\n<p><img src=\"https://i.stack.imgur.com/GicNm.png\" alt=\"enter image description here\"> <img src=\"https://i.stack.imgur.com/tYwvt.png\" alt=\"enter image description here\"></p>\n"
                },
                {
                    "owner": {
                        "account_id": 27199,
                        "reputation": 152220,
                        "user_id": 71522,
                        "user_type": "registered",
                        "accept_rate": 62,
                        "display_name": "David Wolever"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 13,
                    "last_activity_date": 1402097907,
                    "last_edit_date": 1402097907,
                    "creation_date": 1402079580,
                    "answer_id": 24088499,
                    "question_id": 14177744,
                    "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil/24088499#24088499",
                    "body": "<p>I'm going to hijack this question <em>just a tiny bit</em> because it's the only thing on Google pertaining to perspective transformations in Python. Here is some slightly more general code based on the above which creates a perspective transform matrix and generates a function which will run that transform on arbitrary points:</p>\n\n<pre><code>import numpy as np\n\ndef create_perspective_transform_matrix(src, dst):\n    \"\"\" Creates a perspective transformation matrix which transforms points\n        in quadrilateral ``src`` to the corresponding points on quadrilateral\n        ``dst``.\n\n        Will raise a ``np.linalg.LinAlgError`` on invalid input.\n        \"\"\"\n    # See:\n    # * http://xenia.media.mit.edu/~cwren/interpolator/\n    # * http://stackoverflow.com/a/14178717/71522\n    in_matrix = []\n    for (x, y), (X, Y) in zip(src, dst):\n        in_matrix.extend([\n            [x, y, 1, 0, 0, 0, -X * x, -X * y],\n            [0, 0, 0, x, y, 1, -Y * x, -Y * y],\n        ])\n\n    A = np.matrix(in_matrix, dtype=np.float)\n    B = np.array(dst).reshape(8)\n    af = np.dot(np.linalg.inv(A.T * A) * A.T, B)\n    return np.append(np.array(af).reshape(8), 1).reshape((3, 3))\n\n\ndef create_perspective_transform(src, dst, round=False, splat_args=False):\n    \"\"\" Returns a function which will transform points in quadrilateral\n        ``src`` to the corresponding points on quadrilateral ``dst``::\n\n            &gt;&gt;&gt; transform = create_perspective_transform(\n            ...     [(0, 0), (10, 0), (10, 10), (0, 10)],\n            ...     [(50, 50), (100, 50), (100, 100), (50, 100)],\n            ... )\n            &gt;&gt;&gt; transform((5, 5))\n            (74.99999999999639, 74.999999999999957)\n\n        If ``round`` is ``True`` then points will be rounded to the nearest\n        integer and integer values will be returned.\n\n            &gt;&gt;&gt; transform = create_perspective_transform(\n            ...     [(0, 0), (10, 0), (10, 10), (0, 10)],\n            ...     [(50, 50), (100, 50), (100, 100), (50, 100)],\n            ...     round=True,\n            ... )\n            &gt;&gt;&gt; transform((5, 5))\n            (75, 75)\n\n        If ``splat_args`` is ``True`` the function will accept two arguments\n        instead of a tuple.\n\n            &gt;&gt;&gt; transform = create_perspective_transform(\n            ...     [(0, 0), (10, 0), (10, 10), (0, 10)],\n            ...     [(50, 50), (100, 50), (100, 100), (50, 100)],\n            ...     splat_args=True,\n            ... )\n            &gt;&gt;&gt; transform(5, 5)\n            (74.99999999999639, 74.999999999999957)\n\n        If the input values yield an invalid transformation matrix an identity\n        function will be returned and the ``error`` attribute will be set to a\n        description of the error::\n\n            &gt;&gt;&gt; tranform = create_perspective_transform(\n            ...     np.zeros((4, 2)),\n            ...     np.zeros((4, 2)),\n            ... )\n            &gt;&gt;&gt; transform((5, 5))\n            (5.0, 5.0)\n            &gt;&gt;&gt; transform.error\n            'invalid input quads (...): Singular matrix\n        \"\"\"\n    try:\n        transform_matrix = create_perspective_transform_matrix(src, dst)\n        error = None\n    except np.linalg.LinAlgError as e:\n        transform_matrix = np.identity(3, dtype=np.float)\n        error = \"invalid input quads (%s and %s): %s\" %(src, dst, e)\n        error = error.replace(\"\\n\", \"\")\n\n    to_eval = \"def perspective_transform(%s):\\n\" %(\n        splat_args and \"*pt\" or \"pt\",\n    )\n    to_eval += \"  res = np.dot(transform_matrix, ((pt[0], ), (pt[1], ), (1, )))\\n\"\n    to_eval += \"  res = res / res[2]\\n\"\n    if round:\n        to_eval += \"  return (int(round(res[0][0])), int(round(res[1][0])))\\n\"\n    else:\n        to_eval += \"  return (res[0][0], res[1][0])\\n\"\n    locals = {\n        \"transform_matrix\": transform_matrix,\n    }\n    locals.update(globals())\n    exec to_eval in locals, locals\n    res = locals[\"perspective_transform\"]\n    res.matrix = transform_matrix\n    res.error = error\n    return res\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 158604,
                                "reputation": 7517,
                                "user_id": 377366,
                                "user_type": "registered",
                                "accept_rate": 94,
                                "display_name": "KobeJohn"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1411644295,
                            "post_id": 26004724,
                            "comment_id": 40785565,
                            "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil/26004724#comment40785565_26004724",
                            "body": "That&#39;s beautiful! Thanks for leaving a message for me. I finished my app by figuring out how to calculate just basic affine coefficients by myself but I may come back to it in the future and use this for more complex transformations."
                        }
                    ],
                    "owner": {
                        "account_id": 3461545,
                        "reputation": 2921,
                        "user_id": 2898490,
                        "user_type": "registered",
                        "accept_rate": 69,
                        "display_name": "Karim Bahgat"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 7,
                    "last_activity_date": 1411506700,
                    "last_edit_date": 1411506700,
                    "creation_date": 1411506348,
                    "answer_id": 26004724,
                    "question_id": 14177744,
                    "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil/26004724#26004724",
                    "body": "<p>Here is a <em>pure-Python version</em> of generating the transform coefficients (as I've seen this requested by several). I made and used it for making the <a href=\"https://github.com/karimbahgat/PyDraw\" rel=\"noreferrer\">PyDraw</a> pure-Python image drawing package. </p>\n\n<p>If using it for your own project, note that the calculations requires several advanced matrix operations which means that this function requires another, luckily pure-Python, matrix library called <code>matfunc</code> originally written by Raymond Hettinger and which you can <a href=\"http://users.rcn.com/python/download/python.htm\" rel=\"noreferrer\">download here</a> or <a href=\"https://github.com/karimbahgat/PyDraw/blob/master/pydraw/advmatrix.py\" rel=\"noreferrer\">here</a>. </p>\n\n<pre><code>import matfunc as mt\n\ndef perspective_coefficients(self, oldplane, newplane):\n    \"\"\"\n    Calculates and returns the transform coefficients needed for a perspective \n    transform, ie tilting an image in 3D.\n    Note: it is not very obvious how to set the oldplane and newplane arguments\n    in order to tilt an image the way one wants. Need to make the arguments more\n    user-friendly and handle the oldplane/newplane behind the scenes.\n    Some hints on how to do that at http://www.cs.utexas.edu/~fussell/courses/cs384g/lectures/lecture20-Z_buffer_pipeline.pdf\n\n    | **option** | **description**\n    | --- | --- \n    | oldplane | a list of four old xy coordinate pairs\n    | newplane | four points in the new plane corresponding to the old points\n\n    \"\"\"\n    # first find the transform coefficients, thanks to http://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil\n    pb,pa = oldplane,newplane\n    grid = []\n    for p1,p2 in zip(pa, pb):\n        grid.append([p1[0], p1[1], 1, 0, 0, 0, -p2[0]*p1[0], -p2[0]*p1[1]])\n        grid.append([0, 0, 0, p1[0], p1[1], 1, -p2[1]*p1[0], -p2[1]*p1[1]])\n\n    # then do some matrix magic\n    A = mt.Matrix(grid)\n    B = mt.Vec([xory for xy in pb for xory in xy])\n    AT = A.tr()\n    ATA = AT.mmul(A)\n    gridinv = ATA.inverse()\n    invAT = gridinv.mmul(AT)\n    res = invAT.mmul(B)\n    a,b,c,d,e,f,g,h = res.flatten()\n\n    # finito\n    return a,b,c,d,e,f,g,h\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 2968370,
                        "reputation": 1951,
                        "user_id": 6530454,
                        "user_type": "registered",
                        "display_name": "Amir"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 11,
                    "last_activity_date": 1496317180,
                    "last_edit_date": 1496317180,
                    "creation_date": 1496313922,
                    "answer_id": 44305445,
                    "question_id": 14177744,
                    "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil/44305445#44305445",
                    "body": "<p>The 8 transform coefficients (a, b, c, d, e, f, g, h) correspond to the following transformation:</p>\n\n<p>x' = (a<em>x + b</em>y + c) / (g<em>x + h</em>y + 1)<br>\ny' = (d<em>x + e</em>y + f) / (g<em>x + h</em>y + 1)</p>\n\n<p>These 8 coefficients can in general be found from solving 8 (linear) equations that define how 4 points on the plane transform (4 points in 2D -> 8 equations), see the answer by mmgp for a code that solves this, although you might find it a tad more accurate to change the line </p>\n\n<pre><code>res = numpy.dot(numpy.linalg.inv(A.T * A) * A.T, B)\n</code></pre>\n\n<p>to </p>\n\n<pre><code>res = numpy.linalg.solve(A, B)\n</code></pre>\n\n<p>i.e., there is no real reason to actually invert the A matrix there, or to multiply it by its transpose and losing a bit of accuracy, in order to solve the equations.</p>\n\n<p>As for your question, for a simple tilt of theta degrees around (x0, y0), the coefficients you are looking for are:</p>\n\n<pre><code>def find_rotation_coeffs(theta, x0, y0):\n    ct = cos(theta)\n    st = sin(theta)\n    return np.array([ct, -st, x0*(1-ct) + y0*st, st, ct, y0*(1-ct)-x0*st,0,0])\n</code></pre>\n\n<p>And in general any Affine transformation must have (g, h) equal to zero. Hope that helps!</p>\n"
                }
            ],
            "owner": {
                "account_id": 200787,
                "reputation": 16542,
                "user_id": 446835,
                "user_type": "registered",
                "accept_rate": 74,
                "display_name": "Hedge"
            },
            "comment_count": 1,
            "is_answered": true,
            "accepted_answer_id": 14178717,
            "answer_count": 4,
            "score": 55,
            "last_activity_date": 1711140635,
            "creation_date": 1357430069,
            "last_edit_date": 1711140635,
            "question_id": 14177744,
            "link": "https://stackoverflow.com/questions/14177744/how-does-perspective-transformation-work-in-pil",
            "title": "How does perspective transformation work in PIL?",
            "body": "<p>PIL's <a href=\"https://web.archive.org/web/20201111195341/http://effbot.org/imagingbook/image.htm#tag-Image.Image.transform\" rel=\"nofollow noreferrer\"><code>Image.transform</code></a> has a perspective-mode which requires an 8-tuple of data but I can't figure out how to convert let's say a right tilt of 30 degrees to that tuple.</p>\n<p>Can anyone explain it?</p>\n"
        }
    ],
    "has_more": false,
    "quota_max": 10000,
    "quota_remaining": 7860
}
{
    "items": [
        {
            "tags": [
                "math",
                "graphics",
                "geometry",
                "projection"
            ],
            "comments": [
                {
                    "owner": {
                        "account_id": 41390,
                        "reputation": 34708,
                        "user_id": 120261,
                        "user_type": "registered",
                        "display_name": "mtrw"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1269035760,
                    "post_id": 2477774,
                    "comment_id": 2472658,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically#comment2472658_2477774",
                    "body": "I don&#39;t quite get what you&#39;re looking for.  The fisheye maps from a sphere to the picture plane.  The reverse mapping would be from the picture back to a sphere right?  What rectilinear coordinate are you looking for?"
                },
                {
                    "owner": {
                        "account_id": 8670,
                        "reputation": 75001,
                        "user_id": 15721,
                        "user_type": "registered",
                        "accept_rate": 74,
                        "display_name": "Will"
                    },
                    "reply_to_user": {
                        "account_id": 41390,
                        "reputation": 34708,
                        "user_id": 120261,
                        "user_type": "registered",
                        "display_name": "mtrw"
                    },
                    "edited": false,
                    "score": 1,
                    "creation_date": 1269065917,
                    "post_id": 2477774,
                    "comment_id": 2474345,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically#comment2474345_2477774",
                    "body": "@mtrw My source image is fisheye distorted, and I want to undistort it"
                },
                {
                    "owner": {
                        "account_id": 41390,
                        "reputation": 34708,
                        "user_id": 120261,
                        "user_type": "registered",
                        "display_name": "mtrw"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1269117992,
                    "post_id": 2477774,
                    "comment_id": 2476965,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically#comment2476965_2477774",
                    "body": "So is the picture on <a href=\"http://photo.net/learn/fisheye/\" rel=\"nofollow noreferrer\">photo.net/learn/fisheye</a> what you&#39;re looking for?"
                },
                {
                    "owner": {
                        "account_id": 8670,
                        "reputation": 75001,
                        "user_id": 15721,
                        "user_type": "registered",
                        "accept_rate": 74,
                        "display_name": "Will"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1269118893,
                    "post_id": 2477774,
                    "comment_id": 2477023,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically#comment2477023_2477774",
                    "body": "Yes, the corrected picture e.g. via OpenCV, or a formula for correcting any point in the picture."
                },
                {
                    "owner": {
                        "account_id": 49110,
                        "reputation": 28329,
                        "user_id": 146077,
                        "user_type": "registered",
                        "accept_rate": 87,
                        "display_name": "Kirk Broadhurst"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1269335089,
                    "post_id": 2477774,
                    "comment_id": 2492895,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically#comment2492895_2477774",
                    "body": "Do you need to do this for a range of cameras, or just for one camera / one type of lens?"
                },
                {
                    "owner": {
                        "user_type": "does_not_exist",
                        "display_name": "user149533"
                    },
                    "edited": false,
                    "score": 1,
                    "creation_date": 1275891592,
                    "post_id": 2477774,
                    "comment_id": 3049925,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically#comment3049925_2477774",
                    "body": "Will, did you ever get a conclusive answer to this?  I&#39;d be very interested to see any code you ended up with."
                },
                {
                    "owner": {
                        "account_id": 4599700,
                        "reputation": 1,
                        "user_id": 3730796,
                        "user_type": "registered",
                        "accept_rate": 100,
                        "display_name": "jogall"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1406554109,
                    "post_id": 2477774,
                    "comment_id": 38863206,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically#comment38863206_2477774",
                    "body": "@Will, I know it&#39;s been a good while since this question was asked, but I&#39;ve got a similar problem -- did you ever get a piece of functional code for the transformation, including perspective correction you mentioned?"
                },
                {
                    "owner": {
                        "account_id": 8670,
                        "reputation": 75001,
                        "user_id": 15721,
                        "user_type": "registered",
                        "accept_rate": 74,
                        "display_name": "Will"
                    },
                    "reply_to_user": {
                        "account_id": 4599700,
                        "reputation": 1,
                        "user_id": 3730796,
                        "user_type": "registered",
                        "accept_rate": 100,
                        "display_name": "jogall"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1406710342,
                    "post_id": 2477774,
                    "comment_id": 38931361,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically#comment38931361_2477774",
                    "body": "@jogal I ended up using the solution I posted myself below; good luck!"
                }
            ],
            "answers": [
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 8670,
                                "reputation": 75001,
                                "user_id": 15721,
                                "user_type": "registered",
                                "accept_rate": 74,
                                "display_name": "Will"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1269203317,
                            "post_id": 2487365,
                            "comment_id": 2481688,
                            "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2487365#comment2481688_2487365",
                            "body": "This relies on having access to the camera in question.  I don&#39;t, I&#39;m just getting a video.  Additionally, it occurs to me that cameras are mass-produced and there can&#39;t be much variation individually surely?  The tools linked in the original article do not require someone to stand in front of the camera with a checkerboard!?"
                        },
                        {
                            "owner": {
                                "account_id": 44026,
                                "reputation": 3328,
                                "user_id": 128966,
                                "user_type": "registered",
                                "display_name": "jmbr"
                            },
                            "edited": false,
                            "score": 2,
                            "creation_date": 1269208696,
                            "post_id": 2487365,
                            "comment_id": 2482044,
                            "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2487365#comment2482044_2487365",
                            "body": "Camera parameters vary among the same camera just by tweaking the zoom.  Also, you could rely on auto-calibration techniques instead of using the checkerboard.    Anyway, I have edited my answer to address the first part of your question providing you with the formula you were looking for."
                        },
                        {
                            "owner": {
                                "account_id": 8670,
                                "reputation": 75001,
                                "user_id": 15721,
                                "user_type": "registered",
                                "accept_rate": 74,
                                "display_name": "Will"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1269238960,
                            "post_id": 2487365,
                            "comment_id": 2483754,
                            "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2487365#comment2483754_2487365",
                            "body": "Thank you jmbr!  The world is beginning to make some sense.  I can&#39;t actually get R_u = f*tan(2*asin(R_d/(2*f))) to give me anything but NaN however.  I have no knowledge of trigonometry and its that that is holding me back right now :("
                        },
                        {
                            "owner": {
                                "account_id": 8670,
                                "reputation": 75001,
                                "user_id": 15721,
                                "user_type": "registered",
                                "accept_rate": 74,
                                "display_name": "Will"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1269798082,
                            "post_id": 2487365,
                            "comment_id": 2533334,
                            "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2487365#comment2533334_2487365",
                            "body": "This was auto-accepted - I was holding out for a more explicit answer to the question I posed."
                        },
                        {
                            "owner": {
                                "account_id": 125888,
                                "reputation": 26747,
                                "user_id": 321973,
                                "user_type": "registered",
                                "accept_rate": 81,
                                "display_name": "Tobias Kienzler"
                            },
                            "reply_to_user": {
                                "account_id": 8670,
                                "reputation": 75001,
                                "user_id": 15721,
                                "user_type": "registered",
                                "accept_rate": 74,
                                "display_name": "Will"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1300970782,
                            "post_id": 2487365,
                            "comment_id": 6133133,
                            "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2487365#comment6133133_2487365",
                            "body": "@Will: since the bounty system has been improved, you can now accept another answer as well"
                        }
                    ],
                    "owner": {
                        "account_id": 44026,
                        "reputation": 3328,
                        "user_id": 128966,
                        "user_type": "registered",
                        "display_name": "jmbr"
                    },
                    "comment_count": 5,
                    "is_accepted": true,
                    "score": 34,
                    "last_activity_date": 1269208544,
                    "last_edit_date": 1269208544,
                    "creation_date": 1269180818,
                    "answer_id": 2487365,
                    "question_id": 2477774,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2487365#2487365",
                    "body": "<p>The <a href=\"http://wiki.panotools.org/Fisheye_Projection\" rel=\"noreferrer\">description you mention</a> states that the projection by a pin-hole camera (one that does not introduce lens distortion) is modeled by</p>\n\n<pre><code>R_u = f*tan(theta)\n</code></pre>\n\n<p>and the projection by common fisheye lens cameras (that is, distorted) is modeled by</p>\n\n<pre><code>R_d = 2*f*sin(theta/2)\n</code></pre>\n\n<p>You already know R_d and theta and if you knew the camera's focal length (represented by f) then correcting the image would amount to computing R_u in terms of R_d and theta.  In other words, </p>\n\n<pre><code>R_u = f*tan(2*asin(R_d/(2*f)))\n</code></pre>\n\n<p>is the formula you're looking for.  Estimating the focal length f can be solved by calibrating the camera or other means such as letting the user provide feedback on how well the image is corrected or using knowledge from the original scene.</p>\n\n<p>In order to solve the same problem using OpenCV, you would have to obtain the camera's intrinsic parameters and lens distortion coefficients.  See, for example, Chapter 11 of <a href=\"http://oreilly.com/catalog/9780596516130\" rel=\"noreferrer\">Learning OpenCV</a> (don't forget to check the <a href=\"http://oreilly.com/catalog/errataunconfirmed.csp?isbn=9780596516130\" rel=\"noreferrer\">correction</a>).  Then you can use a program such as this one (written with the Python bindings for OpenCV) in order to reverse lens distortion:</p>\n\n<pre><code>#!/usr/bin/python\n\n# ./undistort 0_0000.jpg 1367.451167 1367.451167 0 0 -0.246065 0.193617 -0.002004 -0.002056\n\nimport sys\nimport cv\n\ndef main(argv):\n    if len(argv) &lt; 10:\n    print 'Usage: %s input-file fx fy cx cy k1 k2 p1 p2 output-file' % argv[0]\n    sys.exit(-1)\n\n    src = argv[1]\n    fx, fy, cx, cy, k1, k2, p1, p2, output = argv[2:]\n\n    intrinsics = cv.CreateMat(3, 3, cv.CV_64FC1)\n    cv.Zero(intrinsics)\n    intrinsics[0, 0] = float(fx)\n    intrinsics[1, 1] = float(fy)\n    intrinsics[2, 2] = 1.0\n    intrinsics[0, 2] = float(cx)\n    intrinsics[1, 2] = float(cy)\n\n    dist_coeffs = cv.CreateMat(1, 4, cv.CV_64FC1)\n    cv.Zero(dist_coeffs)\n    dist_coeffs[0, 0] = float(k1)\n    dist_coeffs[0, 1] = float(k2)\n    dist_coeffs[0, 2] = float(p1)\n    dist_coeffs[0, 3] = float(p2)\n\n    src = cv.LoadImage(src)\n    dst = cv.CreateImage(cv.GetSize(src), src.depth, src.nChannels)\n    mapx = cv.CreateImage(cv.GetSize(src), cv.IPL_DEPTH_32F, 1)\n    mapy = cv.CreateImage(cv.GetSize(src), cv.IPL_DEPTH_32F, 1)\n    cv.InitUndistortMap(intrinsics, dist_coeffs, mapx, mapy)\n    cv.Remap(src, dst, mapx, mapy, cv.CV_INTER_LINEAR + cv.CV_WARP_FILL_OUTLIERS,  cv.ScalarAll(0))\n    # cv.Undistort2(src, dst, intrinsics, dist_coeffs)\n\n    cv.SaveImage(output, dst)\n\n\nif __name__ == '__main__':\n    main(sys.argv)\n</code></pre>\n\n<p>Also note that OpenCV uses a very different lens distortion model to the one in the web page you linked to.</p>\n"
                },
                {
                    "owner": {
                        "account_id": 72887,
                        "reputation": 25867,
                        "user_id": 210211,
                        "user_type": "registered",
                        "display_name": "comingstorm"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 4,
                    "last_activity_date": 1269590544,
                    "last_edit_date": 1269590544,
                    "creation_date": 1269331916,
                    "answer_id": 2498363,
                    "question_id": 2477774,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2498363#2498363",
                    "body": "<p>If you think your formulas are exact, you can comput an exact formula with trig, like so:</p>\n\n<pre><code>Rin = 2 f sin(w/2) -&gt; sin(w/2)= Rin/2f\nRout= f tan(w)     -&gt; tan(w)= Rout/f\n\n(Rin/2f)^2 = [sin(w/2)]^2 = (1 - cos(w))/2  -&gt;  cos(w) = 1 - 2(Rin/2f)^2\n(Rout/f)^2 = [tan(w)]^2 = 1/[cos(w)]^2 - 1\n\n-&gt; (Rout/f)^2 = 1/(1-2[Rin/2f]^2)^2 - 1\n</code></pre>\n\n<p>However, as @jmbr says, the actual camera distortion will depend on the lens and the zoom.  Rather than rely on a fixed formula, you might want to try a polynomial expansion:</p>\n\n<pre><code>Rout = Rin*(1 + A*Rin^2 + B*Rin^4 + ...)\n</code></pre>\n\n<p>By tweaking first A, then higher-order coefficients, you can compute any reasonable local function (the form of the expansion takes advantage of the symmetry of the problem).  In particular, it should be possible to compute initial coefficients to approximate the theoretical function above.</p>\n\n<p>Also, for good results, you will need to use an interpolation filter to generate your corrected image.  As long as the distortion is not too great, you can use the kind of filter you would use to rescale the image linearly without much problem.</p>\n\n<p>Edit:  as per your request, the equivalent scaling factor for the above formula:</p>\n\n<pre><code>(Rout/f)^2 = 1/(1-2[Rin/2f]^2)^2 - 1\n-&gt; Rout/f = [Rin/f] * sqrt(1-[Rin/f]^2/4)/(1-[Rin/f]^2/2)\n</code></pre>\n\n<p>If you plot the above formula alongside tan(Rin/f), you can see that they are very similar in shape.  Basically, distortion from the tangent becomes severe before sin(w) becomes much different from w.</p>\n\n<p>The inverse formula should be something like:</p>\n\n<pre><code>Rin/f = [Rout/f] / sqrt( sqrt(([Rout/f]^2+1) * (sqrt([Rout/f]^2+1) + 1) / 2 )\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 72887,
                                "reputation": 25867,
                                "user_id": 210211,
                                "user_type": "registered",
                                "display_name": "comingstorm"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1269446841,
                            "post_id": 2502276,
                            "comment_id": 2504961,
                            "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2502276#comment2504961_2502276",
                            "body": "The reason your code works is that you are scaling (rx,ry) by a factor theta (which is now a ratio, not an angle).  If the original lens has (as the wiki article says) a &quot;linear mapping&quot; from view angle to image offset, I believe the atan(r)/r is correct."
                        },
                        {
                            "owner": {
                                "account_id": 72887,
                                "reputation": 25867,
                                "user_id": 210211,
                                "user_type": "registered",
                                "display_name": "comingstorm"
                            },
                            "edited": false,
                            "score": 2,
                            "creation_date": 1269448041,
                            "post_id": 2502276,
                            "comment_id": 2505163,
                            "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2502276#comment2505163_2502276",
                            "body": "The reverse of your mapping should be to scale by a factor of tan(r&#39;)/r&#39;, where r&#39; is the radius from the center of the undistorted image."
                        },
                        {
                            "owner": {
                                "account_id": 72887,
                                "reputation": 25867,
                                "user_id": 210211,
                                "user_type": "registered",
                                "display_name": "comingstorm"
                            },
                            "edited": false,
                            "score": 2,
                            "creation_date": 1269448352,
                            "post_id": 2502276,
                            "comment_id": 2505208,
                            "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2502276#comment2505208_2502276",
                            "body": "And the reason both of these work is that, if you have vector v&#39; = v*k(|v|), and you want |v&#39;|=f(|v|), you take the absolute value of the first equation:  |v&#39;|=|v|*k(|v|)=f(|v|)  -- so that k(|v|)=f(|v|)/|v|"
                        },
                        {
                            "owner": {
                                "account_id": 8670,
                                "reputation": 75001,
                                "user_id": 15721,
                                "user_type": "registered",
                                "accept_rate": 74,
                                "display_name": "Will"
                            },
                            "reply_to_user": {
                                "account_id": 72887,
                                "reputation": 25867,
                                "user_id": 210211,
                                "user_type": "registered",
                                "display_name": "comingstorm"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1269456667,
                            "post_id": 2502276,
                            "comment_id": 2506481,
                            "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2502276#comment2506481_2502276",
                            "body": "@comingstorm so what&#39;s the equiv for the nonlinnear mapping?"
                        },
                        {
                            "owner": {
                                "account_id": 4077010,
                                "reputation": 418,
                                "user_id": 3348414,
                                "user_type": "registered",
                                "display_name": "SqueakyBeak"
                            },
                            "reply_to_user": {
                                "account_id": 1266963,
                                "reputation": 20008,
                                "user_id": 2911458,
                                "user_type": "registered",
                                "accept_rate": 78,
                                "display_name": "stkent"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1553020797,
                            "post_id": 2502276,
                            "comment_id": 97228570,
                            "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2502276#comment97228570_2502276",
                            "body": "@stkent, So Im doing this in R and its working except that depending on the factor I pick I see &#39;waves&#39; superimposed on the images that I&#39;m stretching or unstretching. As in, I&#39;m getting barrel distortion as desired but then there&#39;s some kind of alias looking artifact of light gray waves on top of it. Wondering if this is some kind of border issue or phase shift type thing? Example: <a href=\"https://imgur.com/a/lBNXPYh\" rel=\"nofollow noreferrer\">imgur.com/a/lBNXPYh</a>"
                        }
                    ],
                    "owner": {
                        "account_id": 8670,
                        "reputation": 75001,
                        "user_id": 15721,
                        "user_type": "registered",
                        "accept_rate": 74,
                        "display_name": "Will"
                    },
                    "comment_count": 5,
                    "is_accepted": false,
                    "score": 9,
                    "last_activity_date": 1516385647,
                    "last_edit_date": 1516385647,
                    "creation_date": 1269366264,
                    "answer_id": 2502276,
                    "question_id": 2477774,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2502276#2502276",
                    "body": "<p>(Original poster, providing an alternative)</p>\n\n<p>The following function maps destination (rectilinear) coordinates to source (fisheye-distorted) coordinates.  <strong><em>(I'd appreciate help in reversing it)</em></strong></p>\n\n<p>I got to this point through trial-and-error: I don't fundamentally grasp why this code is working, <strong><em>explanations and improved accuracy appreciated</em></strong>!</p>\n\n<pre><code>def dist(x,y):\n    return sqrt(x*x+y*y)\n\ndef correct_fisheye(src_size,dest_size,dx,dy,factor):\n    \"\"\" returns a tuple of source coordinates (sx,sy)\n        (note: values can be out of range)\"\"\"\n    # convert dx,dy to relative coordinates\n    rx, ry = dx-(dest_size[0]/2), dy-(dest_size[1]/2)\n    # calc theta\n    r = dist(rx,ry)/(dist(src_size[0],src_size[1])/factor)\n    if 0==r:\n        theta = 1.0\n    else:\n        theta = atan(r)/r\n    # back to absolute coordinates\n    sx, sy = (src_size[0]/2)+theta*rx, (src_size[1]/2)+theta*ry\n    # done\n    return (int(round(sx)),int(round(sy)))\n</code></pre>\n\n<p>When used with a factor of 3.0, it successfully undistorts the images used as examples (I made no attempt at quality interpolation):</p>\n\n<p><s>Dead link</s></p>\n\n<p>(And this is from the blog post, for comparison:)</p>\n\n<p><img src=\"https://web.archive.org/web/20170202000727if_/http://photo.net/learn/fisheye/fe06.jpg\" alt=\"Using Panotools\"></p>\n"
                },
                {
                    "owner": {
                        "account_id": 70806,
                        "reputation": 3564,
                        "user_id": 204984,
                        "user_type": "registered",
                        "accept_rate": 85,
                        "display_name": "Roman Zenka"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 3,
                    "last_activity_date": 1269614838,
                    "last_edit_date": 1269614838,
                    "creation_date": 1269440911,
                    "answer_id": 2508452,
                    "question_id": 2477774,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2508452#2508452",
                    "body": "<p>I blindly implemented the formulas from <a href=\"http://wiki.panotools.org/Fisheye_Projection\" rel=\"nofollow noreferrer\">here</a>, so I cannot guarantee it would do what you need.</p>\n\n<p>Use <code>auto_zoom</code> to get the value for the <code>zoom</code> parameter.</p>\n\n<pre><code>\ndef dist(x,y):\n    return sqrt(x*x+y*y)\n\ndef fisheye_to_rectilinear(src_size,dest_size,sx,sy,crop_factor,zoom):\n    \"\"\" returns a tuple of dest coordinates (dx,dy)\n        (note: values can be out of range)\n crop_factor is ratio of sphere diameter to diagonal of the source image\"\"\"  \n    # convert sx,sy to relative coordinates\n    rx, ry = sx-(src_size[0]/2), sy-(src_size[1]/2)\n    r = dist(rx,ry)\n\n    # focal distance = radius of the sphere\n    pi = 3.1415926535\n    f = dist(src_size[0],src_size[1])*factor/pi\n\n    # calc theta 1) linear mapping (older Nikon) \n    theta = r / f\n\n    # calc theta 2) nonlinear mapping \n    # theta = asin ( r / ( 2 * f ) ) * 2\n\n    # calc new radius\n    nr = tan(theta) * zoom\n\n    # back to absolute coordinates\n    dx, dy = (dest_size[0]/2)+rx/r*nr, (dest_size[1]/2)+ry/r*nr\n    # done\n    return (int(round(dx)),int(round(dy)))\n\n\ndef fisheye_auto_zoom(src_size,dest_size,crop_factor):\n    \"\"\" calculate zoom such that left edge of source image matches left edge of dest image \"\"\"\n    # Try to see what happens with zoom=1\n    dx, dy = fisheye_to_rectilinear(src_size, dest_size, 0, src_size[1]/2, crop_factor, 1)\n\n    # Calculate zoom so the result is what we wanted\n    obtained_r = dest_size[0]/2 - dx\n    required_r = dest_size[0]/2\n    zoom = required_r / obtained_r\n    return zoom\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 772661,
                        "reputation": 29,
                        "user_id": 896423,
                        "user_type": "unregistered",
                        "display_name": "Myke Smyth"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 2,
                    "last_activity_date": 1489725905,
                    "last_edit_date": 1489725905,
                    "creation_date": 1313489149,
                    "answer_id": 7076541,
                    "question_id": 2477774,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/7076541#7076541",
                    "body": "<p>I found this pdf file and I have proved that the maths are correct (except for the line <code>vd = *xd**fv+v0 which should say vd = **yd**+fv+v0</code>).</p>\n\n<p><a href=\"http://perception.inrialpes.fr/CAVA_Dataset/Site/files/Calibration_OpenCV.pdf\" rel=\"nofollow noreferrer\">http://perception.inrialpes.fr/CAVA_Dataset/Site/files/Calibration_OpenCV.pdf</a></p>\n\n<p>It does not use all of the latest co-efficients that OpenCV has available but I am sure that it could be adapted fairly easily.</p>\n\n<pre><code>double k1 = cameraIntrinsic.distortion[0];\ndouble k2 = cameraIntrinsic.distortion[1];\ndouble p1 = cameraIntrinsic.distortion[2];\ndouble p2 = cameraIntrinsic.distortion[3];\ndouble k3 = cameraIntrinsic.distortion[4];\ndouble fu = cameraIntrinsic.focalLength[0];\ndouble fv = cameraIntrinsic.focalLength[1];\ndouble u0 = cameraIntrinsic.principalPoint[0];\ndouble v0 = cameraIntrinsic.principalPoint[1];\ndouble u, v;\n\n\nu = thisPoint-&gt;x; // the undistorted point\nv = thisPoint-&gt;y;\ndouble x = ( u - u0 )/fu;\ndouble y = ( v - v0 )/fv;\n\ndouble r2 = (x*x) + (y*y);\ndouble r4 = r2*r2;\n\ndouble cDist = 1 + (k1*r2) + (k2*r4);\ndouble xr = x*cDist;\ndouble yr = y*cDist;\n\ndouble a1 = 2*x*y;\ndouble a2 = r2 + (2*(x*x));\ndouble a3 = r2 + (2*(y*y));\n\ndouble dx = (a1*p1) + (a2*p2);\ndouble dy = (a3*p1) + (a1*p2);\n\ndouble xd = xr + dx;\ndouble yd = yr + dy;\n\ndouble ud = (xd*fu) + u0;\ndouble vd = (yd*fv) + v0;\n\nthisPoint-&gt;x = ud; // the distorted point\nthisPoint-&gt;y = vd;\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 2867710,
                        "reputation": 31,
                        "user_id": 2461677,
                        "user_type": "registered",
                        "display_name": "Barry Vant-Hull"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 3,
                    "last_activity_date": 1370563858,
                    "last_edit_date": 1370563858,
                    "creation_date": 1370562080,
                    "answer_id": 16974001,
                    "question_id": 2477774,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/16974001#16974001",
                    "body": "<p>I took what JMBR did and basically reversed it. He took the radius of the distorted image (Rd, that is, the distance in pixels from the center of the image) and found a formula for Ru, the radius of the undistorted image.</p>\n\n<p>You want to go the other way. For each pixel in the undistorted (processed image), you want to know what the corresponding pixel is in the distorted image.\nIn other words, given (xu, yu) --> (xd, yd). You then replace each pixel in the undistorted image with its corresponding pixel from the distorted image. </p>\n\n<p>Starting where JMBR did, I do the reverse, finding Rd as a function of Ru. I get:</p>\n\n<pre><code>Rd = f * sqrt(2) * sqrt( 1 - 1/sqrt(r^2 +1))\n</code></pre>\n\n<p>where f is the focal length in pixels (I'll explain later), and <code>r = Ru/f</code>.</p>\n\n<p>The focal length for my camera was 2.5 mm. The size of each pixel on my CCD was 6 um square.  f was therefore 2500/6 = 417 pixels. This can be found by trial and error.</p>\n\n<p>Finding Rd allows you to find the corresponding pixel in the distorted image using polar coordinates.</p>\n\n<p>The angle of each pixel from the center point is the same:</p>\n\n<p><code>theta = arctan( (yu-yc)/(xu-xc) )</code>  where xc, yc are the center points.</p>\n\n<p>Then,</p>\n\n<pre><code>xd = Rd * cos(theta) + xc\nyd = Rd * sin(theta) + yc\n</code></pre>\n\n<p>Make sure you know which quadrant you are in.</p>\n\n<p>Here is the C# code I used</p>\n\n<pre><code> public class Analyzer\n {\n      private ArrayList mFisheyeCorrect;\n      private int mFELimit = 1500;\n      private double mScaleFESize = 0.9;\n\n      public Analyzer()\n      {\n            //A lookup table so we don't have to calculate Rdistorted over and over\n            //The values will be multiplied by focal length in pixels to \n            //get the Rdistorted\n          mFisheyeCorrect = new ArrayList(mFELimit);\n            //i corresponds to Rundist/focalLengthInPixels * 1000 (to get integers)\n          for (int i = 0; i &lt; mFELimit; i++)\n          {\n              double result = Math.Sqrt(1 - 1 / Math.Sqrt(1.0 + (double)i * i / 1000000.0)) * 1.4142136;\n              mFisheyeCorrect.Add(result);\n          }\n      }\n\n      public Bitmap RemoveFisheye(ref Bitmap aImage, double aFocalLinPixels)\n      {\n          Bitmap correctedImage = new Bitmap(aImage.Width, aImage.Height);\n             //The center points of the image\n          double xc = aImage.Width / 2.0;\n          double yc = aImage.Height / 2.0;\n          Boolean xpos, ypos;\n            //Move through the pixels in the corrected image; \n            //set to corresponding pixels in distorted image\n          for (int i = 0; i &lt; correctedImage.Width; i++)\n          {\n              for (int j = 0; j &lt; correctedImage.Height; j++)\n              {\n                     //which quadrant are we in?\n                  xpos = i &gt; xc;\n                  ypos = j &gt; yc;\n                     //Find the distance from the center\n                  double xdif = i-xc;\n                  double ydif = j-yc;\n                     //The distance squared\n                  double Rusquare = xdif * xdif + ydif * ydif;\n                     //the angle from the center\n                  double theta = Math.Atan2(ydif, xdif);\n                     //find index for lookup table\n                  int index = (int)(Math.Sqrt(Rusquare) / aFocalLinPixels * 1000);\n                  if (index &gt;= mFELimit) index = mFELimit - 1;\n                     //calculated Rdistorted\n                  double Rd = aFocalLinPixels * (double)mFisheyeCorrect[index]\n                                        /mScaleFESize;\n                     //calculate x and y distances\n                  double xdelta = Math.Abs(Rd*Math.Cos(theta));\n                  double ydelta = Math.Abs(Rd * Math.Sin(theta));\n                     //convert to pixel coordinates\n                  int xd = (int)(xc + (xpos ? xdelta : -xdelta));\n                  int yd = (int)(yc + (ypos ? ydelta : -ydelta));\n                  xd = Math.Max(0, Math.Min(xd, aImage.Width-1));\n                  yd = Math.Max(0, Math.Min(yd, aImage.Height-1));\n                     //set the corrected pixel value from the distorted image\n                  correctedImage.SetPixel(i, j, aImage.GetPixel(xd, yd));\n              }\n          }\n          return correctedImage;\n      }\n}\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 19646363,
                                "reputation": 419,
                                "user_id": 14381282,
                                "user_type": "registered",
                                "display_name": "Andrea Nicolai"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1648055730,
                            "post_id": 71000278,
                            "comment_id": 126529666,
                            "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/71000278#comment126529666_71000278",
                            "body": "404 page not found"
                        }
                    ],
                    "owner": {
                        "account_id": 4146780,
                        "reputation": 333,
                        "user_id": 3400246,
                        "user_type": "registered",
                        "display_name": "Jerin Antony"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1644081003,
                    "creation_date": 1644081003,
                    "answer_id": 71000278,
                    "question_id": 2477774,
                    "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/71000278#71000278",
                    "body": "<p>This can be solved as an optimization problem. Simply draw on curves in images that are supposed to be straight lines. Store the contour points for each of those curves. Now we can solve the fish eye matrix as a minimization problem. Minimize the curve in points and that will give us a fisheye matrix. It works.</p>\n<p>It can be done manually by adjusting the fish eye matrix using trackbars! Here is a <a href=\"https://github.com/jerinka/Fisheye_gui\" rel=\"nofollow noreferrer\">fish eye GUI code</a> using OpenCV for manual calibration.</p>\n"
                }
            ],
            "owner": {
                "account_id": 8670,
                "reputation": 75001,
                "user_id": 15721,
                "user_type": "registered",
                "accept_rate": 74,
                "display_name": "Will"
            },
            "comment_count": 8,
            "is_answered": true,
            "accepted_answer_id": 2487365,
            "answer_count": 7,
            "score": 55,
            "last_activity_date": 1644081003,
            "creation_date": 1269006613,
            "last_edit_date": 1495541835,
            "question_id": 2477774,
            "link": "https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically",
            "title": "correcting fisheye distortion programmatically",
            "body": "<blockquote>\n  <p><strong><em>BOUNTY STATUS UPDATE:</em></strong></p>\n</blockquote>\n\n<p><strong><a href=\"https://stackoverflow.com/questions/2477774/correcting-fisheye-distortion-programmatically/2502276#2502276\">I discovered how to map a linear lens</a></strong>, from <code>destination</code> coordinates to <code>source</code> coordinates.<br></p>\n\n<p><strong>How do you calculate the radial distance from the centre to go from fisheye to rectilinear?</strong></p>\n\n<ul>\n<li><p><strong>1).</strong> I actually struggle to reverse it, and to map source coordinates to destination coordinates.  What is the inverse, in code in the style of the converting functions I posted?\n<img src=\"https://i.stack.imgur.com/SIhfE.jpg\" width=\"500\" height=\"194\" /><br></p></li>\n<li><p><strong>2).</strong> I also see that my undistortion is imperfect on some lenses - presumably those that are not strictly linear.  What is the equivalent to-and-from source-and-destination coordinates for those lenses?  Again, more code than just mathematical formulae please... \n<img src=\"https://i.stack.imgur.com/ickIZ.jpg\" width=\"500\" height=\"194\" /></p></li>\n</ul>\n\n<hr>\n\n<blockquote>\n  <p><strong><em>Question as originally stated:</em></strong></p>\n</blockquote>\n\n<p>I have some points that describe positions in a picture taken with a fisheye lens.</p>\n\n<p>I want to convert these points to rectilinear coordinates.  I want to undistort the image.</p>\n\n<p>I've found <a href=\"http://wiki.panotools.org/Fisheye_Projection\" rel=\"noreferrer\">this description</a> of how to generate a fisheye effect, but not how to reverse it.</p>\n\n<p>There's also a <a href=\"http://photo.net/learn/fisheye/\" rel=\"noreferrer\">blog post</a> that describes how to use tools to do it; these pictures are from that:</p>\n\n<p><strong>(1)</strong> : <code>SOURCE</code> <a href=\"http://photo.net/learn/fisheye/fe01.jpg\" rel=\"noreferrer\">Original photo link</a> <br>\n<img src=\"https://i.stack.imgur.com/qLNQV.jpg\" width=\"500\" height=\"334\" /><br>\nInput : <em>Original image with fish-eye distortion to fix.</em>\n<br></p>\n\n<p><strong>(2)</strong> : <code>DESTINATION</code> <a href=\"http://photo.net/learn/fisheye/fe04.jpg\" rel=\"noreferrer\">Original photo link</a> <br>\n<img src=\"https://i.stack.imgur.com/ogb9b.jpg\" width=\"500\" height=\"237\" /><br>\nOutput : <em>Corrected image (technically also with perspective correction, but that's a separate step).</em></p>\n\n<p>How do you calculate the radial distance from the centre to go from fisheye to rectilinear?</p>\n\n<p>My function stub looks like this:</p>\n\n<pre><code>Point correct_fisheye(const Point&amp; p,const Size&amp; img) {\n    // to polar\n    const Point centre = {img.width/2,img.height/2};\n    const Point rel = {p.x-centre.x,p.y-centre.y};\n    const double theta = atan2(rel.y,rel.x);\n    double R = sqrt((rel.x*rel.x)+(rel.y*rel.y));\n    // fisheye undistortion in here please\n    //... change R ...\n    // back to rectangular\n    const Point ret = Point(centre.x+R*cos(theta),centre.y+R*sin(theta));\n    fprintf(stderr,\"(%d,%d) in (%d,%d) = %f,%f = (%d,%d)\\n\",p.x,p.y,img.width,img.height,theta,R,ret.x,ret.y);\n    return ret;\n}\n</code></pre>\n\n<p>Alternatively, I could somehow convert the image from fisheye to rectilinear before finding the points, but I'm completely befuddled by the <a href=\"http://opencv.willowgarage.com/documentation/camera_calibration_and_3d_reconstruction.html#initundistortmap\" rel=\"noreferrer\">OpenCV documentation</a>.  Is there a straightforward way to do it in OpenCV, and does it perform well enough to do it to a live video feed?</p>\n"
        }
    ],
    "has_more": false,
    "quota_max": 10000,
    "quota_remaining": 7657
}
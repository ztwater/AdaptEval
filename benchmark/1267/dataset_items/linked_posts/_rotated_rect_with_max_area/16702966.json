{
    "items": [
        {
            "tags": [
                "python",
                "algorithm",
                "opencv",
                "aabb"
            ],
            "comments": [
                {
                    "owner": {
                        "account_id": 176642,
                        "reputation": 6141,
                        "user_id": 885287,
                        "user_type": "registered",
                        "accept_rate": 81,
                        "display_name": "aaronsnoswell"
                    },
                    "edited": false,
                    "score": 1,
                    "creation_date": 1369263875,
                    "post_id": 16702966,
                    "comment_id": 24042984,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders#comment24042984_16702966",
                    "body": "As far as I can see, this is essentially a non-linear optimisation problem, (search all AABB rectangles contained in the rotated image to find the one with the largest area). I just can&#39;t seem to figure out the logic required to solve it."
                },
                {
                    "owner": {
                        "account_id": 1136430,
                        "reputation": 5948,
                        "user_id": 1121420,
                        "user_type": "registered",
                        "accept_rate": 93,
                        "display_name": "Alexey"
                    },
                    "edited": false,
                    "score": 3,
                    "creation_date": 1369266378,
                    "post_id": 16702966,
                    "comment_id": 24043655,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders#comment24043655_16702966",
                    "body": "Here&#39;s a link to the algorithm of someone who worked on the same problem. <a href=\"http://roffle-largest-rectangle.blogspot.com/2011/09/find-largest-rectangle-in-rotated-image.html\" rel=\"nofollow noreferrer\">roffle-largest-rectangle.blogspot.com/2011/09/&hellip;</a> It&#39;s Java code and I haven&#39;t checked its logic but it may help you to get started."
                },
                {
                    "owner": {
                        "account_id": 1136430,
                        "reputation": 5948,
                        "user_id": 1121420,
                        "user_type": "registered",
                        "accept_rate": 93,
                        "display_name": "Alexey"
                    },
                    "edited": false,
                    "score": 2,
                    "creation_date": 1369267117,
                    "post_id": 16702966,
                    "comment_id": 24043843,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders#comment24043843_16702966",
                    "body": "Also this <a href=\"http://stackoverflow.com/questions/5789239/calculate-largest-rectangle-in-a-rotated-rectangle\" title=\"calculate largest rectangle in a rotated rectangle\">stackoverflow.com/questions/5789239/&hellip;</a>"
                },
                {
                    "owner": {
                        "account_id": 176642,
                        "reputation": 6141,
                        "user_id": 885287,
                        "user_type": "registered",
                        "accept_rate": 81,
                        "display_name": "aaronsnoswell"
                    },
                    "reply_to_user": {
                        "account_id": 1136430,
                        "reputation": 5948,
                        "user_id": 1121420,
                        "user_type": "registered",
                        "accept_rate": 93,
                        "display_name": "Alexey"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1369267763,
                    "post_id": 16702966,
                    "comment_id": 24044006,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders#comment24044006_16702966",
                    "body": "Hey! Absolutely brilliant - both those links look perfect."
                },
                {
                    "owner": {
                        "account_id": 1136430,
                        "reputation": 5948,
                        "user_id": 1121420,
                        "user_type": "registered",
                        "accept_rate": 93,
                        "display_name": "Alexey"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1369268543,
                    "post_id": 16702966,
                    "comment_id": 24044198,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders#comment24044198_16702966",
                    "body": "Glad to help - that&#39;s an interesting math / geometry problem."
                },
                {
                    "owner": {
                        "account_id": 2035710,
                        "reputation": 1401,
                        "user_id": 1818110,
                        "user_type": "registered",
                        "display_name": "Apiwat Chantawibul"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1369268958,
                    "post_id": 16702966,
                    "comment_id": 24044301,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders#comment24044301_16702966",
                    "body": "I just went and do the maths... while you guys Googling for existing answer. Anyway, if none of that works just call me. I wrote down the term for cut-off area to be minimized and just find where the derivative of that equals to zero. That&#39;s the approach."
                },
                {
                    "owner": {
                        "account_id": 1911982,
                        "reputation": 6157,
                        "user_id": 1725562,
                        "user_type": "registered",
                        "accept_rate": 89,
                        "display_name": "coproc"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1369402791,
                    "post_id": 16702966,
                    "comment_id": 24102300,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders#comment24102300_16702966",
                    "body": "From the above mentioned links only this solution is correct: <a href=\"http://stackoverflow.com/questions/5789239/calculate-largest-rectangle-in-a-rotated-rectangle#7519376\" title=\"calculate largest rectangle in a rotated rectangle%237519376\">stackoverflow.com/questions/5789239/&hellip;</a>"
                },
                {
                    "owner": {
                        "account_id": 1634819,
                        "reputation": 676,
                        "user_id": 2106820,
                        "user_type": "registered",
                        "display_name": "Arfan Mirza"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1395245557,
                    "post_id": 16702966,
                    "comment_id": 34251872,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders#comment34251872_16702966",
                    "body": "<a href=\"http://stackoverflow.com/a/22511805/2106820\">stackoverflow.com/a/22511805/2106820</a>"
                },
                {
                    "owner": {
                        "account_id": 2396722,
                        "reputation": 4903,
                        "user_id": 2095383,
                        "user_type": "registered",
                        "accept_rate": 80,
                        "display_name": "luator"
                    },
                    "edited": false,
                    "score": 2,
                    "creation_date": 1491466129,
                    "post_id": 16702966,
                    "comment_id": 73567742,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders#comment73567742_16702966",
                    "body": "As a side note: Step A can be done with much less code, see here: <a href=\"http://www.pyimagesearch.com/2017/01/02/rotate-images-correctly-with-opencv-and-python/\" rel=\"nofollow noreferrer\">pyimagesearch.com/2017/01/02/&hellip;</a> (implemented in the function <a href=\"https://github.com/jrosebr1/imutils/blob/master/imutils/convenience.py#L41\" rel=\"nofollow noreferrer\"><code>rotate_bound()</code> of imutils</a>"
                },
                {
                    "owner": {
                        "account_id": 7397180,
                        "reputation": 837,
                        "user_id": 5628686,
                        "user_type": "registered",
                        "accept_rate": 62,
                        "display_name": "Lakshay Sharma"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1601530080,
                    "post_id": 16702966,
                    "comment_id": 113437764,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders#comment113437764_16702966",
                    "body": "Looking for a solution to a related problem: given the target height and width (smaller than the original height and width), what should the angle of rotation be? Appreciate any pointers!"
                },
                {
                    "owner": {
                        "account_id": 19886135,
                        "reputation": 75,
                        "user_id": 14569086,
                        "user_type": "registered",
                        "display_name": "Francesco Pagani"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1629798351,
                    "post_id": 16702966,
                    "comment_id": 121776082,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders#comment121776082_16702966",
                    "body": "Thanks, I also found very useful your code about how to correctly rotate an image."
                }
            ],
            "answers": [
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 1911982,
                                "reputation": 6157,
                                "user_id": 1725562,
                                "user_type": "registered",
                                "accept_rate": 89,
                                "display_name": "coproc"
                            },
                            "edited": false,
                            "score": 4,
                            "creation_date": 1369679384,
                            "post_id": 16770343,
                            "comment_id": 24175866,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16770343#comment24175866_16770343",
                            "body": "The function <code>largest_rotated_rect</code> gives rectangle dimensions that cannot be extended, i.e. no axis parallel rectangle bigger in both dimensions will fit into the rotated rectangle. But except for a few special cases this function will not return the largest (maximal area) rectangle dimensions fitting in. See my solution for the true optimum."
                        },
                        {
                            "owner": {
                                "account_id": 149775,
                                "reputation": 897,
                                "user_id": 362515,
                                "user_type": "registered",
                                "display_name": "user362515"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1392317260,
                            "post_id": 16770343,
                            "comment_id": 32920757,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16770343#comment32920757_16770343",
                            "body": "You can use <code>cv::RotatedRect(center,ImageSize,angle).boundingRect()</code> to find the size of the rotated image"
                        },
                        {
                            "owner": {
                                "account_id": 5764261,
                                "reputation": 14811,
                                "user_id": 4549682,
                                "user_type": "registered",
                                "accept_rate": 50,
                                "display_name": "wordsforthewise"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1465880463,
                            "post_id": 16770343,
                            "comment_id": 63071618,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16770343#comment63071618_16770343",
                            "body": "rotate_image actually takes the angle in degrees, not radians, since cv2.getRotationMatrix2D takes the angle in degrees, not radians   <a href=\"http://docs.opencv.org/2.4/modules/imgproc/doc/geometric_transformations.html#getrotationmatrix2d\" rel=\"nofollow noreferrer\">docs.opencv.org/2.4/modules/imgproc/doc/&hellip;</a>"
                        },
                        {
                            "owner": {
                                "account_id": 8206,
                                "reputation": 22442,
                                "user_id": 14651,
                                "user_type": "registered",
                                "display_name": "enobrev"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1471860197,
                            "post_id": 16770343,
                            "comment_id": 65500857,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16770343#comment65500857_16770343",
                            "body": "I think you have a typo.  Your results for <code>gamma</code> in the <code>largest_rotated_rect</code> method will always be the same."
                        },
                        {
                            "owner": {
                                "account_id": 5390877,
                                "reputation": 413,
                                "user_id": 4293444,
                                "user_type": "registered",
                                "display_name": "Tegos"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1489866916,
                            "post_id": 16770343,
                            "comment_id": 72861898,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16770343#comment72861898_16770343",
                            "body": "Hi. Can you tell me how get rotated image with white background not black?"
                        },
                        {
                            "owner": {
                                "account_id": 3169867,
                                "reputation": 151,
                                "user_id": 2679111,
                                "user_type": "registered",
                                "display_name": "MukeshD"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1628340638,
                            "post_id": 16770343,
                            "comment_id": 121397012,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16770343#comment121397012_16770343",
                            "body": "For choice of background colour add <code>borderValue</code> parameter to  <code>cv2.warpAffine</code> method. For white, use <code>borderValue=(255, 255, 255)</code>"
                        }
                    ],
                    "owner": {
                        "account_id": 176642,
                        "reputation": 6141,
                        "user_id": 885287,
                        "user_type": "registered",
                        "accept_rate": 81,
                        "display_name": "aaronsnoswell"
                    },
                    "comment_count": 6,
                    "is_accepted": true,
                    "score": 35,
                    "last_activity_date": 1465886091,
                    "last_edit_date": 1495541385,
                    "creation_date": 1369647544,
                    "answer_id": 16770343,
                    "question_id": 16702966,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16770343#16770343",
                    "body": "<p>So, after investigating many claimed solutions, I have finally found a method that works; The answer by <a href=\"https://stackoverflow.com/users/671973/andri\">Andri</a> and <a href=\"https://stackoverflow.com/users/2971/magnus-hoff\">Magnus Hoff</a> on <a href=\"https://stackoverflow.com/questions/5789239/calculate-largest-rectangle-in-a-rotated-rectangle#7519376\">Calculate largest rectangle in a rotated rectangle</a>.</p>\n\n<p>The below Python code contains the method of interest - <code>largest_rotated_rect</code> - and a short demo.</p>\n\n<pre><code>import math\nimport cv2\nimport numpy as np\n\n\ndef rotate_image(image, angle):\n    \"\"\"\n    Rotates an OpenCV 2 / NumPy image about it's centre by the given angle\n    (in degrees). The returned image will be large enough to hold the entire\n    new image, with a black background\n    \"\"\"\n\n    # Get the image size\n    # No that's not an error - NumPy stores image matricies backwards\n    image_size = (image.shape[1], image.shape[0])\n    image_center = tuple(np.array(image_size) / 2)\n\n    # Convert the OpenCV 3x2 rotation matrix to 3x3\n    rot_mat = np.vstack(\n        [cv2.getRotationMatrix2D(image_center, angle, 1.0), [0, 0, 1]]\n    )\n\n    rot_mat_notranslate = np.matrix(rot_mat[0:2, 0:2])\n\n    # Shorthand for below calcs\n    image_w2 = image_size[0] * 0.5\n    image_h2 = image_size[1] * 0.5\n\n    # Obtain the rotated coordinates of the image corners\n    rotated_coords = [\n        (np.array([-image_w2,  image_h2]) * rot_mat_notranslate).A[0],\n        (np.array([ image_w2,  image_h2]) * rot_mat_notranslate).A[0],\n        (np.array([-image_w2, -image_h2]) * rot_mat_notranslate).A[0],\n        (np.array([ image_w2, -image_h2]) * rot_mat_notranslate).A[0]\n    ]\n\n    # Find the size of the new image\n    x_coords = [pt[0] for pt in rotated_coords]\n    x_pos = [x for x in x_coords if x &gt; 0]\n    x_neg = [x for x in x_coords if x &lt; 0]\n\n    y_coords = [pt[1] for pt in rotated_coords]\n    y_pos = [y for y in y_coords if y &gt; 0]\n    y_neg = [y for y in y_coords if y &lt; 0]\n\n    right_bound = max(x_pos)\n    left_bound = min(x_neg)\n    top_bound = max(y_pos)\n    bot_bound = min(y_neg)\n\n    new_w = int(abs(right_bound - left_bound))\n    new_h = int(abs(top_bound - bot_bound))\n\n    # We require a translation matrix to keep the image centred\n    trans_mat = np.matrix([\n        [1, 0, int(new_w * 0.5 - image_w2)],\n        [0, 1, int(new_h * 0.5 - image_h2)],\n        [0, 0, 1]\n    ])\n\n    # Compute the tranform for the combined rotation and translation\n    affine_mat = (np.matrix(trans_mat) * np.matrix(rot_mat))[0:2, :]\n\n    # Apply the transform\n    result = cv2.warpAffine(\n        image,\n        affine_mat,\n        (new_w, new_h),\n        flags=cv2.INTER_LINEAR\n    )\n\n    return result\n\n\ndef largest_rotated_rect(w, h, angle):\n    \"\"\"\n    Given a rectangle of size wxh that has been rotated by 'angle' (in\n    radians), computes the width and height of the largest possible\n    axis-aligned rectangle within the rotated rectangle.\n\n    Original JS code by 'Andri' and Magnus Hoff from Stack Overflow\n\n    Converted to Python by Aaron Snoswell\n    \"\"\"\n\n    quadrant = int(math.floor(angle / (math.pi / 2))) &amp; 3\n    sign_alpha = angle if ((quadrant &amp; 1) == 0) else math.pi - angle\n    alpha = (sign_alpha % math.pi + math.pi) % math.pi\n\n    bb_w = w * math.cos(alpha) + h * math.sin(alpha)\n    bb_h = w * math.sin(alpha) + h * math.cos(alpha)\n\n    gamma = math.atan2(bb_w, bb_w) if (w &lt; h) else math.atan2(bb_w, bb_w)\n\n    delta = math.pi - alpha - gamma\n\n    length = h if (w &lt; h) else w\n\n    d = length * math.cos(alpha)\n    a = d * math.sin(alpha) / math.sin(delta)\n\n    y = a * math.cos(gamma)\n    x = y * math.tan(gamma)\n\n    return (\n        bb_w - 2 * x,\n        bb_h - 2 * y\n    )\n\n\ndef crop_around_center(image, width, height):\n    \"\"\"\n    Given a NumPy / OpenCV 2 image, crops it to the given width and height,\n    around it's centre point\n    \"\"\"\n\n    image_size = (image.shape[1], image.shape[0])\n    image_center = (int(image_size[0] * 0.5), int(image_size[1] * 0.5))\n\n    if(width &gt; image_size[0]):\n        width = image_size[0]\n\n    if(height &gt; image_size[1]):\n        height = image_size[1]\n\n    x1 = int(image_center[0] - width * 0.5)\n    x2 = int(image_center[0] + width * 0.5)\n    y1 = int(image_center[1] - height * 0.5)\n    y2 = int(image_center[1] + height * 0.5)\n\n    return image[y1:y2, x1:x2]\n\n\ndef demo():\n    \"\"\"\n    Demos the largest_rotated_rect function\n    \"\"\"\n\n    image = cv2.imread(\"lenna_rectangle.png\")\n    image_height, image_width = image.shape[0:2]\n\n    cv2.imshow(\"Original Image\", image)\n\n    print \"Press [enter] to begin the demo\"\n    print \"Press [q] or Escape to quit\"\n\n    key = cv2.waitKey(0)\n    if key == ord(\"q\") or key == 27:\n        exit()\n\n    for i in np.arange(0, 360, 0.5):\n        image_orig = np.copy(image)\n        image_rotated = rotate_image(image, i)\n        image_rotated_cropped = crop_around_center(\n            image_rotated,\n            *largest_rotated_rect(\n                image_width,\n                image_height,\n                math.radians(i)\n            )\n        )\n\n        key = cv2.waitKey(2)\n        if(key == ord(\"q\") or key == 27):\n            exit()\n\n        cv2.imshow(\"Original Image\", image_orig)\n        cv2.imshow(\"Rotated Image\", image_rotated)\n        cv2.imshow(\"Cropped Image\", image_rotated_cropped)\n\n    print \"Done\"\n\n\nif __name__ == \"__main__\":\n    demo()\n</code></pre>\n\n<p><img src=\"https://i.stack.imgur.com/76nJM.jpg\" alt=\"Image Rotation Demo\"></p>\n\n<p>Simply place <a href=\"https://i.stack.imgur.com/vWdWB.png\" rel=\"noreferrer\">this image</a> (cropped to demonstrate that it works with non-square images) in the same directory as the above file, then run it.</p>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 442137,
                                "reputation": 58102,
                                "user_id": 832621,
                                "user_type": "registered",
                                "accept_rate": 87,
                                "display_name": "Saullo G. P. Castro"
                            },
                            "edited": false,
                            "score": 4,
                            "creation_date": 1369858387,
                            "post_id": 16778797,
                            "comment_id": 24253249,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16778797#comment24253249_16778797",
                            "body": "+1 - I&#39;ve tested your solution against an optimization procedure (maximize the area) and your solution, always faster and more precise, has given the same results so far..."
                        },
                        {
                            "owner": {
                                "account_id": 1911982,
                                "reputation": 6157,
                                "user_id": 1725562,
                                "user_type": "registered",
                                "accept_rate": 89,
                                "display_name": "coproc"
                            },
                            "reply_to_user": {
                                "account_id": 442137,
                                "reputation": 58102,
                                "user_id": 832621,
                                "user_type": "registered",
                                "accept_rate": 87,
                                "display_name": "Saullo G. P. Castro"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1370002140,
                            "post_id": 16778797,
                            "comment_id": 24311280,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16778797#comment24311280_16778797",
                            "body": "@Saullo math can sometimes do magic! :-) thank you for sharing your findings. I have now added a (mostly graphical) derivation of the formulas."
                        },
                        {
                            "owner": {
                                "account_id": 1010149,
                                "reputation": 1078,
                                "user_id": 1022906,
                                "user_type": "registered",
                                "accept_rate": 50,
                                "display_name": "khamitimur"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1474032336,
                            "post_id": 16778797,
                            "comment_id": 66379570,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16778797#comment66379570_16778797",
                            "body": "thank you! your answer is the best one and helped me a lot!"
                        },
                        {
                            "owner": {
                                "account_id": 4623325,
                                "reputation": 5888,
                                "user_id": 3747801,
                                "user_type": "registered",
                                "accept_rate": 65,
                                "display_name": "Toke Faurby"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1514413802,
                            "post_id": 16778797,
                            "comment_id": 82967250,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16778797#comment82967250_16778797",
                            "body": "So how do I get the coordinates of this box?"
                        },
                        {
                            "owner": {
                                "account_id": 1911982,
                                "reputation": 6157,
                                "user_id": 1725562,
                                "user_type": "registered",
                                "accept_rate": 89,
                                "display_name": "coproc"
                            },
                            "reply_to_user": {
                                "account_id": 4623325,
                                "reputation": 5888,
                                "user_id": 3747801,
                                "user_type": "registered",
                                "accept_rate": 65,
                                "display_name": "Toke Faurby"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1514490411,
                            "post_id": 16778797,
                            "comment_id": 82995639,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16778797#comment82995639_16778797",
                            "body": "@TokeFaurby good question! I have added the distances of the borders of the cropped area from the bounding box (just before the <b>Proof</b> section)"
                        },
                        {
                            "owner": {
                                "account_id": 2348486,
                                "reputation": 2393,
                                "user_id": 4115369,
                                "user_type": "registered",
                                "accept_rate": 76,
                                "display_name": "Yibo Yang"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1523251115,
                            "post_id": 16778797,
                            "comment_id": 86465680,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16778797#comment86465680_16778797",
                            "body": "hint for anybody else confused: the arguments <code>w</code> and <code>h</code> to rotatedRectWithMaxArea should correspond to the sizes of the first and second axes of the image array, nothing to do with which side is actually shorter/longer."
                        },
                        {
                            "owner": {
                                "account_id": 430786,
                                "reputation": 606,
                                "user_id": 814412,
                                "user_type": "registered",
                                "accept_rate": 75,
                                "display_name": "Gorayni"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1524590484,
                            "post_id": 16778797,
                            "comment_id": 87031483,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16778797#comment87031483_16778797",
                            "body": "I would like to cite this proof on a paper. If this is your proof, did you publish it somewhere? If not, where can I find the original author? @coproc"
                        },
                        {
                            "owner": {
                                "account_id": 1911982,
                                "reputation": 6157,
                                "user_id": 1725562,
                                "user_type": "registered",
                                "accept_rate": 89,
                                "display_name": "coproc"
                            },
                            "reply_to_user": {
                                "account_id": 430786,
                                "reputation": 606,
                                "user_id": 814412,
                                "user_type": "registered",
                                "accept_rate": 75,
                                "display_name": "Gorayni"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1525251322,
                            "post_id": 16778797,
                            "comment_id": 87279084,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16778797#comment87279084_16778797",
                            "body": "@Gorayni yes, this proof is my approach. It is not published anywhere else. Just go ahead and use it (reformulate it to your needs) - it is rather straight forward anyway."
                        },
                        {
                            "owner": {
                                "account_id": 13518167,
                                "reputation": 843,
                                "user_id": 9752209,
                                "user_type": "registered",
                                "display_name": "Omkar T"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1600618045,
                            "post_id": 16778797,
                            "comment_id": 113138023,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16778797#comment113138023_16778797",
                            "body": "I made a java port while working in similar problem in android <a href=\"https://gist.github.com/omkar-tenkale/3da22fd414737e6f1f55024367004fbc\" rel=\"nofollow noreferrer\">gist.github.com/omkar-tenkale/3da22fd414737e6f1f55024367004f&zwnj;&#8203;bc</a>"
                        },
                        {
                            "owner": {
                                "account_id": 5286416,
                                "reputation": 909,
                                "user_id": 4220282,
                                "user_type": "registered",
                                "display_name": "Harry"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1697329207,
                            "post_id": 16778797,
                            "comment_id": 136266321,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16778797#comment136266321_16778797",
                            "body": "Is there a simple way to understand why &quot;<i>all corners of the sought-after rectangle are each on a side of the rotated rectangle</i>&quot; when the initial (&quot;half constrained&quot;) optimization is not feasible? It looks sensible, but I couldn&#39;t prove it."
                        }
                    ],
                    "owner": {
                        "account_id": 1911982,
                        "reputation": 6157,
                        "user_id": 1725562,
                        "user_type": "registered",
                        "accept_rate": 89,
                        "display_name": "coproc"
                    },
                    "comment_count": 10,
                    "is_accepted": false,
                    "score": 118,
                    "last_activity_date": 1626790989,
                    "last_edit_date": 1626790989,
                    "creation_date": 1369680005,
                    "answer_id": 16778797,
                    "question_id": 16702966,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/16778797#16778797",
                    "body": "<p>The math behind this solution/implementation is equivalent to <a href=\"https://stackoverflow.com/questions/5789239/calculate-largest-rectangle-in-a-rotated-rectangle#7519376\">this solution of an analagous question</a>, but the formulas are simplified and avoid singularities. This is python code with the same interface as <code>largest_rotated_rect</code> from the other solution, but giving a bigger area in almost all cases (always the proven optimum):</p>\n<pre><code>def rotatedRectWithMaxArea(w, h, angle):\n  &quot;&quot;&quot;\n  Given a rectangle of size wxh that has been rotated by 'angle' (in\n  radians), computes the width and height of the largest possible\n  axis-aligned rectangle (maximal area) within the rotated rectangle.\n  &quot;&quot;&quot;\n  if w &lt;= 0 or h &lt;= 0:\n    return 0,0\n\n  width_is_longer = w &gt;= h\n  side_long, side_short = (w,h) if width_is_longer else (h,w)\n\n  # since the solutions for angle, -angle and 180-angle are all the same,\n  # if suffices to look at the first quadrant and the absolute values of sin,cos:\n  sin_a, cos_a = abs(math.sin(angle)), abs(math.cos(angle))\n  if side_short &lt;= 2.*sin_a*cos_a*side_long or abs(sin_a-cos_a) &lt; 1e-10:\n    # half constrained case: two crop corners touch the longer side,\n    #   the other two corners are on the mid-line parallel to the longer line\n    x = 0.5*side_short\n    wr,hr = (x/sin_a,x/cos_a) if width_is_longer else (x/cos_a,x/sin_a)\n  else:\n    # fully constrained case: crop touches all 4 sides\n    cos_2a = cos_a*cos_a - sin_a*sin_a\n    wr,hr = (w*cos_a - h*sin_a)/cos_2a, (h*cos_a - w*sin_a)/cos_2a\n\n  return wr,hr\n</code></pre>\n<p>Here is a comparison of the function with the other solution:</p>\n<pre><code>&gt;&gt;&gt; wl,hl = largest_rotated_rect(1500,500,math.radians(20))\n&gt;&gt;&gt; print (wl,hl),', area=',wl*hl\n(828.2888697391496, 230.61639227890998) , area= 191016.990904\n&gt;&gt;&gt; wm,hm = rotatedRectWithMaxArea(1500,500,math.radians(20))\n&gt;&gt;&gt; print (wm,hm),', area=',wm*hm\n(730.9511000407718, 266.044443118978) , area= 194465.478358\n</code></pre>\n<p>With angle <code>angle</code> in <code>[0,pi/2[</code> the bounding box of the rotated image (width <code>w</code>, height <code>h</code>) has these dimensions:</p>\n<ul>\n<li>width <code>w_bb = w*cos_a + h*sin_a</code></li>\n<li>height <code>h_bb = w*sin_a + h*cos_a</code></li>\n</ul>\n<p>If <code>w_r</code>, <code>h_r</code> are the computed optimal width and height of the cropped image, then the insets from the bounding box are:</p>\n<ul>\n<li>in horizontal direction: <code>(w_bb-w_r)/2</code></li>\n<li>in vertical direction: <code>(h_bb-h_r)/2</code></li>\n</ul>\n<p><strong>Proof:</strong></p>\n<p>Looking for the axis aligned rectangle between two parallel lines that has maximal area is an optimization problem with one parameter, e.g. <code>x</code> as in this figure:\n<img src=\"https://i.stack.imgur.com/coemJ.gif\" alt=\"animated parameter\" /></p>\n<p>Let <code>s</code> denote the distance between the two parallel lines (it will turn out to be the shorter side of the rotated rectangle). Then the sides <code>a</code>, <code>b</code> of the sought-after rectangle have a constant ratio with <code>x</code>, <code>s-x</code>, resp., namely x = a sin \u03b1 and (s-x) = b cos \u03b1:</p>\n<p><img src=\"https://i.stack.imgur.com/cqx4e.jpg\" alt=\"enter image description here\" /></p>\n<p>So maximizing the area <code>a*b</code> means maximizing <code>x*(s-x)</code>. Because of &quot;theorem of height&quot; for right-angled triangles we know <code>x*(s-x) = p*q = h*h</code>. Hence the maximal area is reached at <code>x = s-x = s/2</code>, i.e. the two corners E, G between the parallel lines are on the mid-line:</p>\n<p><img src=\"https://i.stack.imgur.com/xW1lc.jpg\" alt=\"enter image description here\" /></p>\n<p>This solution is only valid if this maximal rectangle fits into the rotated rectangle. Therefore the diagonal <code>EG</code> must not be longer than the other side <code>l</code> of the rotated rectangle. Since</p>\n<p>EG = AF + DH = s/2*(cot \u03b1 + tan \u03b1) = s/(2<em>sin \u03b1</em>cos \u03b1) = s/sin 2*\u03b1</p>\n<p>we have the condition s \u2264 l<em>sin 2</em>\u03b1, where s and l are the shorter and longer side of the rotated rectangle.</p>\n<p>In case of s &gt; l<em>sin 2</em>\u03b1 the parameter <code>x</code> must be smaller (than s/2) and  s.t. all corners of the sought-after rectangle are each on a side of the rotated rectangle. This leads to the equation</p>\n<p>x*cot \u03b1 + (s-x)*tan \u03b1 = l</p>\n<p>giving x = sin \u03b1*(l<em>cos \u03b1 - s</em>sin \u03b1)/cos 2*\u03b1. From a = x/sin \u03b1 and b = (s-x)/cos \u03b1 we get the above used formulas.</p>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 59072,
                                "reputation": 92836,
                                "user_id": 176769,
                                "user_type": "registered",
                                "accept_rate": 100,
                                "display_name": "karlphillip"
                            },
                            "edited": false,
                            "score": 4,
                            "creation_date": 1416956083,
                            "post_id": 27137047,
                            "comment_id": 42774579,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/27137047#comment42774579_27137047",
                            "body": "I&#39;m going to give you a 50 rep bounty at the end of a week. Thank you very very much for translating the code, dude. Fantastic!"
                        }
                    ],
                    "owner": {
                        "account_id": 1723907,
                        "reputation": 2396,
                        "user_id": 1579030,
                        "user_type": "registered",
                        "display_name": "Eliezer Bernart"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 15,
                    "last_activity_date": 1619947265,
                    "last_edit_date": 1619947265,
                    "creation_date": 1416950950,
                    "answer_id": 27137047,
                    "question_id": 16702966,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/27137047#27137047",
                    "body": "<p>Congratulations for the great work! I wanted to use your code in OpenCV with the C++ library, so I did the conversion that follows. Maybe this approach could be helpful to other people.</p>\n<pre class=\"lang-cpp prettyprint-override\"><code>#include &lt;iostream&gt;\n#include &lt;opencv.hpp&gt;\n\n#define PI 3.14159265359\n\nusing namespace std;\n\ndouble degree_to_radian(double angle)\n{\n    return angle * PI / 180;\n}\n\ncv::Mat rotate_image (cv::Mat image, double angle)\n{\n    // Rotates an OpenCV 2 image about its centre by the given angle\n    // (in radians). The returned image will be large enough to hold the entire\n    // new image, with a black background\n\n    cv::Size image_size = cv::Size(image.rows, image.cols);\n    cv::Point image_center = cv::Point(image_size.height/2, image_size.width/2);\n\n    // Convert the OpenCV 3x2 matrix to 3x3\n    cv::Mat rot_mat = cv::getRotationMatrix2D(image_center, angle, 1.0);\n    double row[3] = {0.0, 0.0, 1.0};\n    cv::Mat new_row = cv::Mat(1, 3, rot_mat.type(), row);\n    rot_mat.push_back(new_row);\n\n\n    double slice_mat[2][2] = {\n        {rot_mat.col(0).at&lt;double&gt;(0), rot_mat.col(1).at&lt;double&gt;(0)},\n        {rot_mat.col(0).at&lt;double&gt;(1), rot_mat.col(1).at&lt;double&gt;(1)}\n    };\n\n    cv::Mat rot_mat_nontranslate = cv::Mat(2, 2, rot_mat.type(), slice_mat);\n\n    double image_w2 = image_size.width * 0.5;\n    double image_h2 = image_size.height * 0.5;\n\n    // Obtain the rotated coordinates of the image corners\n    std::vector&lt;cv::Mat&gt; rotated_coords;\n\n    double image_dim_d_1[2] = { -image_h2, image_w2 };\n    cv::Mat image_dim = cv::Mat(1, 2, rot_mat.type(), image_dim_d_1);\n    rotated_coords.push_back(cv::Mat(image_dim * rot_mat_nontranslate));\n\n\n    double image_dim_d_2[2] = { image_h2, image_w2 };\n    image_dim = cv::Mat(1, 2, rot_mat.type(), image_dim_d_2);\n    rotated_coords.push_back(cv::Mat(image_dim * rot_mat_nontranslate));\n\n\n    double image_dim_d_3[2] = { -image_h2, -image_w2 };\n    image_dim = cv::Mat(1, 2, rot_mat.type(), image_dim_d_3);\n    rotated_coords.push_back(cv::Mat(image_dim * rot_mat_nontranslate));\n\n\n    double image_dim_d_4[2] = { image_h2, -image_w2 };\n    image_dim = cv::Mat(1, 2, rot_mat.type(), image_dim_d_4);\n    rotated_coords.push_back(cv::Mat(image_dim * rot_mat_nontranslate));\n\n\n    // Find the size of the new image\n    vector&lt;double&gt; x_coords, x_pos, x_neg;\n    for (int i = 0; i &lt; rotated_coords.size(); i++)\n    {\n        double pt = rotated_coords[i].col(0).at&lt;double&gt;(0);\n        x_coords.push_back(pt);\n        if (pt &gt; 0)\n            x_pos.push_back(pt);\n        else\n            x_neg.push_back(pt);\n    }\n\n    vector&lt;double&gt; y_coords, y_pos, y_neg;\n    for (int i = 0; i &lt; rotated_coords.size(); i++)\n    {\n        double pt = rotated_coords[i].col(1).at&lt;double&gt;(0);\n        y_coords.push_back(pt);\n        if (pt &gt; 0)\n            y_pos.push_back(pt);\n        else\n            y_neg.push_back(pt);\n    }\n\n\n    double right_bound = *max_element(x_pos.begin(), x_pos.end());\n    double left_bound = *min_element(x_neg.begin(), x_neg.end());\n    double top_bound = *max_element(y_pos.begin(), y_pos.end());\n    double bottom_bound = *min_element(y_neg.begin(), y_neg.end());\n\n    int new_w = int(abs(right_bound - left_bound));\n    int new_h = int(abs(top_bound - bottom_bound));\n\n    // We require a translation matrix to keep the image centred\n    double trans_mat[3][3] = {\n        {1, 0, int(new_w * 0.5 - image_w2)},\n        {0, 1, int(new_h * 0.5 - image_h2)},\n        {0, 0, 1},\n    };\n\n\n    // Compute the transform for the combined rotation and translation\n    cv::Mat aux_affine_mat = (cv::Mat(3, 3, rot_mat.type(), trans_mat) * rot_mat);\n    cv::Mat affine_mat = cv::Mat(2, 3, rot_mat.type(), NULL);\n    affine_mat.push_back(aux_affine_mat.row(0));\n    affine_mat.push_back(aux_affine_mat.row(1));\n\n    // Apply the transform\n    cv::Mat output;\n    cv::warpAffine(image, output, affine_mat, cv::Size(new_h, new_w), cv::INTER_LINEAR);\n\n    return output;\n}\n\ncv::Size largest_rotated_rect(int h, int w, double angle)\n{\n    // Given a rectangle of size wxh that has been rotated by 'angle' (in\n    // radians), computes the width and height of the largest possible\n    // axis-aligned rectangle within the rotated rectangle.\n\n    // Original JS code by 'Andri' and Magnus Hoff from Stack Overflow\n\n    // Converted to Python by Aaron Snoswell (https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders)\n    // Converted to C++ by Eliezer Bernart\n\n    int quadrant = int(floor(angle/(PI/2))) &amp; 3;\n    double sign_alpha = ((quadrant &amp; 1) == 0) ? angle : PI - angle;\n    double alpha = fmod((fmod(sign_alpha, PI) + PI), PI);\n\n    double bb_w = w * cos(alpha) + h * sin(alpha);\n    double bb_h = w * sin(alpha) + h * cos(alpha);\n\n    double gamma = w &lt; h ? atan2(bb_w, bb_w) : atan2(bb_h, bb_h);\n\n    double delta = PI - alpha - gamma;\n\n    int length = w &lt; h ? h : w;\n\n    double d = length * cos(alpha);\n    double a = d * sin(alpha) / sin(delta);\n    double y = a * cos(gamma);\n    double x = y * tan(gamma);\n\n    return cv::Size(bb_w - 2 * x, bb_h - 2 * y);\n}\n\n// for those interested in the actual optimum - contributed by coproc\n#include &lt;algorithm&gt;\ncv::Size really_largest_rotated_rect(int h, int w, double angle)\n{\n  // Given a rectangle of size wxh that has been rotated by 'angle' (in\n  // radians), computes the width and height of the largest possible\n  // axis-aligned rectangle within the rotated rectangle.\n  if (w &lt;= 0 || h &lt;= 0)\n    return cv::Size(0,0);\n\n  bool width_is_longer = w &gt;= h;\n  int side_long = w, side_short = h;\n  if (!width_is_longer)\n    std::swap(side_long, side_short);\n\n  // since the solutions for angle, -angle and pi-angle are all the same,\n  // it suffices to look at the first quadrant and the absolute values of sin,cos:\n  double sin_a = fabs(sin(angle)), cos_a = fabs(cos(angle));\n  double wr,hr;\n  if (side_short &lt;= 2.*sin_a*cos_a*side_long)\n  {\n    // half constrained case: two crop corners touch the longer side,\n    // the other two corners are on the mid-line parallel to the longer line\n    double x = 0.5*side_short;\n    wr = x/sin_a;\n    hr = x/cos_a;\n    if (!width_is_longer)\n      std::swap(wr,hr);\n  }\n  else\n  { \n    // fully constrained case: crop touches all 4 sides\n    double cos_2a = cos_a*cos_a - sin_a*sin_a;\n    wr = (w*cos_a - h*sin_a)/cos_2a;\n    hr = (h*cos_a - w*sin_a)/cos_2a;\n  }\n\n  return cv::Size(wr,hr);\n}\n\ncv::Mat crop_around_center(cv::Mat image, int height, int width)\n{\n    // Given a OpenCV 2 image, crops it to the given width and height,\n    // around it's centre point\n\n    cv::Size image_size = cv::Size(image.rows, image.cols);\n    cv::Point image_center = cv::Point(int(image_size.height * 0.5), int(image_size.width * 0.5));\n\n    if (width &gt; image_size.width)\n        width = image_size.width;\n\n    if (height &gt; image_size.height)\n        height = image_size.height;\n\n    int x1 = int(image_center.x - width  * 0.5);\n    int x2 = int(image_center.x + width  * 0.5);\n    int y1 = int(image_center.y - height * 0.5);\n    int y2 = int(image_center.y + height * 0.5);\n\n\n    return image(cv::Rect(cv::Point(y1, x1), cv::Point(y2,x2)));\n}\n\nvoid demo(cv::Mat image)\n{\n    // Demos the largest_rotated_rect function\n    int image_height = image.rows;\n    int image_width = image.cols;\n\n    for (float i = 0.0; i &lt; 360.0; i+=0.5)\n    {\n        cv::Mat image_orig = image.clone();\n        cv::Mat image_rotated = rotate_image(image, i);\n\n        cv::Size largest_rect = largest_rotated_rect(image_height, image_width, degree_to_radian(i));\n        // for those who trust math (added by coproc):\n        cv::Size largest_rect2 = really_largest_rotated_rect(image_height, image_width, degree_to_radian(i));\n        cout &lt;&lt; &quot;area1 = &quot; &lt;&lt; largest_rect.height * largest_rect.width &lt;&lt; endl;\n        cout &lt;&lt; &quot;area2 = &quot; &lt;&lt; largest_rect2.height * largest_rect2.width &lt;&lt; endl;\n\n        cv::Mat image_rotated_cropped = crop_around_center(\n                    image_rotated,\n                    largest_rect.height,\n                    largest_rect.width\n                    );\n\n        cv::imshow(&quot;Original Image&quot;, image_orig);\n        cv::imshow(&quot;Rotated Image&quot;, image_rotated);\n        cv::imshow(&quot;Cropped image&quot;, image_rotated_cropped);\n\n        if (char(cv::waitKey(15)) == 'q')\n            break;\n    }\n\n}\n\nint main (int argc, char* argv[])\n{\n    cv::Mat image = cv::imread(argv[1]);\n\n    if (image.empty())\n    {\n        cout &lt;&lt; &quot;&gt; The input image was not found.&quot; &lt;&lt; endl;\n        exit(EXIT_FAILURE);\n    }\n\n    cout &lt;&lt; &quot;Press [s] to begin or restart the demo&quot; &lt;&lt; endl;\n    cout &lt;&lt; &quot;Press [q] to quit&quot; &lt;&lt; endl;\n\n    while (true)\n    {\n        cv::imshow(&quot;Original Image&quot;, image);\n        char opt = char(cv::waitKey(0));\n        switch (opt) {\n        case 's':\n            demo(image);\n            break;\n        case 'q':\n            return EXIT_SUCCESS;\n        default:\n            break;\n        }\n    }\n\n    return EXIT_SUCCESS;\n}\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 1911982,
                                "reputation": 6157,
                                "user_id": 1725562,
                                "user_type": "registered",
                                "accept_rate": 89,
                                "display_name": "coproc"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1514472285,
                            "post_id": 47960664,
                            "comment_id": 82987204,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/47960664#comment82987204_47960664",
                            "body": "You mean the case <code>sin(a) = cos(a)</code>? Then indeed <code>cos(2a)</code> would be zero (because of <code>a = pi&#47;4</code>), which is a singularity of the else-branch. With exact calculations we would never get into the else-branch, because <code>2*sin(a)*cos(a)</code> equals <code>1</code> for <code>a = pi&#47;4</code> and <code>side_short &lt;= side_long</code> holds by definition. But because of rounding errors the <code>if</code>-condition could still be false for <code>side_short ~= side_long</code> and <code>a ~= pi&#47;4</code>. So I have extended the condition by <code>or abs(sin_a - cos_a) &lt; 1e-10</code> to stay away from that singularity. Thank you for your hint!"
                        }
                    ],
                    "owner": {
                        "account_id": 2115171,
                        "reputation": 111,
                        "user_id": 1879660,
                        "user_type": "registered",
                        "display_name": "Rob Rutten"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 1,
                    "last_activity_date": 1514193878,
                    "last_edit_date": 1514193878,
                    "creation_date": 1514119171,
                    "answer_id": 47960664,
                    "question_id": 16702966,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/47960664#47960664",
                    "body": "<p>Correction to the most favored solution above given by Coprox on May 27 2013: when cosa = cosb infinity results in the last two lines.  Solve by adding \"or cosa equal cosb\" in the preceding if selector.</p>\n\n<p>Addition: if you do not know the original non-rotated nx and ny but only have the rotated frame (or image) then find the box just containing this (I do this by removing blank = monochrome borders) and first run the program reversely on its size to find nx and ny.  If the image was rotated into a too small frame so that it was cut along the sides (into octagonal shape) I first find the x and y extensions to the full containment frame. \nHowever, this also does not work for angles around 45 degrees where the result gets square instead of maintaining the non-rotated aspect ratio.  For me this routine only works properly up to 30 degrees.</p>\n\n<p>Still a great routine!  It solved my nagging problem in astronomical image alignment. </p>\n"
                },
                {
                    "owner": {
                        "account_id": 2376348,
                        "reputation": 340,
                        "user_id": 2079580,
                        "user_type": "registered",
                        "display_name": "Naofumi"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 6,
                    "last_activity_date": 1515091039,
                    "creation_date": 1515091039,
                    "answer_id": 48101555,
                    "question_id": 16702966,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/48101555#48101555",
                    "body": "<p>Inspired by Coprox's amazing work I wrote a function that forms together with Coprox's code a complete solution (so it can be used by copying &amp; pasting with no-brainer). The rotate_max_area function below simply returns a rotated image without black boundary.</p>\n\n<pre><code>def rotate_bound(image, angle):\n    # CREDIT: https://www.pyimagesearch.com/2017/01/02/rotate-images-correctly-with-opencv-and-python/\n    (h, w) = image.shape[:2]\n    (cX, cY) = (w // 2, h // 2)\n    M = cv2.getRotationMatrix2D((cX, cY), -angle, 1.0)\n    cos = np.abs(M[0, 0])\n    sin = np.abs(M[0, 1])\n    nW = int((h * sin) + (w * cos))\n    nH = int((h * cos) + (w * sin))\n    M[0, 2] += (nW / 2) - cX\n    M[1, 2] += (nH / 2) - cY\n    return cv2.warpAffine(image, M, (nW, nH))\n\n\ndef rotate_max_area(image, angle):\n    \"\"\" image: cv2 image matrix object\n        angle: in degree\n    \"\"\"\n    wr, hr = rotatedRectWithMaxArea(image.shape[1], image.shape[0],\n                                    math.radians(angle))\n    rotated = rotate_bound(image, angle)\n    h, w, _ = rotated.shape\n    y1 = h//2 - int(hr/2)\n    y2 = y1 + int(hr)\n    x1 = w//2 - int(wr/2)\n    x2 = x1 + int(wr)\n    return rotated[y1:y2, x1:x2]\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 1331106,
                        "reputation": 4356,
                        "user_id": 1275014,
                        "user_type": "registered",
                        "accept_rate": 50,
                        "display_name": "Josh Bernfeld"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 2,
                    "last_activity_date": 1517268688,
                    "creation_date": 1517268688,
                    "answer_id": 48511694,
                    "question_id": 16702966,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/48511694#48511694",
                    "body": "<p><strong>Swift solution</strong></p>\n\n<p>Thanks to coproc for his great solution. Here is the code in swift</p>\n\n<pre><code>// Given a rectangle of size.width x size.height that has been rotated by 'angle' (in\n// radians), computes the width and height of the largest possible\n// axis-aligned rectangle (maximal area) within the rotated rectangle.\nfunc rotatedRectWithMaxArea(size: CGSize, angle: CGFloat) -&gt; CGSize {\n    let w = size.width\n    let h = size.height\n\n    if(w &lt;= 0 || h &lt;= 0) {\n        return CGSize.zero\n    }\n\n    let widthIsLonger = w &gt;= h\n    let (sideLong, sideShort) = widthIsLonger ? (w, h) : (w, h)\n\n    // since the solutions for angle, -angle and 180-angle are all the same,\n    // if suffices to look at the first quadrant and the absolute values of sin,cos:\n    let (sinA, cosA) = (sin(angle), cos(angle))\n    if(sideShort &lt;= 2*sinA*cosA*sideLong || abs(sinA-cosA) &lt; 1e-10) {\n        // half constrained case: two crop corners touch the longer side,\n        // the other two corners are on the mid-line parallel to the longer line\n        let x = 0.5*sideShort\n        let (wr, hr) = widthIsLonger ? (x/sinA, x/cosA) : (x/cosA, x/sinA)\n        return CGSize(width: wr, height: hr)\n    } else {\n        // fully constrained case: crop touches all 4 sides\n        let cos2A = cosA*cosA - sinA*sinA\n        let (wr, hr) = ((w*cosA - h*sinA)/cos2A, (h*cosA - w*sinA)/cos2A)\n        return CGSize(width: wr, height: hr)\n    }\n}\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 176642,
                                "reputation": 6141,
                                "user_id": 885287,
                                "user_type": "registered",
                                "accept_rate": 81,
                                "display_name": "aaronsnoswell"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1529323080,
                            "post_id": 50906602,
                            "comment_id": 88817786,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/50906602#comment88817786_50906602",
                            "body": "This is gold! I can&#39;t believe there&#39;s actually a tensorflow port of this now :P Thanks for sharing @ByungSoo-Ko!"
                        }
                    ],
                    "owner": {
                        "account_id": 9100428,
                        "reputation": 513,
                        "user_id": 6772741,
                        "user_type": "registered",
                        "display_name": "ByungSoo Ko"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 7,
                    "last_activity_date": 1529314866,
                    "creation_date": 1529314866,
                    "answer_id": 50906602,
                    "question_id": 16702966,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/50906602#50906602",
                    "body": "<h2>Rotation and cropping in TensorFlow</h2>\n\n<p>I personally needed this function in TensorFlow and thanks for Aaron Snoswell, I could implement this function.</p>\n\n<pre><code>def _rotate_and_crop(image, output_height, output_width, rotation_degree, do_crop):\n    \"\"\"Rotate the given image with the given rotation degree and crop for the black edges if necessary\n    Args:\n        image: A `Tensor` representing an image of arbitrary size.\n        output_height: The height of the image after preprocessing.\n        output_width: The width of the image after preprocessing.\n        rotation_degree: The degree of rotation on the image.\n        do_crop: Do cropping if it is True.\n    Returns:\n        A rotated image.\n    \"\"\"\n\n    # Rotate the given image with the given rotation degree\n    if rotation_degree != 0:\n        image = tf.contrib.image.rotate(image, math.radians(rotation_degree), interpolation='BILINEAR')\n\n        # Center crop to ommit black noise on the edges\n        if do_crop == True:\n            lrr_width, lrr_height = _largest_rotated_rect(output_height, output_width, math.radians(rotation_degree))\n            resized_image = tf.image.central_crop(image, float(lrr_height)/output_height)    \n            image = tf.image.resize_images(resized_image, [output_height, output_width], method=tf.image.ResizeMethod.BILINEAR, align_corners=False)\n\n    return image\n\ndef _largest_rotated_rect(w, h, angle):\n    \"\"\"\n    Given a rectangle of size wxh that has been rotated by 'angle' (in\n    radians), computes the width and height of the largest possible\n    axis-aligned rectangle within the rotated rectangle.\n    Original JS code by 'Andri' and Magnus Hoff from Stack Overflow\n    Converted to Python by Aaron Snoswell\n    Source: http://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders\n    \"\"\"\n\n    quadrant = int(math.floor(angle / (math.pi / 2))) &amp; 3\n    sign_alpha = angle if ((quadrant &amp; 1) == 0) else math.pi - angle\n    alpha = (sign_alpha % math.pi + math.pi) % math.pi\n\n    bb_w = w * math.cos(alpha) + h * math.sin(alpha)\n    bb_h = w * math.sin(alpha) + h * math.cos(alpha)\n\n    gamma = math.atan2(bb_w, bb_w) if (w &lt; h) else math.atan2(bb_w, bb_w)\n\n    delta = math.pi - alpha - gamma\n\n    length = h if (w &lt; h) else w\n\n    d = length * math.cos(alpha)\n    a = d * math.sin(alpha) / math.sin(delta)\n\n    y = a * math.cos(gamma)\n    x = y * math.tan(gamma)\n\n    return (\n        bb_w - 2 * x,\n        bb_h - 2 * y\n    )\n</code></pre>\n\n<p>If you need further implementation of example and visualization in TensorFlow, you can use <a href=\"https://github.com/kobiso/Image-Rotation-and-Cropping-tensorflow\" rel=\"noreferrer\">this repository</a>.\nI hope this could be helpful to other people.</p>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 1540311,
                                "reputation": 683,
                                "user_id": 1435148,
                                "user_type": "registered",
                                "accept_rate": 50,
                                "display_name": "Pablo Gonzalez"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1542178620,
                            "post_id": 52505929,
                            "comment_id": 93470228,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/52505929#comment93470228_52505929",
                            "body": "Nice piece of code.  I would like to create a new solution using your code as benchmark (since it is the lastest version of the algorithm) but I cannot find exactly where it is. Can you please point me out in which file of your github project is included this function? Thanks in advance."
                        }
                    ],
                    "owner": {
                        "account_id": 12803316,
                        "reputation": 51,
                        "user_id": 10240207,
                        "user_type": "registered",
                        "display_name": "Artemi Krymski"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 5,
                    "last_activity_date": 1537906013,
                    "creation_date": 1537906013,
                    "answer_id": 52505929,
                    "question_id": 16702966,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/52505929#52505929",
                    "body": "<p>A small update for brevity that makes use of the excellent <a href=\"https://github.com/jrosebr1/imutils\" rel=\"noreferrer\">imutils</a> library.</p>\n\n<pre><code>def rotated_rect(w, h, angle):\n    \"\"\"\n    Given a rectangle of size wxh that has been rotated by 'angle' (in\n    radians), computes the width and height of the largest possible\n    axis-aligned rectangle within the rotated rectangle.\n\n    Original JS code by 'Andri' and Magnus Hoff from Stack Overflow\n\n    Converted to Python by Aaron Snoswell\n    \"\"\"\n    angle = math.radians(angle)\n    quadrant = int(math.floor(angle / (math.pi / 2))) &amp; 3\n    sign_alpha = angle if ((quadrant &amp; 1) == 0) else math.pi - angle\n    alpha = (sign_alpha % math.pi + math.pi) % math.pi\n\n    bb_w = w * math.cos(alpha) + h * math.sin(alpha)\n    bb_h = w * math.sin(alpha) + h * math.cos(alpha)\n\n    gamma = math.atan2(bb_w, bb_w) if (w &lt; h) else math.atan2(bb_w, bb_w)\n\n    delta = math.pi - alpha - gamma\n\n    length = h if (w &lt; h) else w\n\n    d = length * math.cos(alpha)\n    a = d * math.sin(alpha) / math.sin(delta)\n\n    y = a * math.cos(gamma)\n    x = y * math.tan(gamma)\n\n    return (bb_w - 2 * x, bb_h - 2 * y)\n\ndef crop(img, w, h):\n    x, y = int(img.shape[1] * .5), int(img.shape[0] * .5)\n\n    return img[\n        int(np.ceil(y - h * .5)) : int(np.floor(y + h * .5)),\n        int(np.ceil(x - w * .5)) : int(np.floor(x + h * .5))\n    ]\n\ndef rotate(img, angle):\n    # rotate, crop and return original size\n    (h, w) = img.shape[:2]\n    img = imutils.rotate_bound(img, angle)\n    img = crop(img, *rotated_rect(w, h, angle))\n    img = cv2.resize(img,(w,h),interpolation=cv2.INTER_AREA)\n    return img\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 6608124,
                        "reputation": 337,
                        "user_id": 5104314,
                        "user_type": "registered",
                        "accept_rate": 100,
                        "display_name": "Facorazza"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 2,
                    "last_activity_date": 1562583988,
                    "creation_date": 1562583988,
                    "answer_id": 56933590,
                    "question_id": 16702966,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/56933590#56933590",
                    "body": "<p>Perhaps an even simplier solution would be:</p>\n\n<pre><code>def crop_image(image, angle):\n    h, w = image.shape\n    tan_a = abs(np.tan(angle * np.pi / 180))\n    b = int(tan_a / (1 - tan_a ** 2) * (h - w * tan_a))\n    d = int(tan_a / (1 - tan_a ** 2) * (w - h * tan_a))\n    return image[d:h - d, b:w - b]\n</code></pre>\n\n<p>Instead of calculating the height and width of the rotated rectangle like many have done, it is sufficient to find the height of the black triangles that form when rotating an image.</p>\n"
                },
                {
                    "owner": {
                        "account_id": 16146002,
                        "reputation": 23,
                        "user_id": 11655734,
                        "user_type": "registered",
                        "display_name": "madan maram"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1622097082,
                    "creation_date": 1622097082,
                    "answer_id": 67716806,
                    "question_id": 16702966,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/67716806#67716806",
                    "body": "<blockquote>\n<p><strong>Rotate images in correct order</strong></p>\n</blockquote>\n<pre><code> import cv2\n import pytesseract\n import urllib\n import numpy as np\n import re\n import imutils #added\n import PIL\n\n image = cv2.imread('my_pdf_madan_m/page_1.jpg')\n\n gray = cv2.cvtColor(image, cv2.COLOR_BGR2GRAY)\n gray = cv2.bitwise_not(gray)\n\n rot_data = pytesseract.image_to_osd(image);\n print(&quot;[OSD] &quot;+rot_data)\n rot = re.search('(?&lt;=Rotate: )\\d+', \n rot_data).group(0)\n\n angle = float(rot)\n\n # rotate the image to deskew it\n rotated = imutils.rotate_bound(image, angle) #added\n\n\n #  TODO: Rotated image can be saved here\n print(pytesseract.image_to_osd(rotated));\n\n # Run tesseract OCR on image\n text = pytesseract.image_to_string(rotated, \n lang='eng', config=&quot;--psm 6&quot;)\n print(text)\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 17659537,
                        "reputation": 1,
                        "user_id": 12818281,
                        "user_type": "registered",
                        "display_name": "jmm"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1630585447,
                    "last_edit_date": 1630585447,
                    "creation_date": 1630584784,
                    "answer_id": 69030064,
                    "question_id": 16702966,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/69030064#69030064",
                    "body": "<p>Recently implemented a solution for Pytorch. It might come in handy. Could potentially be used with the 'Random Rotation Transform' as well. Just need to read the particular angle used by the transform and then just use it with PyTorch transforms. Function simply takes in a batch of images and does the random rotation with cropping.</p>\n<pre><code>import torchvision.transforms as transforms\nimport math\n\ndef _largest_rotated_rect(w, h, angle):\n&quot;&quot;&quot;\nGiven a rectangle of size wxh that has been rotated by 'angle' (in\nradians), computes the width and height of the largest possible\naxis-aligned rectangle within the rotated rectangle.\nOriginal JS code by 'Andri' and Magnus Hoff from Stack Overflow\nConverted to Python by Aaron Snoswell\nSource: http://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders\n&quot;&quot;&quot;\n\nquadrant = int(math.floor(angle / (math.pi / 2))) &amp; 3\nsign_alpha = angle if ((quadrant &amp; 1) == 0) else math.pi - angle\nalpha = (sign_alpha % math.pi + math.pi) % math.pi\n\nbb_w = w * math.cos(alpha) + h * math.sin(alpha)\nbb_h = w * math.sin(alpha) + h * math.cos(alpha)\n\ngamma = math.atan2(bb_w, bb_w) if (w &lt; h) else math.atan2(bb_w, bb_w)\n\ndelta = math.pi - alpha - gamma\n\nlength = h if (w &lt; h) else w\n\nd = length * math.cos(alpha)\na = d * math.sin(alpha) / math.sin(delta)\n\ny = a * math.cos(gamma)\nx = y * math.tan(gamma)\n\nreturn (\n    bb_w - 2 * x,\n    bb_h - 2 * y\n)\n\n\ndef _rotate_and_crop(image, output_height=32, output_width=32):\n&quot;&quot;&quot;Rotate the given image with the given rotation degree and crop for the black edges if necessary. For my case, image sizes are 32x32.\nArgs:\n    image: A Batch of Tensors- normally from a dataloader.\n    output_height: The height of the image after preprocessing.\n    output_width: The width of the image after preprocessing.\nReturns:\n    A rotated image.\n&quot;&quot;&quot;\n\n# Rotate the given image with the given rotation degree\nrotation_transform = transforms.RandomRotation((0, 360))\nangle_rot = rotation_transform.angle_rot #you will have to read it from the pytorch library\n\nlrr_width, lrr_height = _largest_rotated_rect(output_height, output_width, math.radians(angle_rot))\ncroped_image = transforms.CenterCrop((lrr_height, lrr_width))\nresize_transform = transforms.Resize(size=(output_height, output_width))\n\ntransform = transforms.Compose([rotation_transform, croped_image, resize_transform, transforms.RandomHorizontalFlip(),\n                                               transforms.ToTensor(),\n                                               ])\n\nimage = transform(image)\n\nreturn image\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 3761799,
                                "reputation": 1401,
                                "user_id": 3126516,
                                "user_type": "registered",
                                "display_name": "lauri108"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1645200448,
                            "post_id": 71171784,
                            "comment_id": 125815795,
                            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/71171784#comment125815795_71171784",
                            "body": "You can format your code snippets by putting them between triple quotes: <code>code</code>"
                        }
                    ],
                    "owner": {
                        "account_id": 24298969,
                        "reputation": 1,
                        "user_id": 18242760,
                        "user_type": "unregistered",
                        "display_name": "user18242760"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1645625431,
                    "last_edit_date": 1645625431,
                    "creation_date": 1645179369,
                    "answer_id": 71171784,
                    "question_id": 16702966,
                    "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders/71171784#71171784",
                    "body": "<p>By doing the calculations by hand and looking at the <a href=\"https://stackoverflow.com/questions/5789239/calculate-largest-rectangle-in-a-rotated-rectangle#7519376\">original post</a>, I found a minor typo on the gamma calculations. It should actually be:</p>\n<p><code>gamma = math.atan2(bb_w, bb_h) if (w &lt; h) else math.atan2(bb_h, bb_w)</code></p>\n"
                }
            ],
            "owner": {
                "account_id": 176642,
                "reputation": 6141,
                "user_id": 885287,
                "user_type": "registered",
                "accept_rate": 81,
                "display_name": "aaronsnoswell"
            },
            "comment_count": 11,
            "is_answered": true,
            "accepted_answer_id": 16770343,
            "answer_count": 12,
            "score": 81,
            "last_activity_date": 1645625431,
            "creation_date": 1369263796,
            "last_edit_date": 1495540455,
            "question_id": 16702966,
            "link": "https://stackoverflow.com/questions/16702966/rotate-image-and-crop-out-black-borders",
            "title": "Rotate image and crop out black borders",
            "body": "<p>My application: I am trying to rotate an image (using OpenCV and Python)</p>\n\n<p><img src=\"https://i.stack.imgur.com/KWoeo.jpg\" alt=\"Rotating Images\"></p>\n\n<p>At the moment I have developed the below code which rotates an input image, padding it with black borders, giving me A. What I want is B - the largest possible area crop window within the rotated image. I call this the axis-aligned boundED box.</p>\n\n<p>This is essentially the same as <a href=\"https://stackoverflow.com/questions/16255037/rotate-and-crop\">Rotate and crop</a>, however I cannot get the answer on that question to work. Additionally, that answer is apparently only valid for square images. My images are rectangular.</p>\n\n<p>Code to give A:</p>\n\n<pre><code>import cv2\nimport numpy as np\n\n\ndef getTranslationMatrix2d(dx, dy):\n    \"\"\"\n    Returns a numpy affine transformation matrix for a 2D translation of\n    (dx, dy)\n    \"\"\"\n    return np.matrix([[1, 0, dx], [0, 1, dy], [0, 0, 1]])\n\n\ndef rotateImage(image, angle):\n    \"\"\"\n    Rotates the given image about it's centre\n    \"\"\"\n\n    image_size = (image.shape[1], image.shape[0])\n    image_center = tuple(np.array(image_size) / 2)\n\n    rot_mat = np.vstack([cv2.getRotationMatrix2D(image_center, angle, 1.0), [0, 0, 1]])\n    trans_mat = np.identity(3)\n\n    w2 = image_size[0] * 0.5\n    h2 = image_size[1] * 0.5\n\n    rot_mat_notranslate = np.matrix(rot_mat[0:2, 0:2])\n\n    tl = (np.array([-w2, h2]) * rot_mat_notranslate).A[0]\n    tr = (np.array([w2, h2]) * rot_mat_notranslate).A[0]\n    bl = (np.array([-w2, -h2]) * rot_mat_notranslate).A[0]\n    br = (np.array([w2, -h2]) * rot_mat_notranslate).A[0]\n\n    x_coords = [pt[0] for pt in [tl, tr, bl, br]]\n    x_pos = [x for x in x_coords if x &gt; 0]\n    x_neg = [x for x in x_coords if x &lt; 0]\n\n    y_coords = [pt[1] for pt in [tl, tr, bl, br]]\n    y_pos = [y for y in y_coords if y &gt; 0]\n    y_neg = [y for y in y_coords if y &lt; 0]\n\n    right_bound = max(x_pos)\n    left_bound = min(x_neg)\n    top_bound = max(y_pos)\n    bot_bound = min(y_neg)\n\n    new_w = int(abs(right_bound - left_bound))\n    new_h = int(abs(top_bound - bot_bound))\n    new_image_size = (new_w, new_h)\n\n    new_midx = new_w * 0.5\n    new_midy = new_h * 0.5\n\n    dx = int(new_midx - w2)\n    dy = int(new_midy - h2)\n\n    trans_mat = getTranslationMatrix2d(dx, dy)\n    affine_mat = (np.matrix(trans_mat) * np.matrix(rot_mat))[0:2, :]\n    result = cv2.warpAffine(image, affine_mat, new_image_size, flags=cv2.INTER_LINEAR)\n\n    return result\n</code></pre>\n"
        }
    ],
    "has_more": false,
    "quota_max": 10000,
    "quota_remaining": 7663
}
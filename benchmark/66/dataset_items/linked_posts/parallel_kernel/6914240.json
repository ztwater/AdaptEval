{
    "items": [
        {
            "tags": [
                "python",
                "multiprocessing"
            ],
            "comments": [
                {
                    "owner": {
                        "account_id": 152622,
                        "reputation": 494215,
                        "user_id": 367273,
                        "user_type": "registered",
                        "accept_rate": 96,
                        "display_name": "NPE"
                    },
                    "edited": false,
                    "score": 1,
                    "creation_date": 1312298178,
                    "post_id": 6914240,
                    "comment_id": 8235247,
                    "link": "https://stackoverflow.com/questions/6914240/multiprocessing-pool-seems-to-work-in-windows-but-not-in-ubuntu#comment8235247_6914240",
                    "body": "This seems to work on my 64-bit Ubuntu box with Enthought&#39;s Python 2.7.1 [EPD 7.0-2 (64-bit)]. I&#39;ve run your code a number of times and can&#39;t seem to get it to stall."
                },
                {
                    "owner": {
                        "account_id": 467510,
                        "reputation": 537,
                        "user_id": 872946,
                        "user_type": "registered",
                        "accept_rate": 80,
                        "display_name": "matiasq"
                    },
                    "reply_to_user": {
                        "account_id": 152622,
                        "reputation": 494215,
                        "user_id": 367273,
                        "user_type": "registered",
                        "accept_rate": 96,
                        "display_name": "NPE"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1312299158,
                    "post_id": 6914240,
                    "comment_id": 8235559,
                    "link": "https://stackoverflow.com/questions/6914240/multiprocessing-pool-seems-to-work-in-windows-but-not-in-ubuntu#comment8235559_6914240",
                    "body": "Thank you. I really wonder what distinguishes my machine from the rest :("
                },
                {
                    "owner": {
                        "account_id": 1589784,
                        "reputation": 6089,
                        "user_id": 1601580,
                        "user_type": "registered",
                        "accept_rate": 47,
                        "display_name": "Charlie Parker"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1491361900,
                    "post_id": 6914240,
                    "comment_id": 73512912,
                    "link": "https://stackoverflow.com/questions/6914240/multiprocessing-pool-seems-to-work-in-windows-but-not-in-ubuntu#comment73512912_6914240",
                    "body": "so did this have nothing to do with random number generation? I am confused, from reading online it seems that the expect behaviour is that each process should behave the exact same way, so one has to reset the random seed?"
                }
            ],
            "answers": [
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 467510,
                                "reputation": 537,
                                "user_id": 872946,
                                "user_type": "registered",
                                "accept_rate": 80,
                                "display_name": "matiasq"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1312298983,
                            "post_id": 6914470,
                            "comment_id": 8235507,
                            "link": "https://stackoverflow.com/questions/6914240/multiprocessing-pool-seems-to-work-in-windows-but-not-in-ubuntu/6914470#comment8235507_6914470",
                            "body": "Thank you for your help on the second question. Regarding the first question, do you think that the IDE one uses may cause problems? I know it sounds stupid but that is about the only difference in our settings that I can come up with."
                        },
                        {
                            "owner": {
                                "account_id": 152622,
                                "reputation": 494215,
                                "user_id": 367273,
                                "user_type": "registered",
                                "accept_rate": 96,
                                "display_name": "NPE"
                            },
                            "reply_to_user": {
                                "account_id": 467510,
                                "reputation": 537,
                                "user_id": 872946,
                                "user_type": "registered",
                                "accept_rate": 80,
                                "display_name": "matiasq"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1312299183,
                            "post_id": 6914470,
                            "comment_id": 8235568,
                            "link": "https://stackoverflow.com/questions/6914240/multiprocessing-pool-seems-to-work-in-windows-but-not-in-ubuntu/6914470#comment8235568_6914470",
                            "body": "@matiasq: That&#39;s very easy to test. Just run your code from the command line to see if that helps: <code>&#47;path&#47;to&#47;epd&#47;bin&#47;python script.py</code>, where <code>&#47;path&#47;to&#47;epd&#47;bin</code> points to the Python binary and <code>script.py</code> is the name of your script."
                        },
                        {
                            "owner": {
                                "account_id": 467510,
                                "reputation": 537,
                                "user_id": 872946,
                                "user_type": "registered",
                                "accept_rate": 80,
                                "display_name": "matiasq"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1312300005,
                            "post_id": 6914470,
                            "comment_id": 8235847,
                            "link": "https://stackoverflow.com/questions/6914240/multiprocessing-pool-seems-to-work-in-windows-but-not-in-ubuntu/6914470#comment8235847_6914470",
                            "body": "Of course, I am too tired by now :). Thank you. This was exactly it. It works if I run it outside Wingware. It am surprised that a simple editor can do such harm."
                        },
                        {
                            "owner": {
                                "account_id": 1589784,
                                "reputation": 6089,
                                "user_id": 1601580,
                                "user_type": "registered",
                                "accept_rate": 47,
                                "display_name": "Charlie Parker"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1491361930,
                            "post_id": 6914470,
                            "comment_id": 73512917,
                            "link": "https://stackoverflow.com/questions/6914240/multiprocessing-pool-seems-to-work-in-windows-but-not-in-ubuntu/6914470#comment73512917_6914470",
                            "body": "Is there no way to set the random number for every process that might use random numbers? Say one uses the module random, numpy, scipy, tensorflow and who knows what else. Is the only way to make sure the process has a different random seed to go through each of these and manually set the state?"
                        }
                    ],
                    "owner": {
                        "account_id": 152622,
                        "reputation": 494215,
                        "user_id": 367273,
                        "user_type": "registered",
                        "accept_rate": 96,
                        "display_name": "NPE"
                    },
                    "comment_count": 4,
                    "is_accepted": false,
                    "score": 8,
                    "last_activity_date": 1312300879,
                    "last_edit_date": 1312300879,
                    "creation_date": 1312298665,
                    "answer_id": 6914470,
                    "question_id": 6914240,
                    "link": "https://stackoverflow.com/questions/6914240/multiprocessing-pool-seems-to-work-in-windows-but-not-in-ubuntu/6914470#6914470",
                    "body": "<p>I don't have a solution for your first problem. In fact, I can run your code repeatedly without fail on my 64-bit Ubuntu box with Enthought's Python 2.7.1 [EPD 7.0-2 (64-bit)]. <strong>edit</strong>: It turns out the problem was being caused by your IDE (Wingware). The obvious workaround is to run the script from outside the IDE.</p>\n\n<p>As to the second question, what happens is that on Unix every worker process inherits the same state of the random number generator from the parent process. This is why they generate identical pseudo-random sequences. All you have to do to fix this is call <code>scipy.random.seed</code> at the top of <code>testfunc</code>:</p>\n\n<pre><code>def testfunc(x0, N):\n    sp.random.seed()\n    print 'working with x0 = %s' % x0\n    ...\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 1589784,
                                "reputation": 6089,
                                "user_id": 1601580,
                                "user_type": "registered",
                                "accept_rate": 47,
                                "display_name": "Charlie Parker"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1491361896,
                            "post_id": 6916361,
                            "comment_id": 73512909,
                            "link": "https://stackoverflow.com/questions/6914240/multiprocessing-pool-seems-to-work-in-windows-but-not-in-ubuntu/6916361#comment73512909_6916361",
                            "body": "so did this have nothing to do with random number generation? I am confused, from reading online it seems that the expect behaviour is that each process should behave the exact same way, so one has to reset the random seed?"
                        }
                    ],
                    "owner": {
                        "account_id": 734536,
                        "reputation": 126,
                        "user_id": 698685,
                        "user_type": "unregistered",
                        "display_name": "Stephan Deibel"
                    },
                    "comment_count": 1,
                    "is_accepted": true,
                    "score": 1,
                    "last_activity_date": 1315515013,
                    "last_edit_date": 1315515013,
                    "creation_date": 1312307565,
                    "answer_id": 6916361,
                    "question_id": 6914240,
                    "link": "https://stackoverflow.com/questions/6914240/multiprocessing-pool-seems-to-work-in-windows-but-not-in-ubuntu/6916361#6916361",
                    "body": "<p><strong>Update:</strong> Turns out this had nothing to do with matplotlib or the backends but rather with a bug associated with multiprocessing in general.  We've fixed this for Wing version 4.0.4+.  The work-around is not to set breakpoints in the code that is executed in the sub-processes.</p>\n\n<p>It seems to be Wing IDE's matplotlib support for the Tkinter backend interacting badly with multiprocessing.  When I try this example it crashes in TCL/Tk code.  I suspect the person working on Windows was using a different matplotlib backend.</p>\n\n<p>Turning off the \"matplotlib event loop support\" in Project Properties under the Extensions tab seems to work around it.</p>\n\n<p>Or, adding the following seems to fix it for me when the \"matplotlib event loop support\" is turned on.</p>\n\n<p>import matplotlib\nmatplotlib.use('WXAgg')</p>\n\n<p>This will only work if you have the WXAgg backend.  Other backends supported by Wing IDE (in such a way that plots remain interactive even if the debug process is paused) are  GTKAgg and Qt4Agg but I didn't try those yet.</p>\n\n<p>I'll see if I can find and fix the bug.  I suspect we need to disable our event loop support when the process ID changes.  Thanks for reporting this.</p>\n"
                }
            ],
            "owner": {
                "account_id": 467510,
                "reputation": 537,
                "user_id": 872946,
                "user_type": "registered",
                "accept_rate": 80,
                "display_name": "matiasq"
            },
            "comment_count": 3,
            "is_answered": true,
            "accepted_answer_id": 6916361,
            "answer_count": 2,
            "score": 5,
            "last_activity_date": 1315515013,
            "creation_date": 1312297614,
            "last_edit_date": 1495539998,
            "question_id": 6914240,
            "link": "https://stackoverflow.com/questions/6914240/multiprocessing-pool-seems-to-work-in-windows-but-not-in-ubuntu",
            "title": "multiprocessing.Pool seems to work in Windows but not in ubuntu?",
            "body": "<p>SOLVED: The problem was Wingware Python IDE. I guess the natural question now is how it is possible and how this could be fixed.</p>\n\n<p>I asked a question yesterday ( <a href=\"https://stackoverflow.com/questions/6900244/problem-with-multiprocessing-pool-in-python\">Problem with multiprocessing.Pool in Python</a> ) and this question is almost the same but I have figured out that it seems to work on a Windows computer and not in my ubuntu. At the end of this post I will post a slightly different version of the code that does the same thing.</p>\n\n<p>Short summary of my problem: When using multiprocessing.Pool in Python I am not always able to get the amount of workers that I am asking for. When this happens, the program just stalls.</p>\n\n<p>I have been working for a solution all day, and then I came to think about Noahs' comment on my previous question. He said that it worked on his machine so I gave the code to my colleague who runs a Windows machine with Enthoughts 64-bit Python 2.7.1 distribution. I have the same with the big difference that mine runs on ubuntu. I also mention that we both have Wingware Python IDE, but I doubt that this is of any importance? </p>\n\n<p>There are two problems with my code that don't arise when my colleague runs the code on his machine.</p>\n\n<ol>\n<li><p>I am not always able to get the four workers I am asking for (Although my machine has 12 workers). When this happens, the process just stalls and does not continue. No exception or Error is raised.</p></li>\n<li><p>When I am able to get the four workers I ask for (which happens approximately 1 out 5 times or so), the figures that are produced (plain random numbers) are EXACTLY the same for all four pictures. This is not the case for my colleague.</p></li>\n</ol>\n\n<p>Something is very fishy and I am very thankful for any kind of help you guys can offer. </p>\n\n<p>The code:</p>\n\n<pre><code>import multiprocessing as mp\nimport scipy as sp\nimport scipy.stats as spstat\nimport pylab\n\ndef testfunc(x0, N):\n    print 'working with x0 = %s' % x0\n    x = [x0]\n    for i in xrange(1,N):\n        x.append(spstat.norm.rvs(size = 1)) # stupid appending to make it slower\n        if i % 10000 == 0:\n            print 'x0 = %s, i = %s' % (x0, i)\n    return sp.array(x)\n\ndef testfuncParallel(fargs):\n    return testfunc(*fargs)\n\n\n# Define Number of tasks.\nnTasks = 4\nN = 100000\n\nif __name__ == '__main__':\n\n    \"\"\"\n    Try number 1. Using multiprocessing.Pool together with Pool.map_async\n    \"\"\"\n    pool = mp.Pool(processes = nTasks) # I have 12 threads (six cores) available so I am suprised that it does not get access to nTasks = 4 amount of workers\n\n    # Define tasks:\n    tasks = [(x, n) for x, n in enumerate(nTasks*[N])] # nTasks different tasks\n\n    # Compute parallel: async - asynchronically, i.e. not necessary in order.\n    result = pool.map_async(testfuncParallel, tasks)\n\n    pool.close() # These are needed if map_async is used\n    pool.join()\n\n    # Get results:\n    sim = sp.zeros((N, nTasks)) \n\n    for nn, res in enumerate(result.get()):    \n        sim[:, nn] = res\n\n    pylab.figure()\n    for i in xrange(nTasks):\n        pylab.subplot(nTasks,1, i + 1)\n        pylab.plot(sim[:, i])\n\n    pylab.show()\n</code></pre>\n\n<p>Thanks in advance.</p>\n\n<p>Sincerely,\nMatias</p>\n"
        }
    ],
    "has_more": false,
    "quota_max": 10000,
    "quota_remaining": 9871
}
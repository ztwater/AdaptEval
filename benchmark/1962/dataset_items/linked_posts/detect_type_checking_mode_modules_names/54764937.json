{
    "items": [
        {
            "tags": [
                "python",
                "abstract-syntax-tree"
            ],
            "comments": [
                {
                    "owner": {
                        "account_id": 7944736,
                        "reputation": 10628,
                        "user_id": 5997596,
                        "user_type": "registered",
                        "display_name": "Azat Ibrakov"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1550575022,
                    "post_id": 54764937,
                    "comment_id": 96310124,
                    "link": "https://stackoverflow.com/questions/54764937/detecting-modules-that-get-imported-on-condition#comment96310124_54764937",
                    "body": "why are you importing unused modules?"
                },
                {
                    "owner": {
                        "account_id": 5053094,
                        "reputation": 8420,
                        "user_id": 4057053,
                        "user_type": "registered",
                        "accept_rate": 54,
                        "display_name": "kurtgn"
                    },
                    "reply_to_user": {
                        "account_id": 7944736,
                        "reputation": 10628,
                        "user_id": 5997596,
                        "user_type": "registered",
                        "display_name": "Azat Ibrakov"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1550575291,
                    "post_id": 54764937,
                    "comment_id": 96310286,
                    "link": "https://stackoverflow.com/questions/54764937/detecting-modules-that-get-imported-on-condition#comment96310286_54764937",
                    "body": "@AzatIbrakov what makes you think they are unused?"
                },
                {
                    "owner": {
                        "account_id": 7944736,
                        "reputation": 10628,
                        "user_id": 5997596,
                        "user_type": "registered",
                        "display_name": "Azat Ibrakov"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1550575518,
                    "post_id": 54764937,
                    "comment_id": 96310424,
                    "link": "https://stackoverflow.com/questions/54764937/detecting-modules-that-get-imported-on-condition#comment96310424_54764937",
                    "body": "in your code snippet you are not using them, that&#39;s all"
                },
                {
                    "owner": {
                        "account_id": 7944736,
                        "reputation": 10628,
                        "user_id": 5997596,
                        "user_type": "registered",
                        "display_name": "Azat Ibrakov"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1550575521,
                    "post_id": 54764937,
                    "comment_id": 96310425,
                    "link": "https://stackoverflow.com/questions/54764937/detecting-modules-that-get-imported-on-condition#comment96310425_54764937",
                    "body": "btw your check doesn&#39;t handle cases when there is a module object called <code>TYPE_CHECKING</code> also if there is a case with absolute import like <code>import typing ... if typing.TYPE_CHECKING: ...</code>"
                },
                {
                    "owner": {
                        "account_id": 5053094,
                        "reputation": 8420,
                        "user_id": 4057053,
                        "user_type": "registered",
                        "accept_rate": 54,
                        "display_name": "kurtgn"
                    },
                    "reply_to_user": {
                        "account_id": 7944736,
                        "reputation": 10628,
                        "user_id": 5997596,
                        "user_type": "registered",
                        "display_name": "Azat Ibrakov"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1550576085,
                    "post_id": 54764937,
                    "comment_id": 96310788,
                    "link": "https://stackoverflow.com/questions/54764937/detecting-modules-that-get-imported-on-condition#comment96310788_54764937",
                    "body": "@AzatIbrakov well, let&#39;s suppose I use these modules down the road, I just did not put the in the example to reduce visual noise :)"
                },
                {
                    "owner": {
                        "account_id": 5053094,
                        "reputation": 8420,
                        "user_id": 4057053,
                        "user_type": "registered",
                        "accept_rate": 54,
                        "display_name": "kurtgn"
                    },
                    "reply_to_user": {
                        "account_id": 7944736,
                        "reputation": 10628,
                        "user_id": 5997596,
                        "user_type": "registered",
                        "display_name": "Azat Ibrakov"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1550576107,
                    "post_id": 54764937,
                    "comment_id": 96310801,
                    "link": "https://stackoverflow.com/questions/54764937/detecting-modules-that-get-imported-on-condition#comment96310801_54764937",
                    "body": "@AzatIbrakov and yes, my check does not handle a lot of cases, I really need a better one"
                }
            ],
            "answers": [
                {
                    "owner": {
                        "account_id": 7944736,
                        "reputation": 10628,
                        "user_id": 5997596,
                        "user_type": "registered",
                        "display_name": "Azat Ibrakov"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1550580209,
                    "last_edit_date": 1550580209,
                    "creation_date": 1550579414,
                    "answer_id": 54766405,
                    "question_id": 54764937,
                    "link": "https://stackoverflow.com/questions/54764937/detecting-modules-that-get-imported-on-condition/54766405#54766405",
                    "body": "<p>Your original approach with <code>ast</code> is a good start, but you may end up in missing some of edge-cases (like the ones I've already mentioned in comments), it's a lot of work that can be avoided.</p>\n\n<p>If you don't mind importing module you are analyzing (and we are sure that all of submodules like <code>django</code> are present) then we can do this in a \"dirty\" way:</p>\n\n<ol>\n<li>Import module with <code>TYPE_CHECKING</code> set to <code>False</code> (default).</li>\n<li>Import module with <code>TYPE_CHECKING</code> set to <code>True</code>.</li>\n<li>Compare 2 modules and get \"extra\" submodules names.</li>\n</ol>\n\n<p>First of all let's define utility function for monkey patching</p>\n\n<pre><code>from contextlib import contextmanager\n\n\n@contextmanager\ndef patch(object_, attribute_name, value):\n    old_value = getattr(object_, attribute_name)\n    try:\n        setattr(object_, attribute_name, value)\n        yield\n    finally:\n        setattr(object_, attribute_name, old_value)\n</code></pre>\n\n<p>after that our function can be written using <code>importlib</code> module (for dynamic imports &amp; reloading) and <code>inspect</code> module (for checking if object is a module) from stdlib like</p>\n\n<pre><code>import importlib\nimport inspect\nimport typing\n\n\ndef detect_type_checking_mode_modules_names(module_name):\n    module = importlib.import_module(module_name)\n    default_module_names = set(vars(module))\n\n    with patch(typing, 'TYPE_CHECKING', True):\n        # reloading since ``importlib.import_module``\n        # will return previously cached entry\n        importlib.reload(module)\n    type_checked_module_namespace = dict(vars(module))\n\n    # resetting to \"default\" mode\n    importlib.reload(module)\n\n    return {name\n            for name, content in type_checked_module_namespace.items()\n            if name not in default_module_names\n            and inspect.ismodule(content)}\n</code></pre>\n\n<h1>Test</h1>\n\n<p>For a <code>test.py</code> module with contents</p>\n\n<pre><code>from typing import TYPE_CHECKING\n\nif TYPE_CHECKING:\n    import abc\n    from django.utils import timezone\n\nif 'aaa':\n    print('bbb')\n\nprint('hello world')\n</code></pre>\n\n<p>gives us</p>\n\n<pre><code>&gt;&gt;&gt; detect_type_checking_mode_modules_names('test')\n{'abc', 'timezone'}\n</code></pre>\n"
                }
            ],
            "owner": {
                "account_id": 5053094,
                "reputation": 8420,
                "user_id": 4057053,
                "user_type": "registered",
                "accept_rate": 54,
                "display_name": "kurtgn"
            },
            "comment_count": 6,
            "is_answered": false,
            "answer_count": 1,
            "score": 0,
            "last_activity_date": 1550747887,
            "creation_date": 1550574746,
            "last_edit_date": 1550747887,
            "question_id": 54764937,
            "link": "https://stackoverflow.com/questions/54764937/detecting-modules-that-get-imported-on-condition",
            "title": "Detecting modules that get imported on condition",
            "body": "<p>I need to extract names of modules that are imported in a <code>mypy</code>-typed file, such as:</p>\n\n<pre><code>from typing import TYPE_CHECKING\nif TYPE_CHECKING:\n    import abc\n    from django.utils import timezone\n</code></pre>\n\n<p>Based on the example above, the \"name-extractor\" function should return <code>django.utils.timezone</code> and <code>abc</code>, but it should not return <code>typing.TYPE_CHECKING</code>.</p>\n\n<p>The only way, and a super-hacky and magical one I could come up with is using the <code>ast</code> and <code>compile</code> libraries:</p>\n\n<pre><code>import ast\n\ncode = \"\"\"\nfrom typing import TYPE_CHECKING\nif TYPE_CHECKING:\n    import abc\n    from django.utils import timezone\n\nif 'aaa':\n    print('bbb')\n\nprint('hello world')\n\"\"\"\ntree = ast.parse(code)\n\n# removing all nodes except for \"if TYPE_CHECKING\"\ntree.body = [\n    b for b in tree.body\n    if isinstance(b, ast.If)\n       and isinstance(b.test, ast.Name)\n       and b.test.id == 'TYPE_CHECKING'\n]\n\ncompiled = compile(tree, filename=\"&lt;ast&gt;\", mode=\"exec\")\nprint(compiled.co_names)\n</code></pre>\n\n<p>Is there a proper way to do this?</p>\n"
        }
    ],
    "has_more": false,
    "quota_max": 10000,
    "quota_remaining": 6312
}
{
    "items": [
        {
            "tags": [
                "python",
                "pandas",
                "multidimensional-array",
                "multi-index"
            ],
            "comments": [
                {
                    "owner": {
                        "account_id": 1530005,
                        "reputation": 247845,
                        "user_id": 1427416,
                        "user_type": "registered",
                        "accept_rate": 56,
                        "display_name": "BrenBarn"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1453930495,
                    "post_id": 35047882,
                    "comment_id": 57821145,
                    "link": "https://stackoverflow.com/questions/35047882/transform-pandas-dataframe-with-n-level-hierarchical-index-into-n-d-numpy-array#comment57821145_35047882",
                    "body": "The answer to &quot;how does it generalize&quot; is it doesn&#39;t.  A pandas DataFrame is fundamentally a two-dimensional object.  As your example shows, it doesn&#39;t enforce equal sizes across index &quot;dimensions&quot;, so if you try to expand it to more dimensions, there may be gaps.  I think if you want to get an n-D array you may have to make it yourself by iterating over the index levels and creating a separate &quot;slice&quot; of the result array for each.  Pandas just isn&#39;t targeted at that sort of structure."
                },
                {
                    "owner": {
                        "account_id": 1482700,
                        "reputation": 15160,
                        "user_id": 1391671,
                        "user_type": "registered",
                        "accept_rate": 83,
                        "display_name": "Igor Raush"
                    },
                    "reply_to_user": {
                        "account_id": 1530005,
                        "reputation": 247845,
                        "user_id": 1427416,
                        "user_type": "registered",
                        "accept_rate": 56,
                        "display_name": "BrenBarn"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1453936955,
                    "post_id": 35047882,
                    "comment_id": 57824458,
                    "link": "https://stackoverflow.com/questions/35047882/transform-pandas-dataframe-with-n-level-hierarchical-index-into-n-d-numpy-array#comment57824458_35047882",
                    "body": "Thanks @Bren. I managed to address the problem of missing rows and to use <code>reshape()</code> (see below). This seems to work on my dataset, although I wouldn&#39;t be surprised if there are situations where it chokes."
                }
            ],
            "answers": [
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 210767,
                                "reputation": 966,
                                "user_id": 462573,
                                "user_type": "registered",
                                "accept_rate": 25,
                                "display_name": "hannes"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1472607405,
                            "post_id": 35049899,
                            "comment_id": 65815960,
                            "link": "https://stackoverflow.com/questions/35047882/transform-pandas-dataframe-with-n-level-hierarchical-index-into-n-d-numpy-array/35049899#comment65815960_35049899",
                            "body": "works nicely! there&#39;s a minor typo: <code>frame.reindex(levels)</code>  should be <code>frame.reindex(index)</code>."
                        },
                        {
                            "owner": {
                                "account_id": 8731824,
                                "reputation": 1039,
                                "user_id": 6545662,
                                "user_type": "registered",
                                "display_name": "Ike"
                            },
                            "edited": false,
                            "score": 8,
                            "creation_date": 1502170385,
                            "post_id": 35049899,
                            "comment_id": 78079307,
                            "link": "https://stackoverflow.com/questions/35047882/transform-pandas-dataframe-with-n-level-hierarchical-index-into-n-d-numpy-array/35049899#comment78079307_35049899",
                            "body": "For us noobies; don&#39;t forget that in python3 you&#39;ll need to turn the result of &#39;map&#39; into a list before any of this will work. ie. <code>shape = list(map(len, frame.index.levels))</code>"
                        },
                        {
                            "owner": {
                                "account_id": 1081630,
                                "reputation": 1362,
                                "user_id": 1078465,
                                "user_type": "registered",
                                "display_name": "cbarrick"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1561355299,
                            "post_id": 35049899,
                            "comment_id": 100020187,
                            "link": "https://stackoverflow.com/questions/35047882/transform-pandas-dataframe-with-n-level-hierarchical-index-into-n-d-numpy-array/35049899#comment100020187_35049899",
                            "body": "Getting the shape is more straight forward: <code>frame.index.levshape</code>. Neither this nor the given solution seem to work with non-unique indices."
                        },
                        {
                            "owner": {
                                "account_id": 100731,
                                "reputation": 1648,
                                "user_id": 271388,
                                "user_type": "registered",
                                "accept_rate": 51,
                                "display_name": "CrabMan"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1584625183,
                            "post_id": 35049899,
                            "comment_id": 107497989,
                            "link": "https://stackoverflow.com/questions/35047882/transform-pandas-dataframe-with-n-level-hierarchical-index-into-n-d-numpy-array/35049899#comment107497989_35049899",
                            "body": "Doing <code>df.index.labels</code> I get <code>AttributeError: &#39;MultiIndex&#39; object has no attribute &#39;labels&#39;</code>. What&#39;s up with that?"
                        },
                        {
                            "owner": {
                                "account_id": 2110979,
                                "reputation": 854,
                                "user_id": 2448960,
                                "user_type": "registered",
                                "accept_rate": 71,
                                "display_name": "Zz&#39;Rot"
                            },
                            "reply_to_user": {
                                "account_id": 100731,
                                "reputation": 1648,
                                "user_id": 271388,
                                "user_type": "registered",
                                "accept_rate": 51,
                                "display_name": "CrabMan"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1603132359,
                            "post_id": 35049899,
                            "comment_id": 113934056,
                            "link": "https://stackoverflow.com/questions/35047882/transform-pandas-dataframe-with-n-level-hierarchical-index-into-n-d-numpy-array/35049899#comment113934056_35049899",
                            "body": "@CrabMan Very late response, but <code>MultiIndex.labels</code> has been deprecated in favor of <code>MultiIndex.codes</code> - using the latter should fix the error. (<a href=\"https://pandas-docs.github.io/pandas-docs-travis/whatsnew/v0.24.0.html#deprecations\" rel=\"nofollow noreferrer\">pandas-docs.github.io/pandas-docs-travis/whatsnew/&hellip;</a>)"
                        },
                        {
                            "owner": {
                                "account_id": 968413,
                                "reputation": 3877,
                                "user_id": 991432,
                                "user_type": "registered",
                                "display_name": "rxg"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1677103506,
                            "post_id": 35049899,
                            "comment_id": 133274214,
                            "link": "https://stackoverflow.com/questions/35047882/transform-pandas-dataframe-with-n-level-hierarchical-index-into-n-d-numpy-array/35049899#comment133274214_35049899",
                            "body": "<code>arr[frame.index.codes]</code> gives a deprecation warning from Numpy 1.15 and stops working in Numpy 1.23 (<a href=\"https://numpy.org/doc/stable/release/1.23.0-notes.html\" rel=\"nofollow noreferrer\">numpy.org/doc/stable/release/1.23.0-notes.html</a>). <code>arr[tuple(frame.index.codes)]</code> does the trick."
                        }
                    ],
                    "owner": {
                        "account_id": 1482700,
                        "reputation": 15160,
                        "user_id": 1391671,
                        "user_type": "registered",
                        "accept_rate": 83,
                        "display_name": "Igor Raush"
                    },
                    "comment_count": 6,
                    "is_accepted": true,
                    "score": 18,
                    "last_activity_date": 1603136178,
                    "last_edit_date": 1603136178,
                    "creation_date": 1453936120,
                    "answer_id": 35049899,
                    "question_id": 35047882,
                    "link": "https://stackoverflow.com/questions/35047882/transform-pandas-dataframe-with-n-level-hierarchical-index-into-n-d-numpy-array/35049899#35049899",
                    "body": "<p><strong>Edit</strong>. This approach is much more elegant (and two orders of magnitude faster) than the one I gave below.</p>\n<pre><code># create an empty array of NaN of the right dimensions\nshape = map(len, frame.index.levels)\narr = np.full(shape, np.nan)\n\n# fill it using Numpy's advanced indexing\narr[frame.index.codes] = frame.values.flat\n# ...or in Pandas &lt; 0.24.0, use\n# arr[frame.index.labels] = frame.values.flat\n</code></pre>\n<hr />\n<p><strong>Original solution</strong>. Given a setup similar to above, but in 3-D,</p>\n<pre><code>from pandas import DataFrame, MultiIndex\nfrom itertools import product\n\nindex = range(2), range(2), range(2)\nvalue = range(2 * 2 * 2)\nframe = DataFrame(value, columns=['value'],\n                  index=MultiIndex.from_product(index)).drop((1, 0, 1))\nprint(frame)\n</code></pre>\n<p>we have</p>\n<pre><code>       value\n0 0 0      0\n    1      1\n  1 0      2\n    1      3\n1 0 0      4\n  1 0      6\n    1      7\n</code></pre>\n<p>Now, we proceed using the <code>reshape()</code> route, but with some preprocessing to ensure that the length along each dimension will be consistent.</p>\n<p>First, reindex the data frame with the full cartesian product of all dimensions. <code>NaN</code> values will be inserted as needed. This operation can be both slow and consume a lot of memory, depending on the number of dimensions and on the size of the data frame.</p>\n<pre><code>levels = map(tuple, frame.index.levels)\nindex = list(product(*levels))\nframe = frame.reindex(index)\nprint(frame)\n</code></pre>\n<p>which outputs</p>\n<pre><code>       value\n0 0 0      0\n    1      1\n  1 0      2\n    1      3\n1 0 0      4\n    1    NaN\n  1 0      6\n    1      7\n</code></pre>\n<p>Now, <code>reshape()</code> will work as intended.</p>\n<pre><code>shape = map(len, frame.index.levels)\nprint(frame.values.reshape(shape))\n</code></pre>\n<p>which outputs</p>\n<pre><code>[[[  0.   1.]\n  [  2.   3.]]\n\n [[  4.  nan]\n  [  6.   7.]]]\n</code></pre>\n<p>The (rather ugly) one-liner is</p>\n<pre><code>frame.reindex(list(product(*map(tuple, frame.index.levels)))).values\\\n     .reshape(map(len, frame.index.levels))\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 20543980,
                        "reputation": 171,
                        "user_id": 15078300,
                        "user_type": "registered",
                        "display_name": "G-Higgins"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1631286820,
                    "creation_date": 1631286820,
                    "answer_id": 69134381,
                    "question_id": 35047882,
                    "link": "https://stackoverflow.com/questions/35047882/transform-pandas-dataframe-with-n-level-hierarchical-index-into-n-d-numpy-array/69134381#69134381",
                    "body": "<p>This can be done quite nicely using the Python xarray package which can be found here: <a href=\"http://xarray.pydata.org/en/stable/\" rel=\"nofollow noreferrer\">http://xarray.pydata.org/en/stable/</a>. It has great integration with Pandas and is quite intuitive once you get to grips with it.</p>\n<p>If you have a multiindex series you can call the built-in method multiindex_series.to_xarray() (<a href=\"https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.to_xarray.html\" rel=\"nofollow noreferrer\">https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.to_xarray.html</a>). This will generate a DataArray object, which is essentially a name-indexed numpy array, using the index values and names as coordinates. Following this you can call .values on the DataArray object to get the underlying numpy array.</p>\n<p>If you need your tensor to conform to a set of keys in a specific order, you can also call .reindex(index_name = index_values_in_order) (<a href=\"http://xarray.pydata.org/en/stable/generated/xarray.DataArray.reindex.html\" rel=\"nofollow noreferrer\">http://xarray.pydata.org/en/stable/generated/xarray.DataArray.reindex.html</a>) on the DataArray. This can be extremely useful and makes working with the newly generated tensor much easier!</p>\n"
                }
            ],
            "owner": {
                "account_id": 1482700,
                "reputation": 15160,
                "user_id": 1391671,
                "user_type": "registered",
                "accept_rate": 83,
                "display_name": "Igor Raush"
            },
            "comment_count": 2,
            "is_answered": true,
            "accepted_answer_id": 35049899,
            "answer_count": 2,
            "score": 14,
            "last_activity_date": 1631286820,
            "creation_date": 1453928397,
            "question_id": 35047882,
            "link": "https://stackoverflow.com/questions/35047882/transform-pandas-dataframe-with-n-level-hierarchical-index-into-n-d-numpy-array",
            "title": "Transform Pandas DataFrame with n-level hierarchical index into n-D Numpy array",
            "body": "<h3>Question</h3>\n\n<p>Is there a good way to transform a DataFrame with an <em>n</em>-level index into an <em>n</em>-D Numpy array (a.k.a <em>n</em>-tensor)?</p>\n\n<hr>\n\n<h3>Example</h3>\n\n<p>Suppose I set up a DataFrame like</p>\n\n<pre><code>from pandas import DataFrame, MultiIndex\n\nindex = range(2), range(3)\nvalue = range(2 * 3)\nframe = DataFrame(value, columns=['value'],\n                  index=MultiIndex.from_product(index)).drop((1, 0))\nprint frame\n</code></pre>\n\n<p>which outputs</p>\n\n<pre><code>     value\n0 0      0\n  1      1\n  2      3\n1 1      5\n  2      6\n</code></pre>\n\n<p>The index is a 2-level hierarchical index. I can extract a 2-D Numpy array from the data using</p>\n\n<pre><code>print frame.unstack().values\n</code></pre>\n\n<p>which outputs</p>\n\n<pre><code>[[  0.   1.   2.]\n [ nan   4.   5.]]\n</code></pre>\n\n<p><strong>How does this generalize to an <em>n</em>-level index?</strong></p>\n\n<p>Playing with <code>unstack()</code>, it seems that it can only be used to massage the 2-D shape of the DataFrame, but not to add an axis.</p>\n\n<p>I cannot use e.g. <code>frame.values.reshape(x, y, z)</code>, since this would require that the frame contains exactly <code>x * y * z</code> rows, which cannot be guaranteed. This is what I tried to demonstrate by <code>drop()</code>ing a row in the above example.</p>\n\n<p>Any suggestions are highly appreciated.</p>\n"
        }
    ],
    "has_more": false,
    "quota_max": 10000,
    "quota_remaining": 5398
}
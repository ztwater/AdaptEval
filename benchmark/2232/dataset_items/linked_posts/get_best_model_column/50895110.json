{
    "items": [
        {
            "tags": [
                "python",
                "tensorflow",
                "memory-management",
                "keras"
            ],
            "comments": [
                {
                    "owner": {
                        "account_id": 13540458,
                        "reputation": 5001,
                        "user_id": 9768291,
                        "user_type": "registered",
                        "display_name": "payne"
                    },
                    "edited": false,
                    "score": 2,
                    "creation_date": 1538077604,
                    "post_id": 50895110,
                    "comment_id": 92028029,
                    "link": "https://stackoverflow.com/questions/50895110/what-do-i-need-k-clear-session-and-del-model-for-keras-with-tensorflow-gpu#comment92028029_50895110",
                    "body": "Did you discover anything related to your question? I&#39;m trying to find the same answers. The 1 answer provided doesn&#39;t quite clear up my thoughts."
                },
                {
                    "owner": {
                        "account_id": 992688,
                        "reputation": 2693,
                        "user_id": 1009508,
                        "user_type": "registered",
                        "accept_rate": 83,
                        "display_name": "MNM"
                    },
                    "edited": false,
                    "score": 2,
                    "creation_date": 1563929023,
                    "post_id": 50895110,
                    "comment_id": 100860380,
                    "link": "https://stackoverflow.com/questions/50895110/what-do-i-need-k-clear-session-and-del-model-for-keras-with-tensorflow-gpu#comment100860380_50895110",
                    "body": "The model does not get overwritten as far as I know the TF graph will just add the new model to the old model TF graph if you don&#39;t clear it. Del the model just saves memory so the cpu/gpu won&#39;t have to hold extra stuff in it."
                },
                {
                    "owner": {
                        "account_id": 14971572,
                        "reputation": 968,
                        "user_id": 10817844,
                        "user_type": "registered",
                        "display_name": "yzerman"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1575782509,
                    "post_id": 50895110,
                    "comment_id": 104678037,
                    "link": "https://stackoverflow.com/questions/50895110/what-do-i-need-k-clear-session-and-del-model-for-keras-with-tensorflow-gpu#comment104678037_50895110",
                    "body": "If you&#39;re using the Sequential method in Keras and you create a new model by starting with model=Sequential(), then I agree that your previous model should be overwritten. I couldn&#39;t find confirmation in the docs, however."
                },
                {
                    "owner": {
                        "account_id": 17088386,
                        "reputation": 247,
                        "user_id": 12365046,
                        "user_type": "registered",
                        "display_name": "Black Snow"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1583844298,
                    "post_id": 50895110,
                    "comment_id": 107243494,
                    "link": "https://stackoverflow.com/questions/50895110/what-do-i-need-k-clear-session-and-del-model-for-keras-with-tensorflow-gpu#comment107243494_50895110",
                    "body": "actually your question itself help me a lot and thanks a lot i was searching for this for past 6 hours thanks again wish you a good luck"
                }
            ],
            "answers": [
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 10920872,
                                "reputation": 384,
                                "user_id": 8030107,
                                "user_type": "registered",
                                "display_name": "aspiring1"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1561012177,
                            "post_id": 51896376,
                            "comment_id": 99926339,
                            "link": "https://stackoverflow.com/questions/50895110/what-do-i-need-k-clear-session-and-del-model-for-keras-with-tensorflow-gpu/51896376#comment99926339_51896376",
                            "body": "Do I need to create a new model, when I run K.clear_session(). Also, can you explain adding of nodes to the graph part and the model becoming slower and running out of memory."
                        },
                        {
                            "owner": {
                                "account_id": 2663846,
                                "reputation": 1121,
                                "user_id": 2302879,
                                "user_type": "registered",
                                "display_name": "Chris Swinchatt"
                            },
                            "reply_to_user": {
                                "account_id": 10920872,
                                "reputation": 384,
                                "user_id": 8030107,
                                "user_type": "registered",
                                "display_name": "aspiring1"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1561110964,
                            "post_id": 51896376,
                            "comment_id": 99965839,
                            "link": "https://stackoverflow.com/questions/50895110/what-do-i-need-k-clear-session-and-del-model-for-keras-with-tensorflow-gpu/51896376#comment99965839_51896376",
                            "body": "This answer might not apply to thet current version of TensorFlow as I haven&#39;t used it since last year.  Assuming the situation hasn&#39;t changed; yes, you need to either create a new model or save and reload the old one to continue training.  I&#39;ve edited my answer to answer the second part of your question."
                        },
                        {
                            "owner": {
                                "account_id": 10330510,
                                "reputation": 999,
                                "user_id": 7620499,
                                "user_type": "registered",
                                "accept_rate": 44,
                                "display_name": "bernando_vialli"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1568042648,
                            "post_id": 51896376,
                            "comment_id": 102140163,
                            "link": "https://stackoverflow.com/questions/50895110/what-do-i-need-k-clear-session-and-del-model-for-keras-with-tensorflow-gpu/51896376#comment102140163_51896376",
                            "body": "why is it when I do K.clear_session() and then run my model.fit code it still gives me ValueError: Tensor(&quot;training/Adam/Const:0&quot;, shape=(), dtype=int64) must be from the same graph as Tensor(&quot;Adam/iterations:0&quot;, shape=(), dtype=resource)."
                        },
                        {
                            "owner": {
                                "account_id": 2695500,
                                "reputation": 450,
                                "user_id": 2327666,
                                "user_type": "registered",
                                "accept_rate": 83,
                                "display_name": "Marcus"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1568660991,
                            "post_id": 51896376,
                            "comment_id": 102337258,
                            "link": "https://stackoverflow.com/questions/50895110/what-do-i-need-k-clear-session-and-del-model-for-keras-with-tensorflow-gpu/51896376#comment102337258_51896376",
                            "body": "By performing K.clear_session() I assume the current graph is deleted and every future Operation relying on the existence of that graph (such as adding new layers, or running model.fit()) has no graph to link to anymore."
                        },
                        {
                            "owner": {
                                "account_id": 2663846,
                                "reputation": 1121,
                                "user_id": 2302879,
                                "user_type": "registered",
                                "display_name": "Chris Swinchatt"
                            },
                            "reply_to_user": {
                                "account_id": 10330510,
                                "reputation": 999,
                                "user_id": 7620499,
                                "user_type": "registered",
                                "accept_rate": 44,
                                "display_name": "bernando_vialli"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1569233520,
                            "post_id": 51896376,
                            "comment_id": 102517020,
                            "link": "https://stackoverflow.com/questions/50895110/what-do-i-need-k-clear-session-and-del-model-for-keras-with-tensorflow-gpu/51896376#comment102517020_51896376",
                            "body": "@mathlover Marcus is correct, if you delete the graph and create a new one then your existing tensors have a dangling reference. This is why you should save the model before deleting the graph and then reload it. That way, you get a new graph containing all the necessary data."
                        },
                        {
                            "owner": {
                                "account_id": 14499412,
                                "reputation": 346,
                                "user_id": 10473059,
                                "user_type": "registered",
                                "display_name": "KMunro"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1571832557,
                            "post_id": 51896376,
                            "comment_id": 103370157,
                            "link": "https://stackoverflow.com/questions/50895110/what-do-i-need-k-clear-session-and-del-model-for-keras-with-tensorflow-gpu/51896376#comment103370157_51896376",
                            "body": "@Chris Swinchatt and all: after crashing out with OOM today I can confirm this still applies! I discovered it by checking my Tensorboard logs: the logs files got bigger in the order they were created, and the graphs in Tensorboard were more and more complex as the different models&#39; graphs were chained together. It didn&#39;t seem to affect model results (which is as one would hope) but can anyone confirm for sure that it doesn&#39;t harm later models? (aside from obvious speed/memory issues)."
                        }
                    ],
                    "owner": {
                        "account_id": 2663846,
                        "reputation": 1121,
                        "user_id": 2302879,
                        "user_type": "registered",
                        "display_name": "Chris Swinchatt"
                    },
                    "comment_count": 6,
                    "is_accepted": false,
                    "score": 49,
                    "last_activity_date": 1589372343,
                    "last_edit_date": 1589372343,
                    "creation_date": 1534512179,
                    "answer_id": 51896376,
                    "question_id": 50895110,
                    "link": "https://stackoverflow.com/questions/50895110/what-do-i-need-k-clear-session-and-del-model-for-keras-with-tensorflow-gpu/51896376#51896376",
                    "body": "<p><code>K.clear_session()</code> is useful when you're creating multiple models in succession, such as during hyperparameter search or cross-validation. Each model you train adds nodes (potentially numbering in the thousands) to the graph. TensorFlow executes the entire graph whenever you (or Keras) call <code>tf.Session.run()</code> or <code>tf.Tensor.eval()</code>, so your models will become slower and slower to train, and you may also run out of memory. Clearing the session removes all the nodes left over from previous models, freeing memory and preventing slowdown.</p>\n\n<hr>\n\n<p><strong>Edit 21/06/19:</strong></p>\n\n<p>TensorFlow is lazy-evaluated by default. TensorFlow operations aren't evaluated immediately: creating a tensor or doing some operations to it creates nodes in a dataflow graph. The results are calculated by evaluating the relevant parts of the graph in one go when you call <code>tf.Session.run()</code> or <code>tf.Tensor.eval()</code>. This is so TensorFlow can build an execution plan that allocates operations that can be performed in parallel to different devices. It can also fold adjacent nodes together or remove redundant ones (e.g. if you concatenated two tensors and later split them apart again unchanged). For more details, see <a href=\"https://www.tensorflow.org/guide/graphs\" rel=\"noreferrer\">https://www.tensorflow.org/guide/graphs</a></p>\n\n<p>All of your TensorFlow models are stored in the graph as a series of tensors and tensor operations. The basic operation of machine learning is tensor dot product - the output of a neural network is the dot product of the input matrix and the network weights. If you have a single-layer perceptron and 1,000 training samples, then each epoch creates at least 1,000 tensor operations. If you have 1,000 epochs, then your graph contains at least 1,000,000 nodes at the end, before taking into account preprocessing, postprocessing, and more complex models such as recurrent nets, encoder-decoder, attentional models, etc.</p>\n\n<p>The problem is that eventually the graph would be too large to fit into video memory (6 GB in my case), so TF would shuttle parts of the graph from video to main memory and back. Eventually it would even get too large for main memory (12 GB) and start moving between main memory and the hard disk. Needless to say, this made things incredibly, and increasingly, slow as training went on. Before developing this save-model/clear-session/reload-model flow, I calculated that, at the per-epoch rate of slowdown I experienced, my model would have taken longer than the age of the universe to finish training. </p>\n\n<blockquote>\n  <p>Disclaimer: I haven't used TensorFlow in almost a year, so this might have changed. I remember there being quite a few GitHub issues around this so hopefully it has since been fixed.</p>\n</blockquote>\n"
                },
                {
                    "owner": {
                        "user_type": "does_not_exist",
                        "display_name": "user10595337"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 7,
                    "last_activity_date": 1551192895,
                    "creation_date": 1551192895,
                    "answer_id": 54888253,
                    "question_id": 50895110,
                    "link": "https://stackoverflow.com/questions/50895110/what-do-i-need-k-clear-session-and-del-model-for-keras-with-tensorflow-gpu/54888253#54888253",
                    "body": "<p>del  will delete variable in python and since model is a variable, del model will delete it but the TF graph will have no changes (TF is your Keras backend). This said, K.clear_session() will destroy the current TF graph and creates a new one. Creating a new model seems to be an independent step, but don't forget the backend :)  </p>\n"
                }
            ],
            "owner": {
                "account_id": 13440506,
                "reputation": 799,
                "user_id": 9697805,
                "user_type": "registered",
                "display_name": "benjamin"
            },
            "comment_count": 4,
            "is_answered": true,
            "answer_count": 2,
            "score": 61,
            "last_activity_date": 1597328302,
            "creation_date": 1529225379,
            "last_edit_date": 1530090554,
            "question_id": 50895110,
            "link": "https://stackoverflow.com/questions/50895110/what-do-i-need-k-clear-session-and-del-model-for-keras-with-tensorflow-gpu",
            "title": "What do I need K.clear_session() and del model for (Keras with Tensorflow-gpu)?",
            "body": "<p><strong><em>What I am doing</em></strong><br>\nI am training and using a convolutional neuron network (CNN) for image-classification using Keras with Tensorflow-gpu as backend.</p>\n\n<p><strong><em>What I am using</em></strong><br>\n- PyCharm Community 2018.1.2<br>\n- both Python 2.7 and 3.5 (but not both at a time)<br>\n- Ubuntu 16.04<br>\n- Keras 2.2.0<br>\n- Tensorflow-GPU 1.8.0 as backend</p>\n\n<p><strong><em>What I want to know</em></strong><br>\nIn many codes I see people using</p>\n\n<pre><code>from keras import backend as K \n\n# Do some code, e.g. train and save model\n\nK.clear_session()\n</code></pre>\n\n<p>or deleting the model after using it:</p>\n\n<pre><code>del model\n</code></pre>\n\n<p>The keras documentation says regarding <code>clear_session</code>: \"Destroys the current TF graph and creates a new one. Useful to avoid clutter from old models / layers.\" - <a href=\"https://keras.io/backend/\" rel=\"noreferrer\">https://keras.io/backend/</a></p>\n\n<p>What is the point of doing that and should I do it as well? When loading or creating a new model my model gets overwritten anyway, so why bother?</p>\n"
        }
    ],
    "has_more": false,
    "quota_max": 10000,
    "quota_remaining": 5765
}
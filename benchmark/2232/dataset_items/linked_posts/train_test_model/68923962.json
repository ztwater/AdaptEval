{
    "items": [
        {
            "tags": [
                "tensorflow",
                "keras",
                "deep-learning",
                "conv-neural-network",
                "tf.keras"
            ],
            "answers": [
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 21842722,
                                "reputation": 193,
                                "user_id": 16136035,
                                "user_type": "registered",
                                "display_name": "maryam gh"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1629900503,
                            "post_id": 68924248,
                            "comment_id": 121809879,
                            "link": "https://stackoverflow.com/questions/68923962/unknown-metric-function-please-ensure-this-object-is-passed-to-the-custom-obje/68924248#comment121809879_68924248",
                            "body": "using this line i get same error: NameError: name &#39;lr_track&#39; is not defined"
                        },
                        {
                            "owner": {
                                "account_id": 17592382,
                                "reputation": 1097,
                                "user_id": 12763966,
                                "user_type": "registered",
                                "display_name": "BestDogeStackoverflow"
                            },
                            "reply_to_user": {
                                "account_id": 21842722,
                                "reputation": 193,
                                "user_id": 16136035,
                                "user_type": "registered",
                                "display_name": "maryam gh"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1629901496,
                            "post_id": 68924248,
                            "comment_id": 121810394,
                            "link": "https://stackoverflow.com/questions/68923962/unknown-metric-function-please-ensure-this-object-is-passed-to-the-custom-obje/68924248#comment121810394_68924248",
                            "body": "it doesnt make sense, you defined it here <code>lr_track = get_lr_metric(opt)</code>, did you run this part of the code?"
                        },
                        {
                            "owner": {
                                "account_id": 17592382,
                                "reputation": 1097,
                                "user_id": 12763966,
                                "user_type": "registered",
                                "display_name": "BestDogeStackoverflow"
                            },
                            "reply_to_user": {
                                "account_id": 21842722,
                                "reputation": 193,
                                "user_id": 16136035,
                                "user_type": "registered",
                                "display_name": "maryam gh"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1629901637,
                            "post_id": 68924248,
                            "comment_id": 121810462,
                            "link": "https://stackoverflow.com/questions/68923962/unknown-metric-function-please-ensure-this-object-is-passed-to-the-custom-obje/68924248#comment121810462_68924248",
                            "body": "just execute this <code>Vgg16 = keras.models.load_model(model1 , custom_objects={&quot;lr&quot;: get_lr_metric(RMSprop())})</code>"
                        },
                        {
                            "owner": {
                                "account_id": 21842722,
                                "reputation": 193,
                                "user_id": 16136035,
                                "user_type": "registered",
                                "display_name": "maryam gh"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1629903082,
                            "post_id": 68924248,
                            "comment_id": 121811159,
                            "link": "https://stackoverflow.com/questions/68923962/unknown-metric-function-please-ensure-this-object-is-passed-to-the-custom-obje/68924248#comment121811159_68924248",
                            "body": "yes i did. but i made another silly mistake. now it works. thanks for your time."
                        }
                    ],
                    "owner": {
                        "account_id": 17592382,
                        "reputation": 1097,
                        "user_id": 12763966,
                        "user_type": "registered",
                        "display_name": "BestDogeStackoverflow"
                    },
                    "comment_count": 4,
                    "is_accepted": true,
                    "score": 7,
                    "last_activity_date": 1629900021,
                    "last_edit_date": 1629900021,
                    "creation_date": 1629899700,
                    "answer_id": 68924248,
                    "question_id": 68923962,
                    "link": "https://stackoverflow.com/questions/68923962/unknown-metric-function-please-ensure-this-object-is-passed-to-the-custom-obje/68924248#68924248",
                    "body": "<p>Because as the error says you didn't call it <code>lr</code>, you called it</p>\n<p><code>lr_track</code>  in <code>lr_track = get_lr_metric(opt)</code>, you never defined <code>lr</code>.</p>\n<p>you need to call it like this:</p>\n<pre><code>Vgg16 = keras.models.load_model(model1 , custom_objects={&quot;lr&quot;: lr_track })\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 19531465,
                        "reputation": 311,
                        "user_id": 16007029,
                        "user_type": "registered",
                        "display_name": "Pulkit Ratna Ganjeer"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 2,
                    "last_activity_date": 1648689298,
                    "last_edit_date": 1648689298,
                    "creation_date": 1648607890,
                    "answer_id": 71670878,
                    "question_id": 68923962,
                    "link": "https://stackoverflow.com/questions/68923962/unknown-metric-function-please-ensure-this-object-is-passed-to-the-custom-obje/71670878#71670878",
                    "body": "<p>You need to use the same keyword as used in the model.compile() for the custom object (metric here).</p>\n<p>In this case, you need to write:</p>\n<pre><code>keras.models.load_model(model1 , custom_objects={&quot;lr_track&quot;: lr_track })\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 17624223,
                        "reputation": 710,
                        "user_id": 13679899,
                        "user_type": "registered",
                        "display_name": "Manish Gupta"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 1,
                    "last_activity_date": 1667910743,
                    "creation_date": 1667910743,
                    "answer_id": 74360828,
                    "question_id": 68923962,
                    "link": "https://stackoverflow.com/questions/68923962/unknown-metric-function-please-ensure-this-object-is-passed-to-the-custom-obje/74360828#74360828",
                    "body": "<p>Simply use compile=False, then compile the model. In your case, use this:</p>\n<pre><code>Vgg16 = keras.models.load_model(model1, compile=False)\nVgg16.compile(optimizer=opt, loss='categorical_crossentropy', metrics=['accuracy' \n   , lr_track, keras.metrics.Precision(), keras.metrics.Recall()])\n</code></pre>\n"
                }
            ],
            "owner": {
                "account_id": 21842722,
                "reputation": 193,
                "user_id": 16136035,
                "user_type": "registered",
                "display_name": "maryam gh"
            },
            "comment_count": 0,
            "is_answered": true,
            "accepted_answer_id": 68924248,
            "answer_count": 3,
            "score": 3,
            "last_activity_date": 1667910743,
            "creation_date": 1629898542,
            "last_edit_date": 1631369187,
            "question_id": 68923962,
            "link": "https://stackoverflow.com/questions/68923962/unknown-metric-function-please-ensure-this-object-is-passed-to-the-custom-obje",
            "title": "Unknown metric function: Please ensure this object is passed to the `custom_objects` argument",
            "body": "<p>I have trained a model with keras using transfer learning. since the whole code is almost big i only bring important parts.</p>\n<p>For learning rate I cloned from github some code to be able to use cyclic learning rate. and passed it to the model as callback.</p>\n<p>Here is how I defined my learning rate.</p>\n<pre><code>from tensorflow.keras.optimizers import RMSprop\n\nopt = RMSprop()\ndef get_lr_metric(optimizer):\n    def lr(y_true, y_pred):\n        return optimizer.lr\n    return lr\n\nlr_track = get_lr_metric(opt)\n\nMIN_LR = 1e-7\nMAX_LR = 1e-3\nCLR_METHOD = &quot;triangular&quot;\n\nclr = CyclicLR(\n    mode= CLR_METHOD,\n    base_lr= MIN_LR,\n    max_lr= MAX_LR,\n    step_size= steps_per_epoch)\n</code></pre>\n<p>and my model:</p>\n<pre><code>def vgg16_fine_tune():\n    vgg16_model = VGG16(weights='imagenet', include_top=False)\n    x = vgg16_model.output\n    x = GlobalAveragePooling2D()(x)\n    x = Dense(256, activation='relu')(x)\n    x = Dropout(0.3)(x)\n    x = Dense(128, activation='relu')(x)\n    x = Dropout(0.3)(x)\n    x = Dense(128, activation='relu')(x)\n    x = Dropout(0.3)(x)\n\n    predictions = Dense(3, activation='softmax')(x)\n\n    model = Model(inputs=vgg16_model.input, outputs=predictions)\n    for layer in vgg16_model.layers:\n        layer.trainable = False\n        \n    return model\n\nmodel = vgg16_fine_tune()\n</code></pre>\n<p>and i compiled my code:</p>\n<pre><code>import keras\nmodel.compile(optimizer=opt, loss='categorical_crossentropy', metrics=['accuracy' , lr_track, keras.metrics.Precision(), keras.metrics.Recall()])\nhistory_2 = model.fit(datagen.flow(x_train, y_train),\n                    epochs=20,\n                    shuffle=True,\n                    validation_data=(x_val, y_val),\n                    callbacks=[chkpt, clr, es])\n\n\nEpoch 1/20\n188/188 [==============================] - 80s 416ms/step - loss: 0.5007 - accuracy: 0.8038 - lr: 4.4728e-06 - precision: 0.8275 - recall: 0.7711 - val_loss: 0.3959 - val_accuracy: 0.8560 - val_lr: 8.7048e-07 - val_precision: 0.8833 - val_recall: 0.8227\nEpoch 2/20\n188/188 [==============================] - 79s 423ms/step - loss: 0.4116 - accuracy: 0.8442 - lr: 4.8224e-06 - precision: 0.8660 - recall: 0.8215 - val_loss: 0.3621 - val_accuracy: 0.8700 - val_lr: 1.7400e-06 - val_precision: 0.8923 - val_recall: 0.8393\nEpoch 3/20\n188/188 [==============================] - 79s 421ms/step - loss: 0.3884 - accuracy: 0.8535 - lr: 5.1341e-06 - precision: 0.8775 - recall: 0.8331 - val_loss: 0.3529 - val_accuracy: 0.8767 - val_lr: 2.6094e-06 - val_precision: 0.8953 - val_recall: 0.8547\nEpoch 4/20\n188/188 [==============================] - 80s 423ms/step - loss: 0.3836 - accuracy: 0.8599 - lr: 5.4058e-06 - precision: 0.8809 - recall: 0.8407 - val_loss: 0.3452 - val_accuracy: 0.8767 - val_lr: 3.4789e-06 - val_precision: 0.8962 - val_recall: 0.8580\nEpoch 5/20\n188/188 [==============================] - 79s 419ms/step - loss: 0.3516 - accuracy: 0.8662 - lr: 5.6348e-06 - precision: 0.8857 - recall: 0.8448 - val_loss: 0.3324 - val_accuracy: 0.8780 - val_lr: 4.3484e-06 - val_precision: 0.8923 - val_recall: 0.8613\nEpoch 6/20\n188/188 [==============================] - 79s 422ms/step - loss: 0.3518 - accuracy: 0.8726 - lr: 5.8182e-06 - precision: 0.8905 - recall: 0.8487 - val_loss: 0.3378 - val_accuracy: 0.8733 - val_lr: 5.2179e-06 - val_precision: 0.8952 - val_recall: 0.8540\nEpoch 7/20\n188/188 [==============================] - 78s 413ms/step - loss: 0.3324 - accuracy: 0.8799 - lr: 5.9525e-06 - precision: 0.8955 - recall: 0.8649 - val_loss: 0.3393 - val_accuracy: 0.8740 - val_lr: 6.0873e-06 - val_precision: 0.8944 - val_recall: 0.8527\nEpoch 8/20\n188/188 [==============================] - 78s 417ms/step - loss: 0.3312 - accuracy: 0.8759 - lr: 6.0333e-06 - precision: 0.8936 - recall: 0.8549 - val_loss: 0.3149 - val_accuracy: 0.8920 - val_lr: 6.9568e-06 - val_precision: 0.9109 - val_recall: 0.8653\n</code></pre>\n<p>and then after fitting i saved it:</p>\n<pre><code>model.save_weights('model_weight.h5')\nmodel.save('model_keras.h5')\n</code></pre>\n<p>But when I need to load my model and use it I get an error about custom objects.</p>\n<pre><code>from tensorflow import keras\nimport os\n\nmodel_dir = 'My Directory'\nmodel1 = os.path.join(model_dir, &quot;DenseNet_model_keras.h5&quot;)\n\nVgg16 = keras.models.load_model(model1)\n</code></pre>\n<p>here is my error:</p>\n<blockquote>\n<p>ValueError: Unknown metric function: lr. Please ensure this object is\npassed to the <code>custom_objects</code> argument. See\n<a href=\"https://www.tensorflow.org/guide/keras/save_and_serialize#registering_the_custom_object\" rel=\"nofollow noreferrer\">https://www.tensorflow.org/guide/keras/save_and_serialize#registering_the_custom_object</a>\nfor details.</p>\n</blockquote>\n<p>i even tried this code.</p>\n<pre><code>Vgg16 = keras.models.load_model(model1 , custom_objects={&quot;lr&quot;: lr})\n</code></pre>\n<p>but all i get is</p>\n<blockquote>\n<p>Vgg16 = keras.models.load_model(model1 , custom_objects={&quot;lr&quot;: lr})\nTraceback (most recent call last):</p>\n<p>File &quot;&quot;, line 1, in \nVgg16 = keras.models.load_model(model1 , custom_objects={&quot;lr&quot;: lr})</p>\n<p>NameError: name 'lr' is not defined</p>\n</blockquote>\n<p>Can someone help me with my problem please?</p>\n"
        }
    ],
    "has_more": false,
    "quota_max": 10000,
    "quota_remaining": 5758
}
{
    "items": [
        {
            "tags": [
                "python",
                "pandas",
                "correlation"
            ],
            "comments": [
                {
                    "owner": {
                        "account_id": 11487331,
                        "reputation": 1927,
                        "user_id": 8419574,
                        "user_type": "registered",
                        "display_name": "kevin_theinfinityfund"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1635177415,
                    "post_id": 29294983,
                    "comment_id": 123220470,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on#comment123220470_29294983",
                    "body": "<a href=\"https://feature-engine.readthedocs.io/en/1.1.x/selection/DropCorrelatedFeatures.html\" rel=\"nofollow noreferrer\">Feature-Engine</a> has a built in <code>DropCorrelatedFeatures()</code> transformer which does the heavy lifting for you &amp; is sklearn compatible. The <code>features_to_drop_</code> attribute shows which it will drop."
                },
                {
                    "owner": {
                        "account_id": 25298386,
                        "reputation": 17587,
                        "user_id": 19123103,
                        "user_type": "registered",
                        "display_name": "cottontail"
                    },
                    "edited": false,
                    "score": 0,
                    "creation_date": 1701444803,
                    "post_id": 29294983,
                    "comment_id": 136780130,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on#comment136780130_29294983",
                    "body": "<b>Related</b>: <a href=\"https://stackoverflow.com/a/75379515/19123103\">This answer</a> implements R\u2019s <code>findCorrelation</code> function in pandas. It identifies correlated columns and returns labels of all but one of them. The existing answers here drop all correlated columns which means too many columns are dropped."
                }
            ],
            "answers": [
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 2624951,
                                "reputation": 30859,
                                "user_id": 2272172,
                                "user_type": "registered",
                                "accept_rate": 68,
                                "display_name": "cel"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1427445634,
                            "post_id": 29295720,
                            "comment_id": 46788235,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/29295720#comment46788235_29295720",
                            "body": "While I totally agree with your reasoning, this does not really answer the question. <code>PCA</code>  is a more advanced concept for dimension reduction. But note that using correlations does work and the question is a reasonable (but definitely lacking research effort IMO)."
                        },
                        {
                            "owner": {
                                "account_id": 5990537,
                                "reputation": 4097,
                                "user_id": 4706745,
                                "user_type": "registered",
                                "accept_rate": 48,
                                "display_name": "jax"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1427447361,
                            "post_id": 29295720,
                            "comment_id": 46789131,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/29295720#comment46789131_29295720",
                            "body": "@Jamie bull Thanks for your kind reply before going to advanced techniques like dimensionality reduction(Ex. PCA ) or Feature selection method (Ex. Tree based or SVM based feature elimination ) it is always suggested to remove useless feature with the help of basic techniques (like variance calculation of correlation calculation), that  I  learned with the help of various published works available.  And as per the second part of your comment &quot;correlations by calling DataFrame.corr()&quot; would be helpful for my case."
                        },
                        {
                            "owner": {
                                "account_id": 2624951,
                                "reputation": 30859,
                                "user_id": 2272172,
                                "user_type": "registered",
                                "accept_rate": 68,
                                "display_name": "cel"
                            },
                            "reply_to_user": {
                                "account_id": 5990537,
                                "reputation": 4097,
                                "user_id": 4706745,
                                "user_type": "registered",
                                "accept_rate": 48,
                                "display_name": "jax"
                            },
                            "edited": false,
                            "score": 2,
                            "creation_date": 1427448053,
                            "post_id": 29295720,
                            "comment_id": 46789517,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/29295720#comment46789517_29295720",
                            "body": "@jax, <code>it is always suggested to remove useless feature with the help of basic techniques</code>. This is not true. There are various methods which do not require such a preprocessing step."
                        },
                        {
                            "owner": {
                                "account_id": 5990537,
                                "reputation": 4097,
                                "user_id": 4706745,
                                "user_type": "registered",
                                "accept_rate": 48,
                                "display_name": "jax"
                            },
                            "reply_to_user": {
                                "account_id": 2624951,
                                "reputation": 30859,
                                "user_id": 2272172,
                                "user_type": "registered",
                                "accept_rate": 68,
                                "display_name": "cel"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1427449560,
                            "post_id": 29295720,
                            "comment_id": 46790411,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/29295720#comment46790411_29295720",
                            "body": "@cel ok, actually i was following some published work so they have suggested the preprocessing steps. Can you please suggest me any one such method which not bother about preprocessing steps thanks  ."
                        },
                        {
                            "owner": {
                                "account_id": 1887671,
                                "reputation": 13279,
                                "user_id": 1706564,
                                "user_type": "registered",
                                "accept_rate": 80,
                                "display_name": "Jamie Bull"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1427459449,
                            "post_id": 29295720,
                            "comment_id": 46796044,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/29295720#comment46796044_29295720",
                            "body": "There&#39;s a discussion of when you should remove correlated variables before PCA <a href=\"http://stats.stackexchange.com/questions/50537/should-one-remove-highly-correlated-variables-before-doing-pca\">here</a>. It comes down to whether they are correlated because they are both influenced by each other or a third underlying feature, in which case there is an argument for removing one them. Or alternatively where they are correlated but not because they are truly related, in which case there is an argument for keeping both. This depends on understanding the variables and so isn&#39;t easily done algorithmically."
                        },
                        {
                            "owner": {
                                "account_id": 5990537,
                                "reputation": 4097,
                                "user_id": 4706745,
                                "user_type": "registered",
                                "accept_rate": 48,
                                "display_name": "jax"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1427470291,
                            "post_id": 29295720,
                            "comment_id": 46803241,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/29295720#comment46803241_29295720",
                            "body": "@JamieBull Thanks for your reply i have already been there(the web link you have suggested) before posting this. But if you have gone through  the Questions careful this post covers only half answer of the Question but i have already read a lot and hopefully soon i will post answer with my self. thanks a lot for all your support and interest. thanks"
                        }
                    ],
                    "owner": {
                        "account_id": 1887671,
                        "reputation": 13279,
                        "user_id": 1706564,
                        "user_type": "registered",
                        "accept_rate": 80,
                        "display_name": "Jamie Bull"
                    },
                    "comment_count": 6,
                    "is_accepted": false,
                    "score": 6,
                    "last_activity_date": 1427442691,
                    "creation_date": 1427442691,
                    "answer_id": 29295720,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/29295720#29295720",
                    "body": "<p>Firstly, I'd suggest using something like PCA as a <a href=\"http://scipy-lectures.github.io/advanced/scikit-learn/#dimension-reduction-with-principal-component-analysis\" rel=\"noreferrer\">dimensionality reduction</a> method, but if you have to roll your own then your question is insufficiently constrained. Where two columns are correlated, which one do you want to remove? What if column A is correlated with column B, while column B is correlated with column C, but not column A?</p>\n\n<p>You can get a pairwise matrix of correlations by calling <code>DataFrame.corr()</code> (<a href=\"http://pandas.pydata.org/pandas-docs/dev/generated/pandas.DataFrame.corr.html\" rel=\"noreferrer\">docs</a>) which might help you with developing your algorithm, but eventually you need to convert that into a list of columns to keep.</p>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 3761440,
                                "reputation": 2784,
                                "user_id": 3126298,
                                "user_type": "registered",
                                "accept_rate": 94,
                                "display_name": "n1k31t4"
                            },
                            "edited": false,
                            "score": 8,
                            "creation_date": 1497389446,
                            "post_id": 43104383,
                            "comment_id": 76055435,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/43104383#comment76055435_43104383",
                            "body": "This doesn&#39;t seem to work for me. The correlations are found and the pairs that match the threshold (i.e. have a higher correlation) are printed. But the resulting dataframe is only missing one (the first) variable, that has a high correlation."
                        }
                    ],
                    "owner": {
                        "account_id": 6848975,
                        "reputation": 921,
                        "user_id": 5266712,
                        "user_type": "registered",
                        "display_name": "TomDobbs"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 3,
                    "last_activity_date": 1490822520,
                    "creation_date": 1490822520,
                    "answer_id": 43104383,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/43104383#43104383",
                    "body": "<p>Plug your features dataframe in this function and just set your correlation threshold. It'll auto drop columns, but will also give you a diagnostic of the columns it drops if you want to do it manually.</p>\n\n<pre><code>def corr_df(x, corr_val):\n    '''\n    Obj: Drops features that are strongly correlated to other features.\n          This lowers model complexity, and aids in generalizing the model.\n    Inputs:\n          df: features df (x)\n          corr_val: Columns are dropped relative to the corr_val input (e.g. 0.8)\n    Output: df that only includes uncorrelated features\n    '''\n\n    # Creates Correlation Matrix and Instantiates\n    corr_matrix = x.corr()\n    iters = range(len(corr_matrix.columns) - 1)\n    drop_cols = []\n\n    # Iterates through Correlation Matrix Table to find correlated columns\n    for i in iters:\n        for j in range(i):\n            item = corr_matrix.iloc[j:(j+1), (i+1):(i+2)]\n            col = item.columns\n            row = item.index\n            val = item.values\n            if val &gt;= corr_val:\n                # Prints the correlated feature set and the corr val\n                print(col.values[0], \"|\", row.values[0], \"|\", round(val[0][0], 2))\n                drop_cols.append(i)\n\n    drops = sorted(set(drop_cols))[::-1]\n\n    # Drops the correlated columns\n    for i in drops:\n        col = x.iloc[:, (i+1):(i+2)].columns.values\n        df = x.drop(col, axis=1)\n\n    return df\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 10405235,
                                "reputation": 336,
                                "user_id": 7672370,
                                "user_type": "registered",
                                "accept_rate": 100,
                                "display_name": "vcovo"
                            },
                            "edited": false,
                            "score": 11,
                            "creation_date": 1550851684,
                            "post_id": 44674459,
                            "comment_id": 96436786,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/44674459#comment96436786_44674459",
                            "body": "I feel like this solution fails in the following general case:   Say you have columns c1, c2, and c3. c1 and c2 are correlated above the threshold, the same goes for c2 and c3.   With this solution both c2 and c3 will be dropped even though c3 may not be correlated with c1 above that threshold.     I suggest changing: <code>if corr_matrix.iloc[i, j] &gt;= threshold:</code>   To: <code>if corr_matrix.iloc[i, j] &gt;= threshold and (corr_matrix.columns[j] not in col_corr):</code>"
                        },
                        {
                            "owner": {
                                "account_id": 9131734,
                                "reputation": 605,
                                "user_id": 6793078,
                                "user_type": "registered",
                                "display_name": "Nisha Daga"
                            },
                            "reply_to_user": {
                                "account_id": 10405235,
                                "reputation": 336,
                                "user_id": 7672370,
                                "user_type": "registered",
                                "accept_rate": 100,
                                "display_name": "vcovo"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1550943806,
                            "post_id": 44674459,
                            "comment_id": 96461730,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/44674459#comment96461730_44674459",
                            "body": "@vcovo If c1 &amp; c2 are correlated and c2 &amp; c3 are correlated, then there is a high chance that c1 &amp; c3 will also be correlated. Although, if that is not true, then I believe that your suggestion of changing the code is correct."
                        },
                        {
                            "owner": {
                                "account_id": 10405235,
                                "reputation": 336,
                                "user_id": 7672370,
                                "user_type": "registered",
                                "accept_rate": 100,
                                "display_name": "vcovo"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1551037318,
                            "post_id": 44674459,
                            "comment_id": 96483073,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/44674459#comment96483073_44674459",
                            "body": "They most likely would be correlated but not necessarily above the same <code>threshold</code>. This lead to a significant difference in removed columns for my use case. I ended up with 218 columns instead of 180 when adding the additional condition mentioned in the first comment."
                        },
                        {
                            "owner": {
                                "account_id": 9131734,
                                "reputation": 605,
                                "user_id": 6793078,
                                "user_type": "registered",
                                "display_name": "Nisha Daga"
                            },
                            "reply_to_user": {
                                "account_id": 10405235,
                                "reputation": 336,
                                "user_id": 7672370,
                                "user_type": "registered",
                                "accept_rate": 100,
                                "display_name": "vcovo"
                            },
                            "edited": false,
                            "score": 3,
                            "creation_date": 1551191795,
                            "post_id": 44674459,
                            "comment_id": 96544851,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/44674459#comment96544851_44674459",
                            "body": "Makes sense. Have updated the code as per your suggestion."
                        },
                        {
                            "owner": {
                                "account_id": 6503350,
                                "reputation": 5419,
                                "user_id": 5033247,
                                "user_type": "registered",
                                "display_name": "Smart Manoj"
                            },
                            "reply_to_user": {
                                "account_id": 10405235,
                                "reputation": 336,
                                "user_id": 7672370,
                                "user_type": "registered",
                                "accept_rate": 100,
                                "display_name": "vcovo"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1598029550,
                            "post_id": 44674459,
                            "comment_id": 112335058,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/44674459#comment112335058_44674459",
                            "body": "@vcovo if c1 and c2  only correlated, how do we choose the best column to remove?"
                        },
                        {
                            "owner": {
                                "account_id": 10405235,
                                "reputation": 336,
                                "user_id": 7672370,
                                "user_type": "registered",
                                "accept_rate": 100,
                                "display_name": "vcovo"
                            },
                            "reply_to_user": {
                                "account_id": 6503350,
                                "reputation": 5419,
                                "user_id": 5033247,
                                "user_type": "registered",
                                "display_name": "Smart Manoj"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1598981866,
                            "post_id": 44674459,
                            "comment_id": 112630093,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/44674459#comment112630093_44674459",
                            "body": "@SmartManoj in my use case I just wanted to minimize the number of columns and thus removed highly correlated ones. I had no preference for which one to keep and thus removed the second one (as in the rightmost column). I suppose you could create a metric that takes in to account the correlation between each column and all others and then when presented with a highly correlated pair remove the one that is most correlated with all other columns (in order to preserve a little more of the variance)."
                        },
                        {
                            "owner": {
                                "account_id": 1375078,
                                "reputation": 545,
                                "user_id": 1309231,
                                "user_type": "registered",
                                "accept_rate": 100,
                                "display_name": "hipoglucido"
                            },
                            "edited": false,
                            "score": 2,
                            "creation_date": 1601739616,
                            "post_id": 44674459,
                            "comment_id": 113502066,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/44674459#comment113502066_44674459",
                            "body": "Shouldn&#39;t you use the absolute value of the correlation matrix?"
                        },
                        {
                            "owner": {
                                "account_id": 9894293,
                                "reputation": 512,
                                "user_id": 7450545,
                                "user_type": "registered",
                                "accept_rate": 100,
                                "display_name": "Anonymous"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1620034956,
                            "post_id": 44674459,
                            "comment_id": 119073228,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/44674459#comment119073228_44674459",
                            "body": "Indeed, absolute value makes much more sense as -0.9 is just as strong as 0.9"
                        }
                    ],
                    "owner": {
                        "account_id": 9131734,
                        "reputation": 605,
                        "user_id": 6793078,
                        "user_type": "registered",
                        "display_name": "Nisha Daga"
                    },
                    "comment_count": 8,
                    "is_accepted": false,
                    "score": 51,
                    "last_activity_date": 1551191851,
                    "last_edit_date": 1551191851,
                    "creation_date": 1498043468,
                    "answer_id": 44674459,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/44674459#44674459",
                    "body": "<p>Here is the approach which I have used - </p>\n\n<pre><code>def correlation(dataset, threshold):\n    col_corr = set() # Set of all the names of deleted columns\n    corr_matrix = dataset.corr()\n    for i in range(len(corr_matrix.columns)):\n        for j in range(i):\n            if (corr_matrix.iloc[i, j] &gt;= threshold) and (corr_matrix.columns[j] not in col_corr):\n                colname = corr_matrix.columns[i] # getting the name of column\n                col_corr.add(colname)\n                if colname in dataset.columns:\n                    del dataset[colname] # deleting the column from the dataset\n\n    print(dataset)\n</code></pre>\n\n<p>Hope this helps!</p>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 1596121,
                                "reputation": 1362,
                                "user_id": 1478204,
                                "user_type": "registered",
                                "accept_rate": 58,
                                "display_name": "MyopicVisage"
                            },
                            "edited": false,
                            "score": 2,
                            "creation_date": 1501876488,
                            "post_id": 45225458,
                            "comment_id": 77990441,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/45225458#comment77990441_45225458",
                            "body": "This did not work for me. Please consider rewriting your solution as a method. Error: &quot;ValueError: too many values to unpack (expected 2)&quot;."
                        },
                        {
                            "owner": {
                                "account_id": 6199398,
                                "reputation": 20775,
                                "user_id": 6885902,
                                "user_type": "registered",
                                "display_name": "Jeru Luke"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1506444409,
                            "post_id": 45225458,
                            "comment_id": 79820935,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/45225458#comment79820935_45225458",
                            "body": "It should rather be <code>high_corr_var=[(corr_matrix.index[x],corr_matrix.columns[y]) for x,y in zip(*high_corr_var) if x!=y and x&lt;y]</code>"
                        }
                    ],
                    "owner": {
                        "account_id": 9634327,
                        "reputation": 355,
                        "user_id": 7151006,
                        "user_type": "registered",
                        "display_name": "Mojgan Mazouchi"
                    },
                    "comment_count": 2,
                    "is_accepted": false,
                    "score": 8,
                    "last_activity_date": 1516126080,
                    "last_edit_date": 1516126080,
                    "creation_date": 1500585852,
                    "answer_id": 45225458,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/45225458#45225458",
                    "body": "<p>You can use the following for a given data frame df:</p>\n\n<pre><code>corr_matrix = df.corr().abs()\nhigh_corr_var=np.where(corr_matrix&gt;0.8)\nhigh_corr_var=[(corr_matrix.columns[x],corr_matrix.columns[y]) for x,y in zip(*high_corr_var) if x!=y and x&lt;y]\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 3413983,
                                "reputation": 755,
                                "user_id": 2863366,
                                "user_type": "registered",
                                "accept_rate": 80,
                                "display_name": "Ryan"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1549466760,
                            "post_id": 51658973,
                            "comment_id": 95913686,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/51658973#comment95913686_51658973",
                            "body": "The loops you have here skip the first two columns of the corr_matrix, and so correlation between col1 &amp; col2 is not considered, after that looks ok"
                        },
                        {
                            "owner": {
                                "account_id": 7114311,
                                "reputation": 156,
                                "user_id": 5441163,
                                "user_type": "registered",
                                "accept_rate": 71,
                                "display_name": "poPYtheSailor"
                            },
                            "reply_to_user": {
                                "account_id": 3413983,
                                "reputation": 755,
                                "user_id": 2863366,
                                "user_type": "registered",
                                "accept_rate": 80,
                                "display_name": "Ryan"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1552973967,
                            "post_id": 51658973,
                            "comment_id": 97202135,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/51658973#comment97202135_51658973",
                            "body": "@Ryan How did you fix that?"
                        },
                        {
                            "owner": {
                                "account_id": 3413983,
                                "reputation": 755,
                                "user_id": 2863366,
                                "user_type": "registered",
                                "accept_rate": 80,
                                "display_name": "Ryan"
                            },
                            "reply_to_user": {
                                "account_id": 7114311,
                                "reputation": 156,
                                "user_id": 5441163,
                                "user_type": "registered",
                                "accept_rate": 71,
                                "display_name": "poPYtheSailor"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1554124149,
                            "post_id": 51658973,
                            "comment_id": 97625002,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/51658973#comment97625002_51658973",
                            "body": "@poPYtheSailor Please see my posted solution"
                        }
                    ],
                    "owner": {
                        "account_id": 3628910,
                        "reputation": 399,
                        "user_id": 3025698,
                        "user_type": "registered",
                        "accept_rate": 50,
                        "display_name": "azuber"
                    },
                    "comment_count": 3,
                    "is_accepted": false,
                    "score": 5,
                    "last_activity_date": 1533229920,
                    "creation_date": 1533229920,
                    "answer_id": 51658973,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/51658973#51658973",
                    "body": "<p>I took the liberty to modify TomDobbs' answer. The reported bug in the comments is removed now. Also, the new function filters out the negative correlation, too.</p>\n\n<pre><code>def corr_df(x, corr_val):\n    '''\n    Obj: Drops features that are strongly correlated to other features.\n          This lowers model complexity, and aids in generalizing the model.\n    Inputs:\n          df: features df (x)\n          corr_val: Columns are dropped relative to the corr_val input (e.g. 0.8)\n    Output: df that only includes uncorrelated features\n    '''\n\n    # Creates Correlation Matrix and Instantiates\n    corr_matrix = x.corr()\n    iters = range(len(corr_matrix.columns) - 1)\n    drop_cols = []\n\n    # Iterates through Correlation Matrix Table to find correlated columns\n    for i in iters:\n        for j in range(i):\n            item = corr_matrix.iloc[j:(j+1), (i+1):(i+2)]\n            col = item.columns\n            row = item.index\n            val = item.values\n            if abs(val) &gt;= corr_val:\n                # Prints the correlated feature set and the corr val\n                print(col.values[0], \"|\", row.values[0], \"|\", round(val[0][0], 2))\n                drop_cols.append(i)\n\n    drops = sorted(set(drop_cols))[::-1]\n\n    # Drops the correlated columns\n    for i in drops:\n        col = x.iloc[:, (i+1):(i+2)].columns.values\n        x = x.drop(col, axis=1)\n    return x\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 8036269,
                                "reputation": 457,
                                "user_id": 6059273,
                                "user_type": "registered",
                                "accept_rate": 25,
                                "display_name": "Sushant Kulkarni"
                            },
                            "edited": false,
                            "score": 11,
                            "creation_date": 1573099101,
                            "post_id": 52509954,
                            "comment_id": 103773029,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/52509954#comment103773029_52509954",
                            "body": "isn&#39;t this flawed? Always first column is dropped even though it might not be highly correlated with any other column. when upper triangle is selected none of the first col value remains"
                        },
                        {
                            "owner": {
                                "account_id": 2384124,
                                "reputation": 3974,
                                "user_id": 2085454,
                                "user_type": "registered",
                                "accept_rate": 71,
                                "display_name": "Cherry Wu"
                            },
                            "reply_to_user": {
                                "account_id": 8036269,
                                "reputation": 457,
                                "user_id": 6059273,
                                "user_type": "registered",
                                "accept_rate": 25,
                                "display_name": "Sushant Kulkarni"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1573100566,
                            "post_id": 52509954,
                            "comment_id": 103773304,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/52509954#comment103773304_52509954",
                            "body": "have you ever output corr_matrix and see what does it look like first?"
                        },
                        {
                            "owner": {
                                "account_id": 14222505,
                                "reputation": 2043,
                                "user_id": 10275943,
                                "user_type": "registered",
                                "display_name": "Ikbel"
                            },
                            "edited": false,
                            "score": 3,
                            "creation_date": 1573141853,
                            "post_id": 52509954,
                            "comment_id": 103792804,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/52509954#comment103792804_52509954",
                            "body": "I got  an error  while dropping the selected  features, the  following code  worked for me    <code>df.drop(to_drop,axis=1,inplace=True)</code>"
                        },
                        {
                            "owner": {
                                "account_id": 2384124,
                                "reputation": 3974,
                                "user_id": 2085454,
                                "user_type": "registered",
                                "accept_rate": 71,
                                "display_name": "Cherry Wu"
                            },
                            "reply_to_user": {
                                "account_id": 14222505,
                                "reputation": 2043,
                                "user_id": 10275943,
                                "user_type": "registered",
                                "display_name": "Ikbel"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1573154215,
                            "post_id": 52509954,
                            "comment_id": 103798776,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/52509954#comment103798776_52509954",
                            "body": "@ikbelbenabdessamad yeah, your code is better. I just updated that old version code, thank you!"
                        },
                        {
                            "owner": {
                                "account_id": 10251131,
                                "reputation": 5855,
                                "user_id": 8682568,
                                "user_type": "registered",
                                "display_name": "Sunit Gautam"
                            },
                            "edited": false,
                            "score": 4,
                            "creation_date": 1604784169,
                            "post_id": 52509954,
                            "comment_id": 114454171,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/52509954#comment114454171_52509954",
                            "body": "As of the date of writing this comment, this seems to be working fine. I cross-checked for varying thresholds using other methods provided in answers, and results were identical. Thanks!"
                        },
                        {
                            "owner": {
                                "account_id": 8392377,
                                "reputation": 3617,
                                "user_id": 6300703,
                                "user_type": "registered",
                                "accept_rate": 50,
                                "display_name": "Rishabh Agrahari"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1619773998,
                            "post_id": 52509954,
                            "comment_id": 119011526,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/52509954#comment119011526_52509954",
                            "body": "This will drop all columns with corr &gt; 0.95, we want to drop all except one."
                        },
                        {
                            "owner": {
                                "account_id": 463283,
                                "reputation": 16261,
                                "user_id": 866082,
                                "user_type": "registered",
                                "accept_rate": 74,
                                "display_name": "Mehran"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1640574373,
                            "post_id": 52509954,
                            "comment_id": 124607235,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/52509954#comment124607235_52509954",
                            "body": "It should be <code>corr_matrix.where((np.triu(np.ones(corr_matrix.shape), k=1) + np.tril(np.ones(corr_matrix.shape), k=-1)).astype(bool))</code>. Your code does not consider the first column at all."
                        }
                    ],
                    "owner": {
                        "account_id": 2384124,
                        "reputation": 3974,
                        "user_id": 2085454,
                        "user_type": "registered",
                        "accept_rate": 71,
                        "display_name": "Cherry Wu"
                    },
                    "comment_count": 7,
                    "is_accepted": false,
                    "score": 83,
                    "last_activity_date": 1678577770,
                    "last_edit_date": 1678577770,
                    "creation_date": 1537936031,
                    "answer_id": 52509954,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/52509954#52509954",
                    "body": "<p>The method here worked well for me, only a few lines of code: <a href=\"https://chrisalbon.com/machine_learning/feature_selection/drop_highly_correlated_features/\" rel=\"noreferrer\">https://chrisalbon.com/machine_learning/feature_selection/drop_highly_correlated_features/</a></p>\n<pre><code>import numpy as np\n\n# Create correlation matrix\ncorr_matrix = df.corr().abs()\n\n# Select upper triangle of correlation matrix\nupper = corr_matrix.where(np.triu(np.ones(corr_matrix.shape), k=1).astype(bool))\n\n# Find features with correlation greater than 0.95\nto_drop = [column for column in upper.columns if any(upper[column] &gt; 0.95)]\n\n# Drop features \ndf.drop(to_drop, axis=1, inplace=True)\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 3413983,
                        "reputation": 755,
                        "user_id": 2863366,
                        "user_type": "registered",
                        "accept_rate": 80,
                        "display_name": "Ryan"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 1,
                    "last_activity_date": 1554124076,
                    "creation_date": 1554124076,
                    "answer_id": 55455901,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/55455901#55455901",
                    "body": "<p>A small revision to the solution posted by user3025698 that resolves an issue where the correlation between the first two columns is not captured and some data type checking.</p>\n\n<pre><code>def filter_df_corr(inp_data, corr_val):\n    '''\n    Returns an array or dataframe (based on type(inp_data) adjusted to drop \\\n        columns with high correlation to one another. Takes second arg corr_val\n        that defines the cutoff\n\n    ----------\n    inp_data : np.array, pd.DataFrame\n        Values to consider\n    corr_val : float\n        Value [0, 1] on which to base the correlation cutoff\n    '''\n    # Creates Correlation Matrix\n    if isinstance(inp_data, np.ndarray):\n        inp_data = pd.DataFrame(data=inp_data)\n        array_flag = True\n    else:\n        array_flag = False\n    corr_matrix = inp_data.corr()\n\n    # Iterates through Correlation Matrix Table to find correlated columns\n    drop_cols = []\n    n_cols = len(corr_matrix.columns)\n\n    for i in range(n_cols):\n        for k in range(i+1, n_cols):\n            val = corr_matrix.iloc[k, i]\n            col = corr_matrix.columns[i]\n            row = corr_matrix.index[k]\n            if abs(val) &gt;= corr_val:\n                # Prints the correlated feature set and the corr val\n                print(col, \"|\", row, \"|\", round(val, 2))\n                drop_cols.append(col)\n\n    # Drops the correlated columns\n    drop_cols = set(drop_cols)\n    inp_data = inp_data.drop(columns=drop_cols)\n    # Return same type as inp\n    if array_flag:\n        return inp_data.values\n    else:\n        return inp_data\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 3977858,
                        "reputation": 651,
                        "user_id": 3280613,
                        "user_type": "registered",
                        "accept_rate": 50,
                        "display_name": "Celso"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1576599373,
                    "creation_date": 1576599373,
                    "answer_id": 59378184,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/59378184#59378184",
                    "body": "<p>This is the approach I used on my job last month. Perhaps it is not the best or quickest way, but it works fine. Here, df is my original Pandas dataframe:</p>\n\n<pre><code>dropvars = []\nthreshold = 0.95\ndf_corr = df.corr().stack().reset_index().rename(columns={'level_0': 'Var 1', 'level_1': 'Var 2', 0: 'Corr'})\ndf_corr = df_corr[(df_corr['Corr'].abs() &gt;= threshold) &amp; (df_corr['Var 1'] != df_corr['Var 2'])]\nwhile len(df_corr) &gt; 0:\n    var = df_corr['Var 1'].iloc[0]\n    df_corr = df_corr[((df_corr['Var 1'] != var) &amp; (df_corr['Var 2'] != var))]\n    dropvars.append(var)\ndf.drop(columns=dropvars, inplace=True)\n</code></pre>\n\n<p>My idea is as follows: first, I create a dataframe containing columna Var 1, Var 2 and Corr, where I keep only those pairs of variables whose correlation is higher than or equal my threshold (in absolute value). Then, I iteratively choose the first variable (Var 1 value) in this correlations dataframe, add it to dropvar list, and remove all lines of the correlations dataframe where it appears, until my correlations dataframe is empty. In the end, I remove the columns in my dropvar list from my original dataframe.</p>\n"
                },
                {
                    "owner": {
                        "account_id": 15168747,
                        "reputation": 1,
                        "user_id": 12654335,
                        "user_type": "registered",
                        "display_name": "b-shields"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1578179193,
                    "creation_date": 1578179193,
                    "answer_id": 59595612,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/59595612#59595612",
                    "body": "<p>I had a similar question today and came across this post. This is what I ended up with.</p>\n\n<pre><code>def uncorrelated_features(df, threshold=0.7):\n    \"\"\"\n    Returns a subset of df columns with Pearson correlations\n    below threshold.\n    \"\"\"\n\n    corr = df.corr().abs()\n    keep = []\n    for i in range(len(corr.iloc[:,0])):\n        above = corr.iloc[:i,i]\n        if len(keep) &gt; 0: above = above[keep]\n        if len(above[above &lt; threshold]) == len(above):\n            keep.append(corr.columns.values[i])\n\n    return df[keep]\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 3747484,
                                "reputation": 4143,
                                "user_id": 3115822,
                                "user_type": "registered",
                                "display_name": "Borja"
                            },
                            "edited": false,
                            "score": 3,
                            "creation_date": 1581675719,
                            "post_id": 60223949,
                            "comment_id": 106524385,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/60223949#comment106524385_60223949",
                            "body": "While this code may provide a solution to the question, it&#39;s better to add context as to why/how it works. This can help future users learn, and apply that knowledge to their own code. You are also likely to have positive feedback from users in the form of upvotes, when the code is explained."
                        }
                    ],
                    "owner": {
                        "account_id": 16171358,
                        "reputation": 301,
                        "user_id": 11675071,
                        "user_type": "registered",
                        "display_name": "abakar"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 9,
                    "last_activity_date": 1595405901,
                    "last_edit_date": 1595405901,
                    "creation_date": 1581674164,
                    "answer_id": 60223949,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/60223949#60223949",
                    "body": "<p>You can test this code below ?</p>\n<h1>Load libraries import</h1>\n<pre><code>  pandas as pd\n  import numpy as np\n# Create feature matrix with two highly correlated features\n\nX = np.array([[1, 1, 1],\n          [2, 2, 0],\n          [3, 3, 1],\n          [4, 4, 0],\n          [5, 5, 1],\n          [6, 6, 0],\n          [7, 7, 1],\n          [8, 7, 0],\n          [9, 7, 1]])\n\n# Convert feature matrix into DataFrame\ndf = pd.DataFrame(X)\n\n# View the data frame\ndf\n\n# Create correlation matrix\ncorr_matrix = df.corr().abs()\n\n# Select upper triangle of correlation matrix\nupper = corr_matrix.where(np.triu(np.ones(corr_matrix.shape), k=1).astype(np.bool))\n\n# Find index of feature columns with correlation greater than 0.95\nto_drop = [column for column in upper.columns if any(upper[column] &gt; 0.95)]\n# Drop features \ndf.drop(df[to_drop], axis=1)\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 18252184,
                        "reputation": 1,
                        "user_id": 13286959,
                        "user_type": "registered",
                        "display_name": "amin sharifi"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1586612841,
                    "creation_date": 1586612841,
                    "answer_id": 61157789,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/61157789#61157789",
                    "body": "<p>I write my own way without any for loop to delete high covariance data from pandas dataframe</p>\n\n<pre><code>#get co variance of data\ncoVar = df.corr() # or df.corr().abs()\nthreshold = 0.5 # \n\"\"\"\n1. .where(coVar != 1.0) set NaN where col and index is 1\n2. .where(coVar &gt;= threshold) if not greater than threshold set Nan\n3. .fillna(0) Fill NaN with 0\n4. .sum() convert data frame to serise with sum() and just where is co var greater than threshold sum it\n5. &gt; 0 convert all Series to Boolean\n\"\"\"\n\ncoVarCols = coVar.where(coVar != 1.0).where(coVar &gt;=threshold).fillna(0).sum() &gt; 0\n\n# Not Boolean Becuase we need to delete where is co var greater than threshold \ncoVarCols = ~coVarCols\n\n# get where you want\ndf[coVarCols[coVarCols].index]\n</code></pre>\n\n<p>I hope that's can help to use own pandas function to work with out any for loop, That's can help Improve your speed in big dataset</p>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 18478604,
                                "reputation": 133,
                                "user_id": 13461439,
                                "user_type": "registered",
                                "display_name": "SQLGIT_GeekInTraining"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1604133661,
                            "post_id": 61938339,
                            "comment_id": 114258679,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/61938339#comment114258679_61938339",
                            "body": "I really liked it! Have used it for a model I&#39;m building and really easy to understand - thanks a ton for this."
                        }
                    ],
                    "owner": {
                        "account_id": 6810555,
                        "reputation": 145,
                        "user_id": 5240904,
                        "user_type": "registered",
                        "display_name": "Synergix"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 10,
                    "last_activity_date": 1590159246,
                    "last_edit_date": 1590159246,
                    "creation_date": 1590075906,
                    "answer_id": 61938339,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/61938339#61938339",
                    "body": "<p>I found the <a href=\"https://stackoverflow.com/a/43104383/5240904\">answer provided by TomDobbs</a> quite useful, however it doesn't work as intended. It has two problems:</p>\n\n<ul>\n<li>it misses the last pair of variables in each of correlation matrix rows/columns.</li>\n<li>it fails to remove one of each pair of collinear variables from the returned dataframe.</li>\n</ul>\n\n<p>My revised version below corrects these issues:</p>\n\n<pre><code>def remove_collinear_features(x, threshold):\n    '''\n    Objective:\n        Remove collinear features in a dataframe with a correlation coefficient\n        greater than the threshold. Removing collinear features can help a model \n        to generalize and improves the interpretability of the model.\n\n    Inputs: \n        x: features dataframe\n        threshold: features with correlations greater than this value are removed\n\n    Output: \n        dataframe that contains only the non-highly-collinear features\n    '''\n\n    # Calculate the correlation matrix\n    corr_matrix = x.corr()\n    iters = range(len(corr_matrix.columns) - 1)\n    drop_cols = []\n\n    # Iterate through the correlation matrix and compare correlations\n    for i in iters:\n        for j in range(i+1):\n            item = corr_matrix.iloc[j:(j+1), (i+1):(i+2)]\n            col = item.columns\n            row = item.index\n            val = abs(item.values)\n\n            # If correlation exceeds the threshold\n            if val &gt;= threshold:\n                # Print the correlated features and the correlation value\n                print(col.values[0], \"|\", row.values[0], \"|\", round(val[0][0], 2))\n                drop_cols.append(col.values[0])\n\n    # Drop one of each pair of correlated columns\n    drops = set(drop_cols)\n    x = x.drop(columns=drops)\n\n    return x\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 406692,
                                "reputation": 3993,
                                "user_id": 776348,
                                "user_type": "registered",
                                "accept_rate": 94,
                                "display_name": "Bedir Yilmaz"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1595268983,
                            "post_id": 63001184,
                            "comment_id": 111410382,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/63001184#comment111410382_63001184",
                            "body": "Hi! Welcome to SO. Thank you for the contribution! Here is a guide on how to share your knowledge: <a href=\"https://stackoverflow.blog/2011/07/01/its-ok-to-ask-and-answer-your-own-questions/\">stackoverflow.blog/2011/07/01/&hellip;</a>"
                        }
                    ],
                    "owner": {
                        "account_id": 19120383,
                        "reputation": 21,
                        "user_id": 13964475,
                        "user_type": "registered",
                        "display_name": "tdogan"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 2,
                    "last_activity_date": 1595268135,
                    "last_edit_date": 1595268135,
                    "creation_date": 1595267561,
                    "answer_id": 63001184,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/63001184#63001184",
                    "body": "<p>If you run out of memory due to pandas .corr() you may find the following solution useful:</p>\n<pre><code>    import numpy as np \n    from numba import jit\n    \n    @jit(nopython=True)\n    def corr_filter(X, threshold):\n        n = X.shape[1]\n        columns = np.ones((n,))\n        for i in range(n-1):\n            for j in range(i+1, n):\n                if columns[j] == 1:\n                    correlation = np.abs(np.corrcoef(X[:,i], X[:,j])[0,1])\n                    if correlation &gt;= threshold:\n                        columns[j] = 0\n        return columns\n    \n    columns = corr_filter(df.values, 0.7).astype(bool) \n    selected_columns = df.columns[columns]\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 2562614,
                        "reputation": 1494,
                        "user_id": 2223440,
                        "user_type": "registered",
                        "accept_rate": 81,
                        "display_name": "Chandan"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1596326838,
                    "creation_date": 1596326838,
                    "answer_id": 63211169,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/63211169#63211169",
                    "body": "<pre><code>correlatedColumns = []\ncorr = df.corr()\nindices = corr.index\ncolumns = corr.columns\nposthreshold = 0.7\nnegthreshold = -0.7\n\nfor c in columns:\n    for r in indices:\n        if c != r and (corr[c][r] &gt; posthreshold or corr[c][r] &lt; negthreshold):\n            correlatedColumns.append({&quot;column&quot; : c , &quot;row&quot; : r , &quot;val&quot; :corr[c][r] })\n            \n\nprint(correlatedColumns)\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 5461637,
                                "reputation": 656,
                                "user_id": 4343563,
                                "user_type": "registered",
                                "accept_rate": 50,
                                "display_name": "mjoy"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1654694681,
                            "post_id": 63372091,
                            "comment_id": 128152121,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/63372091#comment128152121_63372091",
                            "body": "Can you provide an example of how to use?"
                        },
                        {
                            "owner": {
                                "account_id": 5966511,
                                "reputation": 1593,
                                "user_id": 4690180,
                                "user_type": "registered",
                                "accept_rate": 100,
                                "display_name": "JejeBelfort"
                            },
                            "reply_to_user": {
                                "account_id": 5461637,
                                "reputation": 656,
                                "user_id": 4343563,
                                "user_type": "registered",
                                "accept_rate": 50,
                                "display_name": "mjoy"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1674632477,
                            "post_id": 63372091,
                            "comment_id": 132753403,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/63372091#comment132753403_63372091",
                            "body": "@mjoy Here is an example: <code>my_eliminator = MultiCollinearityEliminator(df, &#39;my_target&#39;, 0.95)</code> then you can call the following function: <code>cleaned_df_no_multi_collinearity = my_eliminator.autoEliminateMulticollinearity()</code>. NB: The dataframe <code>df</code> must contain the target variable column <code>&#39;my_target&#39;</code>"
                        }
                    ],
                    "owner": {
                        "account_id": 18183906,
                        "reputation": 173,
                        "user_id": 13231078,
                        "user_type": "registered",
                        "display_name": "Joseph Jacob"
                    },
                    "comment_count": 2,
                    "is_accepted": false,
                    "score": 12,
                    "last_activity_date": 1597218531,
                    "creation_date": 1597218531,
                    "answer_id": 63372091,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/63372091#63372091",
                    "body": "<p>Here is an Auto ML class I created to eliminate multicollinearity between features.</p>\n<p>What makes my code unique is that out two features that have high correlation, I have eliminated the feature that is least correlated with the target! I got the idea from this seminar by Vishal Patel Sir - <a href=\"https://www.youtube.com/watch?v=ioXKxulmwVQ&amp;feature=youtu.be\" rel=\"noreferrer\">https://www.youtube.com/watch?v=ioXKxulmwVQ&amp;feature=youtu.be</a></p>\n<pre><code>#Feature selection class to eliminate multicollinearity\nclass MultiCollinearityEliminator():\n    \n    #Class Constructor\n    def __init__(self, df, target, threshold):\n        self.df = df\n        self.target = target\n        self.threshold = threshold\n\n    #Method to create and return the feature correlation matrix dataframe\n    def createCorrMatrix(self, include_target = False):\n        #Checking we should include the target in the correlation matrix\n        if (include_target == False):\n            df_temp = self.df.drop([self.target], axis =1)\n            \n            #Setting method to Pearson to prevent issues in case the default method for df.corr() gets changed\n            #Setting min_period to 30 for the sample size to be statistically significant (normal) according to \n            #central limit theorem\n            corrMatrix = df_temp.corr(method='pearson', min_periods=30).abs()\n        #Target is included for creating the series of feature to target correlation - Please refer the notes under the \n        #print statement to understand why we create the series of feature to target correlation\n        elif (include_target == True):\n            corrMatrix = self.df.corr(method='pearson', min_periods=30).abs()\n        return corrMatrix\n\n    #Method to create and return the feature to target correlation matrix dataframe\n    def createCorrMatrixWithTarget(self):\n        #After obtaining the list of correlated features, this method will help to view which variables \n        #(in the list of correlated features) are least correlated with the target\n        #This way, out the list of correlated features, we can ensure to elimate the feature that is \n        #least correlated with the target\n        #This not only helps to sustain the predictive power of the model but also helps in reducing model complexity\n        \n        #Obtaining the correlation matrix of the dataframe (along with the target)\n        corrMatrix = self.createCorrMatrix(include_target = True)                           \n        #Creating the required dataframe, then dropping the target row \n        #and sorting by the value of correlation with target (in asceding order)\n        corrWithTarget = pd.DataFrame(corrMatrix.loc[:,self.target]).drop([self.target], axis = 0).sort_values(by = self.target)                    \n        print(corrWithTarget, '\\n')\n        return corrWithTarget\n\n    #Method to create and return the list of correlated features\n    def createCorrelatedFeaturesList(self):\n        #Obtaining the correlation matrix of the dataframe (without the target)\n        corrMatrix = self.createCorrMatrix(include_target = False)                          \n        colCorr = []\n        #Iterating through the columns of the correlation matrix dataframe\n        for column in corrMatrix.columns:\n            #Iterating through the values (row wise) of the correlation matrix dataframe\n            for idx, row in corrMatrix.iterrows():                                            \n                if(row[column]&gt;self.threshold) and (row[column]&lt;1):\n                    #Adding the features that are not already in the list of correlated features\n                    if (idx not in colCorr):\n                        colCorr.append(idx)\n                    if (column not in colCorr):\n                        colCorr.append(column)\n        print(colCorr, '\\n')\n        return colCorr\n\n    #Method to eliminate the least important features from the list of correlated features\n    def deleteFeatures(self, colCorr):\n        #Obtaining the feature to target correlation matrix dataframe\n        corrWithTarget = self.createCorrMatrixWithTarget()                                  \n        for idx, row in corrWithTarget.iterrows():\n            print(idx, '\\n')\n            if (idx in colCorr):\n                self.df = self.df.drop(idx, axis =1)\n                break\n        return self.df\n\n    #Method to run automatically eliminate multicollinearity\n    def autoEliminateMulticollinearity(self):\n        #Obtaining the list of correlated features\n        colCorr = self.createCorrelatedFeaturesList()                                       \n        while colCorr != []:\n            #Obtaining the dataframe after deleting the feature (from the list of correlated features) \n            #that is least correlated with the taregt\n            self.df = self.deleteFeatures(colCorr)\n            #Obtaining the list of correlated features\n            colCorr = self.createCorrelatedFeaturesList()                                     \n        return self.df\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 6503350,
                                "reputation": 5419,
                                "user_id": 5033247,
                                "user_type": "registered",
                                "display_name": "Smart Manoj"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1600221075,
                            "post_id": 63905398,
                            "comment_id": 113016503,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/63905398#comment113016503_63905398",
                            "body": "<a href=\"https://stackoverflow.com/a/4591139\">Is it safe to replace &#39;==&#39; with &#39;is&#39; to compare Boolean-values</a>"
                        },
                        {
                            "owner": {
                                "account_id": 14043397,
                                "reputation": 481,
                                "user_id": 10144278,
                                "user_type": "registered",
                                "display_name": "Yi\u011fit Can Ta\u015fo\u011flu"
                            },
                            "edited": false,
                            "score": 0,
                            "creation_date": 1631968737,
                            "post_id": 63905398,
                            "comment_id": 122369812,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/63905398#comment122369812_63905398",
                            "body": "If we will add abs( ) function while calculating the correlation value between target and feature, we will not see negative correlation value.  It is important because when we have negative correlation code drops smaller one which has stronger negative correlation value. ///                                                  col_corr = abs(df_model[col.values[0]].corr(df_model[target_var]))"
                        }
                    ],
                    "owner": {
                        "account_id": 2159504,
                        "reputation": 188,
                        "user_id": 1914006,
                        "user_type": "registered",
                        "display_name": "Emkan"
                    },
                    "comment_count": 2,
                    "is_accepted": false,
                    "score": 3,
                    "last_activity_date": 1600257074,
                    "last_edit_date": 1600257074,
                    "creation_date": 1600184643,
                    "answer_id": 63905398,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/63905398#63905398",
                    "body": "<p>At first, thanks to TomDobbs and Synergix for their code. Below I am sharing my modifield version with some additions:</p>\n<ol>\n<li>Between two correlated variables this function drops a variable which has the least correlation with the target variable</li>\n<li>Added some useful logs (set verbose to True for log printing)</li>\n</ol>\n<pre class=\"lang-py prettyprint-override\"><code>def remove_collinear_features(df_model, target_var, threshold, verbose):\n    '''\n    Objective:\n        Remove collinear features in a dataframe with a correlation coefficient\n        greater than the threshold and which have the least correlation with the target (dependent) variable. Removing collinear features can help a model \n        to generalize and improves the interpretability of the model.\n\n    Inputs: \n        df_model: features dataframe\n        target_var: target (dependent) variable\n        threshold: features with correlations greater than this value are removed\n        verbose: set to &quot;True&quot; for the log printing\n\n    Output: \n        dataframe that contains only the non-highly-collinear features\n    '''\n\n    # Calculate the correlation matrix\n    corr_matrix = df_model.drop(target_var, 1).corr()\n    iters = range(len(corr_matrix.columns) - 1)\n    drop_cols = []\n    dropped_feature = &quot;&quot;\n\n    # Iterate through the correlation matrix and compare correlations\n    for i in iters:\n        for j in range(i+1): \n            item = corr_matrix.iloc[j:(j+1), (i+1):(i+2)]\n            col = item.columns\n            row = item.index\n            val = abs(item.values)\n\n            # If correlation exceeds the threshold\n            if val &gt;= threshold:\n                # Print the correlated features and the correlation value\n                if verbose:\n                    print(col.values[0], &quot;|&quot;, row.values[0], &quot;|&quot;, round(val[0][0], 2))\n                col_value_corr = df_model[col.values[0]].corr(df_model[target_var])\n                row_value_corr = df_model[row.values[0]].corr(df_model[target_var])\n                if verbose:\n                    print(&quot;{}: {}&quot;.format(col.values[0], np.round(col_value_corr, 3)))\n                    print(&quot;{}: {}&quot;.format(row.values[0], np.round(row_value_corr, 3)))\n                if col_value_corr &lt; row_value_corr:\n                    drop_cols.append(col.values[0])\n                    dropped_feature = &quot;dropped: &quot; + col.values[0]\n                else:\n                    drop_cols.append(row.values[0])\n                    dropped_feature = &quot;dropped: &quot; + row.values[0]\n                if verbose:\n                    print(dropped_feature)\n                    print(&quot;-----------------------------------------------------------------------------&quot;)\n\n    # Drop one of each pair of correlated columns\n    drops = set(drop_cols)\n    df_model = df_model.drop(columns=drops)\n\n    print(&quot;dropped columns: &quot;)\n    print(list(drops))\n    print(&quot;-----------------------------------------------------------------------------&quot;)\n    print(&quot;used columns: &quot;)\n    print(df_model.columns.tolist())\n\n    return df_model\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 1665897,
                        "reputation": 2280,
                        "user_id": 1533306,
                        "user_type": "registered",
                        "accept_rate": 75,
                        "display_name": "Jake Drew"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 1,
                    "last_activity_date": 1608178489,
                    "creation_date": 1608178489,
                    "answer_id": 65334647,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/65334647#65334647",
                    "body": "<p>The question here refers to a HUGE dataset.  However, all of the answers I see are dealing with dataframes. I present an answer for a scipy sparse matrix which runs in parallel.  Rather than returning a giant correlation matrix, this returns a feature mask of fields to keep after checking all fields for both positive and negative Pearson correlations.</p>\n<p><strong>I also try to minimize calculations using the following strategy:</strong></p>\n<ul>\n<li>Process each column</li>\n<li>Start at the current column + 1 and calculate correlations moving to the right.</li>\n<li>For any abs(correlation) &gt;= threshold, mark the current column for removal and calculate no further correlations.</li>\n<li>Perform these steps for each column in the dataset except the last.</li>\n</ul>\n<p>This might be sped up further by keeping a global list of columns marked for removal and skipping further correlation calculations for such columns, since columns will execute out of order.  However, I do not know enough about race conditions in python to implement this tonight.</p>\n<p>Returning a column mask will obviously allow the code to handle much larger datasets than returning the entire correlation matrix.</p>\n<p><strong>Check each column using this function:</strong></p>\n<pre><code>def get_corr_row(idx_num, sp_mat, thresh):\n    # slice the column at idx_num\n    cols = sp_mat.shape[1]\n    x = sp_mat[:,idx_num].toarray().ravel()\n    start = idx_num + 1\n    \n    # Now slice each column to the right of idx_num   \n    for i in range(start, cols):\n        y = sp_mat[:,i].toarray().ravel()\n        # Check the pearson correlation\n        corr, pVal = pearsonr(x,y)\n        # Pearson ranges from -1 to 1.\n        # We check both positive and negative correlations &gt;= thresh using abs(corr)\n        if abs(corr) &gt;= thresh:\n            # stop checking after finding the 1st correlation &gt; thresh   \n            return False\n            # Mark column at idx_num for removal in the mask  \n    return True  \n    \n</code></pre>\n<p><strong>Run the column level correlation checks in parallel:</strong></p>\n<pre><code>from joblib import Parallel, delayed  \nimport multiprocessing\n\n\ndef Get_Corr_Mask(sp_mat, thresh, n_jobs=-1):\n    \n    # we must make sure the matrix is in csc format \n    # before we start doing all these column slices!  \n    sp_mat = sp_mat.tocsc()\n    cols = sp_mat.shape[1]\n    \n    if n_jobs == -1:\n        # Process the work on all available CPU cores\n        num_cores = multiprocessing.cpu_count()\n    else:\n        # Process the work on the specified number of CPU cores\n        num_cores = n_jobs\n\n    # Return a mask of all columns to keep by calling get_corr_row() \n    # once for each column in the matrix     \n    return Parallel(n_jobs=num_cores, verbose=5)(delayed(get_corr_row)(i, sp_mat, thresh)for i in range(cols))\n</code></pre>\n<p><strong>General Usage:</strong></p>\n<pre><code>#Get the mask using your sparse matrix and threshold.\ncorr_mask = Get_Corr_Mask(X_t_fpr, 0.95) \n\n# Remove features that are &gt;= 95% correlated\nX_t_fpr_corr = X_t_fpr[:,corr_mask]\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 17977072,
                        "reputation": 21,
                        "user_id": 13064356,
                        "user_type": "registered",
                        "display_name": "suhail"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1612935132,
                    "last_edit_date": 1612935132,
                    "creation_date": 1612934498,
                    "answer_id": 66131310,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/66131310#66131310",
                    "body": "<p>in my code i need to remove low correlated columns with the dependent variable, and i got this code</p>\n<pre><code>to_drop = pd.DataFrame(to_drop).fillna(True)\nto_drop = list(to_drop[to_drop['SalePrice'] &lt;.4 ].index)\ndf_h1.drop(to_drop,axis=1)\n</code></pre>\n<p>df_h1 is my dataframe and SalePrice is the dependent variable... i think changing the value may suit for all other problems</p>\n"
                },
                {
                    "owner": {
                        "account_id": 7701581,
                        "reputation": 135,
                        "user_id": 5833945,
                        "user_type": "registered",
                        "display_name": "Reza energy"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1623787153,
                    "creation_date": 1623787153,
                    "answer_id": 67992749,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/67992749#67992749",
                    "body": "<p>The below snippet drop the most correlated features recursively.</p>\n<pre><code>def get_corr_feature(df):\n    corr_matrix = df.corr().abs()\n    # Select upper triangle of correlation matrix\n    upper = corr_matrix.where(np.triu(np.ones(corr_matrix.shape), k=1).astype(np.bool_))\n    upper['score']= upper.max(axis=1)\n    upper.sort_values(by=['score'],ascending=False)\n    #Find the most correlated feature and send return it for drop\n    column_name=upper.sort_values(by=['score'],ascending=False).index[0]\n    max_score=upper.loc[column_name,'score']\n    return column_name, max_score\n\nmax_score=1\nwhile max_score&gt;0.5:\n    column_name, max_score=get_corr_feature(df)\n    df.drop(column_name,axis=1,inplace=True)\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 1920281,
                        "reputation": 1128,
                        "user_id": 1731972,
                        "user_type": "registered",
                        "accept_rate": 38,
                        "display_name": "thistleknot"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1627473917,
                    "creation_date": 1627473917,
                    "answer_id": 68560082,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/68560082#68560082",
                    "body": "<p>I wrote a notebook that uses partial correlations</p>\n<p><a href=\"https://gist.github.com/thistleknot/ce1fc38ea9fcb1a8dafcfe6e0d8af475\" rel=\"nofollow noreferrer\">https://gist.github.com/thistleknot/ce1fc38ea9fcb1a8dafcfe6e0d8af475</a></p>\n<p>the gist of it (pun intended)</p>\n<pre><code>for train_index, test_index in kfold.split(all_data):\n    #print(iteration)\n    max_pvalue = 1\n    \n    subset = all_data.iloc[train_index].loc[:, ~all_data.columns.isin([exclude])]\n    \n    #skip y and states\n    set_ = subset.loc[:, ~subset.columns.isin([target])].columns.tolist()\n    \n    n=len(subset)\n    \n    while(max_pvalue&gt;=.05):\n\n        dist = scipy.stats.beta(n/2 - 1, n/2 - 1, loc=-1, scale=2)\n        p_values = pd.DataFrame(2*dist.cdf(-abs(subset.pcorr()[target]))).T\n        p_values.columns = list(subset.columns)\n        \n        max_pname = p_values.idxmax(axis=1)[0]\n        max_pvalue = p_values[max_pname].values[0]\n        \n        if (max_pvalue &gt; .05):\n\n            set_.remove(max_pname)\n            temp = [target]\n            temp.extend(set_)\n            subset = subset[temp]\n    \n    winners = p_values.loc[:, ~p_values.columns.isin([target])].columns.tolist()\n    sig_table = (sig_table + np.where(all_data.columns.isin(winners),1,0)).copy()\n    \n    signs_table[all_data.columns.get_indexer(winners)]+=np.where(subset.pcorr()[target][winners]&lt;0,-1,1)\n\n\nsignificance = pd.DataFrame(sig_table).T\nsignificance.columns = list(all_data.columns)\ndisplay(significance)\n\nsign = pd.DataFrame(signs_table).T\nsign.columns = list(all_data.columns)\ndisplay(sign)\n\npurity = abs((sign/num_folds)*(sign/significance)).T.replace([np.inf, -np.inf, np.NaN], 0)\ndisplay(purity.T)\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 16242067,
                        "reputation": 1253,
                        "user_id": 11728128,
                        "user_type": "registered",
                        "display_name": "Antoine Krajnc"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 3,
                    "last_activity_date": 1634224354,
                    "creation_date": 1634224354,
                    "answer_id": 69573180,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/69573180#69573180",
                    "body": "<p>I know that there are already a lot of answers on that but one way I found very simple and short is the following:</p>\n<pre class=\"lang-py prettyprint-override\"><code>\n# Get correlation matrix \ncorr = X.corr()\n\n# Create a mask for values above 90% \n# But also below 100% since it variables correlated with the same one\nmask = (X.corr() &gt; 0.9) &amp; (X.corr() &lt; 1.0)\nhigh_corr = corr[mask]\n\n# Create a new column mask using any() and ~\ncol_to_filter_out = ~high_corr[mask].any()\n\n# Apply new mask\nX_clean = X[high_corr.columns[col_to_filter_out]]\n\n# Visualize cleaned dataset\nX_clean\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 463283,
                        "reputation": 16261,
                        "user_id": 866082,
                        "user_type": "registered",
                        "accept_rate": 74,
                        "display_name": "Mehran"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1640576486,
                    "creation_date": 1640576486,
                    "answer_id": 70491474,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/70491474#70491474",
                    "body": "<p>I believe this has to be done in an iterative way:</p>\n<pre class=\"lang-py prettyprint-override\"><code>uncorrelated_features = features.copy()\n\n# Loop until there's nothing to drop\nwhile True:\n    # Calculating the correlation matrix for the remaining list of features\n    cor = uncorrelated_features.corr().abs()\n\n    # Generating a square matrix with all 1s except for the main axis\n    zero_main = np.triu(np.ones(cor.shape), k=1) +\n        np.tril(np.ones(cor.shape), k=-1)\n\n    # Using the zero_main matrix to filter out the main axis of the correlation matrix\n    except_main = cor.where(zero_main.astype(bool))\n\n    # Calculating some metrics for each column, including the max correlation,\n    # mean correlation and the name of the column\n    mertics = [(except_main[column].max(), except_main[column].mean(), column) for column in except_main.columns]\n\n    # Sort the list to find the most suitable candidate to drop at index 0\n    mertics.sort(key=lambda x: (x[0], x[1]), reverse=True)\n\n    # Check and see if there's anything to drop from the list of features\n    if mertics[0][0] &gt; 0.5:\n        uncorrelated_features.drop(mertics[0][2], axis=1, inplace=True)\n    else:\n        break\n</code></pre>\n<p>It's  worth mentioning that you might want to customize the way I sorted the metrics list and/or how I detected whether I want to drop the column or not.</p>\n"
                },
                {
                    "owner": {
                        "account_id": 23709643,
                        "reputation": 11,
                        "user_id": 17731688,
                        "user_type": "registered",
                        "display_name": "JimmyBooggins"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 1,
                    "last_activity_date": 1643199346,
                    "creation_date": 1643199346,
                    "answer_id": 70863295,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/70863295#70863295",
                    "body": "<p>If you wanted to return a breakdown of correlated columns you could use this function to look at them to see what you are dropping and adjust your threshold</p>\n<pre><code>def corr_cols(df,thresh):\n    # Create correlation matrix\n    corr_matrix = df.corr().abs()\n    # Select upper triangle of correlation matrix\n    upper = corr_matrix.where(np.triu(np.ones(corr_matrix.shape), k=1).astype(np.bool_))\n\n    dic = {'Feature_1':[],'Featur_2':[],'val':[]}\n    for col in upper.columns:\n        corl = list(filter(lambda x: x &gt;= thresh, upper[col] ))\n        #print(corl)\n        if len(corl) &gt; 0:\n            inds = [round(x,4) for x in corl]\n            for ind in inds:\n                #print(col)\n                #print(ind)\n                col2 = upper[col].index[list(upper[col].apply(lambda x: round(x,4))).index(ind)]\n                #print(col2)\n                dic['Feature_1'].append(col)\n                dic['Featur_2'].append(col2)\n                dic['val'].append(ind) \n    return pd.DataFrame(dic).sort_values(by=&quot;val&quot;, ascending=False)\n</code></pre>\n<p>And then remove them by calling the df</p>\n<pre><code>    corr = corr_cols(star,0.5)\n    df.drop(columns = corr.iloc[:,0].unique())\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 19132728,
                        "reputation": 142,
                        "user_id": 13974275,
                        "user_type": "registered",
                        "display_name": "Ming Jun Lim"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1647605192,
                    "last_edit_date": 1647605192,
                    "creation_date": 1647603370,
                    "answer_id": 71526469,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/71526469#71526469",
                    "body": "<p>I manage to do it using this way. Kindly have a try. However, the way I did is just reached display purposes as I want to capture the result in my report. If you want to drop it, you can choose any columns from the dataframe below to drop it since can just choose either 1.</p>\n<pre><code>row_index = 0\ncorrDict = {}\nrow_name = []\ncol_name = []\ncorr_val = []\n\nwhile row_index &lt; len(df.corr().index.tolist()):\n    for index, x in enumerate(df.corr().iloc[row_index, :]):\n        if abs(x) &gt;= 0.8 and index != row_index:\n            if abs(x) in corr_val:\n                if (df.corr().index.tolist()[row_index] in col_name) and (df.corr().columns.tolist()[index] in row_name):\n                    continue\n            row_name.append(df.corr().index.tolist()[row_index])\n            col_name.append(df.corr().columns.tolist()[index])\n            corr_val.append(x)\n    row_index += 1\n    \ncorrDict ={&quot;First Feature (FF)&quot;: row_name, &quot;Second Feature (SF)&quot;: col_name, &quot;Correlation (FF x SF)&quot;: corr_val}\ncorr_df2=pd.DataFrame(corrDict)\ncorr_df2\n</code></pre>\n<p>This is my output:</p>\n<p><a href=\"https://i.stack.imgur.com/bzzqd.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.stack.imgur.com/bzzqd.png\" alt=\"enter image description here\" /></a></p>\n<p>You can choose either <strong>First Feature (FF)</strong> or <strong>Second Feature (SF)</strong>.\nTo drop highly correlated features from your original dataset:<br>\n<code>your_df.drop(corr_df2['First Feature (FF)'].tolist(), axis=1, inplace=True)</code></p>\n"
                },
                {
                    "owner": {
                        "account_id": 10829981,
                        "reputation": 121,
                        "user_id": 19560038,
                        "user_type": "registered",
                        "display_name": "David"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 1,
                    "last_activity_date": 1669151134,
                    "last_edit_date": 1669151134,
                    "creation_date": 1662476043,
                    "answer_id": 73624060,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/73624060#73624060",
                    "body": "<p>There are three challenges to this problem. First, if features x and y are correlated, you don't want to use an algorithm that drops both. Second, if x and y are pairwise correlated and features y and z are also pairwise correlated, you want the algorithm to only remove y. In this sense, you want it to remove the minimum number of features so that no remaining features have correlations above your threshold. Third, from an efficiency standpoint, you do not want to have to compute the correlation matrix more than once.</p>\n<p>Here's an option:</p>\n<pre><code>def corr_cleaner(df,corr_cutoff):\n    '''\n    df: pandas dataframe with column headers.\n    corr_cutoff: float between 0 and 1.\n    '''\n    abs_corr_matrix = df.corr().abs()\n    filtered_cols = []\n    while True:\n        offenders = []\n        for i in range(len(abs_corr_matrix)):\n            for j in range(len(abs_corr_matrix)):\n                if i != j:\n                    if abs_corr_matrix.iloc[i,j] &gt; corr_cutoff:\n                        offenders.append(df.columns[i])\n\n        if len(offenders) &gt; 0: # if at least one high correlation remains\n            c = Counter(offenders)\n            worst_offender = c.most_common(1)[0][0]  # var name of worst offender\n            del df[worst_offender]\n            filtered_cols.append(worst_offender)\n            abs_corr_matrix.drop(worst_offender, axis=0, inplace=True) #drop from x-axis\n            abs_corr_matrix.drop(worst_offender, axis=1, inplace=True) #drop from y-axis\n        else: # if no high correlations remain, break\n            break\n\n    return df, filtered_cols\n</code></pre>\n"
                },
                {
                    "comments": [
                        {
                            "owner": {
                                "account_id": 3392888,
                                "reputation": 3994,
                                "user_id": 2847330,
                                "user_type": "registered",
                                "display_name": "Azhar Khan"
                            },
                            "edited": false,
                            "score": 1,
                            "creation_date": 1671269562,
                            "post_id": 74773061,
                            "comment_id": 132066506,
                            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/74773061#comment132066506_74773061",
                            "body": "Please consider providing output of the source code in the answer, so users can correlate it with the problem statement."
                        }
                    ],
                    "owner": {
                        "account_id": 6232291,
                        "reputation": 41,
                        "user_id": 12215177,
                        "user_type": "registered",
                        "display_name": "Kaleb Roncatti"
                    },
                    "comment_count": 1,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1671675084,
                    "last_edit_date": 1671675084,
                    "creation_date": 1670857237,
                    "answer_id": 74773061,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/74773061#74773061",
                    "body": "<p>You could use the following function, you'll also gets the elements sorted:</p>\n<pre class=\"lang-py prettyprint-override\"><code>def correlation(dataset, threshold = 0.3):\n  c = dataset.corr().abs()\n  s = c.unstack()\n  so = s.sort_values(kind=&quot;quicksort&quot;)\n  results = []\n  for index, row in so.items():\n    if index[0] != index[1] and row &gt; threshold:\n      results.append({index: row})\n  return results\n</code></pre>\n<p>You could invoke the function sending a pandas dataset that you want to find the correlation and the threshold as follows:</p>\n<pre class=\"lang-py prettyprint-override\"><code>highly_correlated_features = correlation(dataset=data_train_val_without_label, threshold=0.35)\nhighly_correlated_features\n</code></pre>\n<p>It would result in something like this for a dataset with the following columns and the default threshold:</p>\n<p><strong>Input columns</strong>:</p>\n<pre><code> 0   HighBP                202944 non-null  float64\n 1   HighChol              202944 non-null  float64\n 2   CholCheck             202944 non-null  float64\n 3   BMI                   202944 non-null  float64\n 4   Smoker                202944 non-null  float64\n 5   Stroke                202944 non-null  float64\n 6   HeartDiseaseorAttack  202944 non-null  float64\n 7   PhysActivity          202944 non-null  float64\n 8   Fruits                202944 non-null  float64\n 9   Veggies               202944 non-null  float64\n 10  HvyAlcoholConsump     202944 non-null  float64\n 11  AnyHealthcare         202944 non-null  float64\n 12  NoDocbcCost           202944 non-null  float64\n 13  GenHlth               202944 non-null  float64\n 14  MentHlth              202944 non-null  float64\n 15  PhysHlth              202944 non-null  float64\n 16  DiffWalk              202944 non-null  float64\n 17  Sex                   202944 non-null  float64\n 18  Age                   202944 non-null  float64\n 19  Education             202944 non-null  float64\n 20  Income                202944 non-null  float64\n</code></pre>\n<p><strong>Output</strong>:</p>\n<pre class=\"lang-json prettyprint-override\"><code>[{('Income', 'Education'): 0.38083797089605675},\n {('Education', 'Income'): 0.38083797089605675},\n {('DiffWalk', 'PhysHlth'): 0.38145172573435343},\n {('PhysHlth', 'DiffWalk'): 0.38145172573435343},\n {('DiffWalk', 'GenHlth'): 0.385707943062701},\n {('GenHlth', 'DiffWalk'): 0.385707943062701},\n {('PhysHlth', 'GenHlth'): 0.3907082729122655},\n {('GenHlth', 'PhysHlth'): 0.3907082729122655}]\n</code></pre>\n"
                },
                {
                    "owner": {
                        "account_id": 18037471,
                        "reputation": 13,
                        "user_id": 13110521,
                        "user_type": "registered",
                        "display_name": "Muhammad Waseem"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1672363212,
                    "creation_date": 1672363212,
                    "answer_id": 74957390,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/74957390#74957390",
                    "body": "<p>Can use <code>statsmodels</code>'s <code>varianve_inflation_factor</code> to detect multicollinearity in the dataframe.</p>\n<pre class=\"lang-py prettyprint-override\"><code>from statsmodels.stats.outliers_influence import variance_inflation_factor\n\ndef vif(X):\n    vif = pd.DataFrame()\n    vif['Variables'] = X.columns\n    vif[&quot;VIF&quot;] = [variance_inflation_factor(X.values, i) for i in range(X.shape[1])]\n    return vif\n</code></pre>\n<p>Where X is the DataFrame. VIF for columns that involve multicollinearity will be more than 10. For columns that can be perfectly reproduced by linear combination of other available columns, then its vif value will be <strong>infinity</strong>. So remove columns now by one, until all infinity values and higher vif values are removed.</p>\n"
                },
                {
                    "owner": {
                        "account_id": 27744636,
                        "reputation": 1,
                        "user_id": 21180389,
                        "user_type": "registered",
                        "display_name": "Karim Djedidi"
                    },
                    "comment_count": 0,
                    "is_accepted": false,
                    "score": 0,
                    "last_activity_date": 1675949136,
                    "creation_date": 1675949136,
                    "answer_id": 75399257,
                    "question_id": 29294983,
                    "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on/75399257#75399257",
                    "body": "<p>You can use the Following code:</p>\n<pre><code>l=[]\ncorr_matrix = df.corr().abs()\n\nfor ci in corr_matrix.columns: \n    for cj in corr_matrix.columns: \n        if (corr_matrix[ci][cj]&gt;0.8 and ci!=cj):\n            l.append(ci)\n            \nl = np.array(l)\nto_drop = np.unique(l)\ndf.drop(to_drop, axis=1, inplace=True)\n</code></pre>\n"
                }
            ],
            "owner": {
                "account_id": 5990537,
                "reputation": 4097,
                "user_id": 4706745,
                "user_type": "registered",
                "accept_rate": 48,
                "display_name": "jax"
            },
            "comment_count": 2,
            "is_answered": true,
            "answer_count": 28,
            "score": 88,
            "last_activity_date": 1678577770,
            "creation_date": 1427439393,
            "last_edit_date": 1616406748,
            "question_id": 29294983,
            "link": "https://stackoverflow.com/questions/29294983/how-to-calculate-correlation-between-all-columns-and-remove-highly-correlated-on",
            "title": "How to calculate correlation between all columns and remove highly correlated ones using pandas?",
            "body": "<p>I have a huge data set and prior to machine learning modeling it is always suggested that first you should remove highly correlated descriptors(columns) how can i calculate the column wice correlation and remove the column with a threshold value say remove all the columns or descriptors having  >0.8 correlation.  also it should retained the headers in reduce data.. </p>\n\n<p>Example data set </p>\n\n<pre><code> GA      PN       PC     MBP      GR     AP   \n0.033   6.652   6.681   0.194   0.874   3.177    \n0.034   9.039   6.224   0.194   1.137   3.4      \n0.035   10.936  10.304  1.015   0.911   4.9      \n0.022   10.11   9.603   1.374   0.848   4.566    \n0.035   2.963   17.156  0.599   0.823   9.406    \n0.033   10.872  10.244  1.015   0.574   4.871     \n0.035   21.694  22.389  1.015   0.859   9.259     \n0.035   10.936  10.304  1.015   0.911   4.5       \n</code></pre>\n\n<p>Please help.... </p>\n"
        }
    ],
    "has_more": false,
    "quota_max": 10000,
    "quota_remaining": 5755
}